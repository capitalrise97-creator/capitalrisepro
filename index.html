<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CapitalRise Trading Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<!-- ================= LOADING ================= -->
<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-size: 16px;">Loading Platform...</p>
</div>

<!-- ================= LOADING OVERLAY ================= -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- ================= TOAST NOTIFICATION ================= -->
<div class="toast" id="toast">
    <div class="toast-content">
        <i class="fas toast-icon" id="toastIcon"></i>
        <div class="toast-message" id="toastMessage"></div>
    </div>
</div>

<!-- ================= HEADER ================= -->
<div class="header">
    <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <div class="logo">CapitalRise</div>
        </div>
    </div>
    
    <div class="header-right">
        <button class="notification-btn" onclick="toggleNotifications()" id="notificationBtn">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount">0</span>
        </button>
    </div>
</div>

<!-- ================= MOBILE OVERLAY ================= -->
<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

<!-- ================= NOTIFICATION POPUP ================= -->
<div class="notification-popup" id="notificationPopup">
    <div class="notification-header">
        <h4>Notifications</h4>
        <button class="close-modal" onclick="toggleNotifications()">&times;</button>
    </div>
    <div class="notification-list" id="notificationList">
        <!-- Notifications will be loaded here -->
    </div>
</div>

<!-- ================= SUCCESS POPUP ================= -->
<div class="success-popup" id="successPopup">
    <div class="success-icon">
        <i class="fas fa-check-circle"></i>
    </div>
    <h3>Registration Successful!</h3>
    <p>Your account has been created successfully.</p>
    <p>Please save your login credentials:</p>
    
    <div class="credentials-box">
        <div class="credential-item">
            <span class="credential-label">User ID:</span>
            <span class="credential-value" id="popupUserId">CR000001</span>
        </div>
        <div class="credential-item">
            <span class="credential-label">Email:</span>
            <span class="credential-value" id="popupUserEmail">user@example.com</span>
        </div>
        <div class="credential-item">
            <span class="credential-label">Password:</span>
            <span class="credential-value" id="popupUserPassword">********</span>
        </div>
    </div>
    
    <button class="copy-credentials-btn" onclick="copyCredentials()">
        <i class="fas fa-copy"></i> Copy Credentials
    </button>
</div>

<!-- ================= LOGIN PAGE ================= -->
<div id="loginPage" class="auth-container">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Welcome to CapitalRise</h2>
            <p>Login to access your trading dashboard</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
            </div>
            
            <button class="auth-btn" onclick="loginUser()" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="auth-footer">
                <p>
                    <span class="auth-link" onclick="showForgotPassword()">
                        Forgot Password?
                    </span>
                </p>
                <p style="margin-top: 15px;">
                    Don't have an account? 
                    <span class="auth-link" onclick="showRegister()">Register Now</span>
                </p>
                <p style="margin-top: 15px;">
                    <span class="auth-link" onclick="showAdminLogin()">
                        Admin Login
                    </span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= REGISTER PAGE ================= -->
<div id="registerPage" class="auth-container hidden">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Create Account</h2>
            <p>Join CapitalRise to start trading</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="regFullName">Full Name *</label>
                <input type="text" id="regFullName" class="form-control" placeholder="Enter your full name">
            </div>
            
            <div class="form-group">
                <label for="regEmail">Email Address *</label>
                <input type="email" id="regEmail" class="form-control" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="regMobile">Mobile Number *</label>
                <input type="tel" id="regMobile" class="form-control" placeholder="Enter your mobile number">
            </div>
            
            <div class="form-group">
                <label for="regPassword">Password *</label>
                <input type="password" id="regPassword" class="form-control" placeholder="Create a password (min. 6 characters)">
            </div>
            
            <div class="form-group">
                <label for="regConfirmPassword">Confirm Password *</label>
                <input type="password" id="regConfirmPassword" class="form-control" placeholder="Confirm your password">
            </div>
            
            <div class="form-group">
                <label for="regSponsorID">Sponsor ID (Optional)</label>
                <input type="text" id="regSponsorID" class="form-control" placeholder="Enter sponsor ID if any">
            </div>
            
            <button class="auth-btn" onclick="registerUser()" id="registerBtn">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
            
            <div class="auth-footer">
                <p>
                    Already have an account? 
                    <span class="auth-link" onclick="showLogin()">Login Here</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= ADMIN LOGIN PAGE ================= -->
<div id="adminLoginPage" class="auth-container hidden">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Admin Access</h2>
            <p>Administrator login only</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="adminEmail">Admin Email</label>
                <input type="email" id="adminEmail" class="form-control" placeholder="Enter admin email">
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
            </div>
            
            <button class="auth-btn" onclick="adminLogin()" id="adminLoginBtn">
                <i class="fas fa-lock"></i> Admin Login
            </button>
            
            <div class="auth-footer">
                <p>
                    User Login? 
                    <span class="auth-link" onclick="showLogin()">Click Here</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= USER DASHBOARD ================= -->
<div id="dashboard" class="hidden">
<div class="wrapper">
    <!-- USER SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div>
            <h3>MENU</h3>
            <ul>
                <li class="active" onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</li>
                <li onclick="showPage('activationPage')"><i class="fas fa-bolt"></i> Activation</li>
                <li onclick="showPage('activationHistoryPage')"><i class="fas fa-history"></i> Activation History</li>
            </ul>
            
            <h3>PROFILE</h3>
            <ul>
                <li onclick="showPage('profilePage')"><i class="fas fa-user"></i> Profile</li>
                <li onclick="showPage('kycPage')"><i class="fas fa-id-card"></i> KYC</li>
                <li onclick="showPage('changePasswordPage')"><i class="fas fa-key"></i> Change Password</li>
            </ul>
            
            <h3>FUND MANAGEMENT</h3>
            <ul>
                <li onclick="showPage('addFundPage')"><i class="fas fa-plus-circle"></i> Add Fund</li>
                <li onclick="showPage('fundReportPage')"><i class="fas fa-file-alt"></i> Fund Report</li>
            </ul>
            
            <h3>EARNINGS</h3>
            <ul>
                <li onclick="showPage('referralIncomePage')"><i class="fas fa-users"></i> Referral Income</li>
                <li onclick="showPage('roiIncomePage')"><i class="fas fa-percentage"></i> ROI Income</li>
                <li onclick="showPage('taskPage')"><i class="fas fa-tasks"></i> Task</li>
            </ul>
            
            <h3>WALLET</h3>
            <ul>
                <li onclick="showPage('withdrawalPage')"><i class="fas fa-wallet"></i> Withdrawal</li>
                <li onclick="showPage('withdrawalReportPage')"><i class="fas fa-file-invoice-dollar"></i> Withdrawal Report</li>
                <li class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </div>
    </div>

    <!-- USER MAIN CONTENT -->
    <div class="main">
        <!-- Dashboard Page -->
        <div class="page active" id="dashboardPage">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h3 id="userName">Loading...</h3>
                    <p>ID: <span id="userId" class="text-info">CR000001</span> • Join Date: <span id="joinDate">01/01/2024</span></p>
                    <p>Referrals: <strong id="referralCount" class="text-success">0</strong> • Rank: <strong id="userRank" class="text-warning">Beginner</strong></p>
                </div>
                <div class="user-status" id="userStatusBadge">Active</div>
            </div>

            <div class="balance-strip">
                <div class="strip purple">
                    <div>
                        <div class="strip-label">Available Balance</div>
                        <div class="strip-amount" id="userBalance">₹0</div>
                    </div>
                    <i class="fas fa-wallet strip-icon"></i>
                </div>
                <div class="strip green">
                    <div>
                        <div class="strip-label">Active Fund</div>
                        <div class="strip-amount" id="userFund">₹0</div>
                    </div>
                    <i class="fas fa-chart-line strip-icon"></i>
                </div>
            </div>

            <div class="summary">
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Total Income</h4>
                    <p id="totalIncome">₹0</p>
                    <div class="box-trend"><i class="fas fa-arrow-up"></i> <span id="todayIncome">₹0</span> Today</div>
                </div>
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Today's Income</h4>
                    <p id="todayIncomeAmount">₹0</p>
                    <div class="box-trend"><i class="fas fa-sync"></i> Updated Now</div>
                </div>
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Referral Income</h4>
                    <p id="referralIncome">₹0</p>
                    <div class="box-trend"><i class="fas fa-users"></i> <span id="activeReferrals">0</span> Active</div>
                </div>
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Total Tasks</h4>
                    <p id="totalTasks">0</p>
                    <div class="box-trend"><i class="fas fa-tasks"></i> <span id="completedTasks">0</span> Completed</div>
                </div>
            </div>

            <div class="packages-section">
                <h3 class="section-title">Investment Packages</h3>
                <div class="packages" id="packagesContainer">
                    <!-- Packages will be loaded dynamically -->
                </div>
            </div>

            <div class="affiliate">
                <h3>Affiliate Program</h3>
                <p class="mb-20">
                    <i class="fas fa-hand-point-right"></i> Your Referral Link - Earn 10% commission on every successful referral
                </p>
                <div class="referral-link">
                    <input type="text" id="refLink" value="https://capitalrise.com/register?ref=USER0001" readonly>
                    <button class="copy-btn" onclick="copyReferralLink()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="share-buttons mt-20">
                    <button class="share-btn telegram" onclick="shareOnTelegram()">
                        <i class="fab fa-telegram"></i> Telegram
                    </button>
                    <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>
            
            <div class="footer-info">
                <p><strong><i class="fas fa-info-circle"></i> Withdrawal Information:</strong> Minimum: ₹200 | Processing: Instantly | Fee: 5%</p>
                <p><strong><i class="fas fa-bullhorn"></i> Join our Official Telegram Channel:</strong> <a href="https://t.me/CapitalRise" target="_blank">@CapitalRise</a></p>
                <p><strong><i class="fas fa-headset"></i> 24/7 Support:</strong> <a href="tel:+919876543210">+91 98765 43210</a></p>
            </div>
        </div>

        <!-- Activation Page -->
        <div class="page" id="activationPage">
            <div class="page-header">
                <h2>Account Activation</h2>
                <p>Activate your trading account with a package</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:20px;">Current Account Status</h3>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="currentPackage">None</div>
                            <div class="stat-label">Active Package</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activationFund">₹0</div>
                            <div class="stat-label">Activated Fund</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activationStatus" class="status-active">Inactive</div>
                            <div class="stat-label">Account Status</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Select Package to Activate</h3>
                
                <div class="packages" id="activationPackages">
                    <!-- Activation packages will be loaded here -->
                </div>
                
                <div id="activationMessage" class="hidden" style="background: rgba(46, 213, 115, 0.1); padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid rgba(46, 213, 115, 0.3);">
                    <i class="fas fa-check-circle text-success"></i> 
                    <span id="activationMessageText"></span>
                </div>
            </div>
        </div>

        <!-- Activation History Page -->
        <div class="page" id="activationHistoryPage">
            <div class="page-header">
                <h2>Activation History</h2>
                <p>View your package activation history</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalActivations">0</div>
                        <div class="stat-label">Total Activations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalInvestment">₹0</div>
                        <div class="stat-label">Total Investment</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activePackages">0</div>
                        <div class="stat-label">Active Packages</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Validity Till</th>
                                <th>Daily Income</th>
                            </tr>
                        </thead>
                        <tbody id="activationHistoryTable">
                            <tr><td colspan="6" class="text-center">No activation history found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
            <div class="page-header">
                <h2>Profile Information</h2>
                <p>View and manage your account details</p>
            </div>
            
            <div class="page-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="profileUserId" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="text" id="profileMobile" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Join Date</label>
                        <input type="text" id="profileJoinDate" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Account Status</label>
                        <input type="text" id="profileStatus" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Active Package</label>
                        <input type="text" id="profilePackage" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>KYC Status</label>
                        <input type="text" id="profileKYC" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Referral Link</label>
                    <input type="text" id="profileRefLink" class="form-control" readonly>
                </div>
            </div>
        </div>

        <!-- KYC Page -->
        <div class="page" id="kycPage">
            <div class="page-header">
                <h2>KYC Verification</h2>
                <p>Complete KYC for full account access</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:15px;">KYC Status: <span id="kycStatusText" class="text-warning">Pending</span></h3>
                    <p>Complete KYC to enable withdrawals and access all features. KYC verification is processed instantly by admin.</p>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Personal Information</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name (as per Aadhar)</label>
                        <input type="text" id="kycName" class="form-control" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="kycDob" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Aadhar Card Number</label>
                        <input type="text" id="kycAadhar" class="form-control" placeholder="Enter 12-digit Aadhar Number" maxlength="12">
                    </div>
                    <div class="form-group">
                        <label>PAN Card Number</label>
                        <input type="text" id="kycPan" class="form-control" placeholder="Enter PAN Card Number" maxlength="10">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Bank Account Number</label>
                        <input type="text" id="kycAccountNumber" class="form-control" placeholder="Enter Bank Account Number">
                    </div>
                    <div class="form-group">
                        <label>IFSC Code</label>
                        <input type="text" id="kycIfscCode" class="form-control" placeholder="Enter IFSC Code">
                    </div>
                </div>

                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="kycBankName" class="form-control" placeholder="Enter Bank Name">
                </div>
                
                <div class="form-group">
                    <label>Account Holder Name</label>
                    <input type="text" id="kycAccountHolder" class="form-control" placeholder="Enter Account Holder Name">
                </div>
                
                <div class="form-group mt-30">
                    <button class="btn" onclick="submitKYC()" id="kycSubmitBtn">
                        <i class="fas fa-paper-plane"></i> Submit KYC
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Fund Page -->
        <div class="page" id="addFundPage">
            <div class="page-header">
                <h2>Add Fund</h2>
                <p>Add funds to your wallet</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="walletBalance">₹0</div>
                            <div class="stat-label">Current Balance</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalAdded">₹0</div>
                            <div class="stat-label">Total Added</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="lastAdded">₹0</div>
                            <div class="stat-label">Last Added</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Add Funds</h3>
                
                <div class="form-group">
                    <label>Amount to Add (₹)</label>
                    <input type="number" id="fundAmount" class="form-control" placeholder="Enter amount" min="1">
                    <p style="font-size:12px; color:rgba(255,255,255,0.5); margin-top:5px;">Enter any amount - No minimum limit</p>
                </div>
                
                <h4 style="color: var(--primary); margin:25px 0 15px;">Payment Method</h4>
                
                <div class="payment-method selected" onclick="selectPaymentMethod('qr')">
                    <div class="payment-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="payment-info">
                        <h4>QR Code Payment</h4>
                        <p>Scan QR code to pay</p>
                    </div>
                    <i class="fas fa-check-circle" style="color: var(--success); font-size:20px;"></i>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('upi')">
                    <div class="payment-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="payment-info">
                        <h4>UPI Payment</h4>
                        <p>Instant transfer using UPI</p>
                    </div>
                    <i class="fas fa-check-circle" style="color: rgba(255,255,255,0.1); font-size:20px;"></i>
                </div>
                
                <div id="qrPaymentDetails" style="background:rgba(169,112,255,0.1); padding:20px; border-radius:12px; margin:20px 0; display:block;">
                    <h4 style="color: var(--primary); margin-bottom:15px;">Scan QR Code to Pay:</h4>
                    <div class="qr-container">
                        <div class="qr-code-display" id="qrCodeDisplay">
                            <!-- QR code will be loaded here -->
                        </div>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">Scan this QR code with your UPI app to pay</p>
                    </div>
                    
                    <div class="form-group">
                        <label>UPI Transaction ID (Mandatory)</label>
                        <input type="text" id="userUpiTransactionId" class="form-control" placeholder="Enter UPI transaction reference number">
                    </div>
                </div>
                
                <div id="upiPaymentDetails" style="background:rgba(169,112,255,0.1); padding:20px; border-radius:12px; margin:20px 0; display:none;">
                    <div id="paymentInfo">
                        <h4 style="color: var(--primary); margin-bottom:15px;">Payment Instructions:</h4>
                        <p><strong>UPI ID:</strong> <span id="adminUpiIdDisplay">capitalrise@ybl</span></p>
                        <p><strong>Account Name:</strong> CapitalRise Trading</p>
                        <p><strong>Note:</strong> Please mention your User ID in payment note</p>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Your UPI Transaction ID (Mandatory)</label>
                        <input type="text" id="userUpiTransactionId2" class="form-control" placeholder="Enter the UPI transaction reference number">
                    </div>
                </div>
                
                <div style="text-align:center">
                    <button class="btn" onclick="processPayment()" id="paymentBtn">
                        <i class="fas fa-credit-card"></i> Submit Payment Request
                    </button>
                </div>
            </div>
        </div>

        <!-- Fund Report Page -->
        <div class="page" id="fundReportPage">
            <div class="page-header">
                <h2>Fund Report</h2>
                <p>View your fund transaction history</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDeposits">₹0</div>
                        <div class="stat-label">Total Deposits</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalWithdrawals">₹0</div>
                        <div class="stat-label">Total Withdrawals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="netBalance">₹0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Transaction ID</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="fundReportTable">
                            <tr><td colspan="6" class="text-center">No transactions found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Referral Income Page -->
        <div class="page" id="referralIncomePage">
            <div class="page-header">
                <h2>Referral Income</h2>
                <p>View your referral commission income</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeReferralsCount">0</div>
                        <div class="stat-label">Active Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferralIncome">₹0</div>
                        <div class="stat-label">Total Referral Income</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Referral ID</th>
                                <th>Name</th>
                                <th>Package</th>
                                <th>Commission</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="referralIncomeTable">
                            <tr><td colspan="7" class="text-center">No referral income found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ROI Income Page -->
        <div class="page" id="roiIncomePage">
            <div class="page-header">
                <h2>ROI Income</h2>
                <p>View your return on investment income</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalROI">₹0</div>
                        <div class="stat-label">Total ROI Income</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayROI">₹0</div>
                        <div class="stat-label">Today's ROI</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeInvestments">0</div>
                        <div class="stat-label">Active Investments</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Package</th>
                                <th>Investment</th>
                                <th>ROI %</th>
                                <th>Daily Income</th>
                                <th>Total Income</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="roiIncomeTable">
                            <tr><td colspan="7" class="text-center">No ROI income found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdrawal Page -->
        <div class="page" id="withdrawalPage">
            <div class="page-header">
                <h2>Withdrawal</h2>
                <p>Withdraw your earnings to bank/UPI</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:15px;">Withdrawal Information</h3>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="withdrawBalance">₹0</div>
                            <div class="stat-label">Available Balance</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withdrawPending">₹0</div>
                            <div class="stat-label">Pending Withdrawals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withdrawTotal">₹0</div>
                            <div class="stat-label">Total Withdrawn</div>
                        </div>
                    </div>
                    <p style="margin-top:15px; font-size:14px; color:rgba(255,255,255,0.7);">
                        <i class="fas fa-info-circle"></i> Minimum withdrawal: ₹200 | Processing time: Instantly | Fee: 5%
                    </p>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Request Withdrawal</h3>
                
                <div class="form-group">
                    <label>Withdrawal Amount (₹)</label>
                    <input type="number" id="withdrawAmount" class="form-control" placeholder="Enter amount" min="200">
                </div>
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="withdrawMethod" class="form-control">
                        <option value="bank">Bank Transfer</option>
                        <option value="upi">UPI</option>
                    </select>
                </div>
                
                <div id="bankDetailsSection" style="display:block;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bank Name</label>
                            <input type="text" id="bankName" class="form-control" placeholder="Enter bank name">
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" id="accountNumber" class="form-control" placeholder="Enter account number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>IFSC Code</label>
                            <input type="text" id="ifscCodeInput" class="form-control" placeholder="Enter IFSC code">
                        </div>
                        <div class="form-group">
                            <label>Account Holder Name</label>
                            <input type="text" id="accountHolder" class="form-control" placeholder="Enter account holder name">
                        </div>
                    </div>
                </div>
                
                <div id="upiDetailsSection" style="display:none;">
                    <div class="form-group">
                        <label>UPI ID</label>
                        <input type="text" id="upiIdInput" class="form-control" placeholder="Enter UPI ID">
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:30px">
                    <button class="btn" onclick="processWithdrawal()" id="withdrawBtn">
                        <i class="fas fa-money-check-alt"></i> Request Withdrawal
                    </button>
                </div>
            </div>
        </div>

        <!-- Withdrawal Report Page -->
        <div class="page" id="withdrawalReportPage">
            <div class="page-header">
                <h2>Withdrawal Report</h2>
                <p>View your withdrawal history</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="withdrawalRequests">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="withdrawalApproved">₹0</div>
                        <div class="stat-label">Approved Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="withdrawalPending">₹0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request Date</th>
                                <th>Request ID</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Processed Date</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalReportTable">
                            <tr><td colspan="6" class="text-center">No withdrawal requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

 <!-- ================= TASK PAGE ================= -->
<!-- ================= TASK PAGE ================= -->
<div class="page" id="taskPage">

    <div class="page-header">
        <h2>Daily Tasks - Click Challenge</h2>
        <p>Complete 15 clicks daily to earn 5% of your investment</p>
    </div>

    <div class="page-content">

        <!-- Task Info -->
        <div class="stats-card">
            <h3>Task Information</h3>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="taskDailyIncome">₹0</div>
                    <div class="stat-label">Daily Income</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="taskPerClick">₹0</div>
                    <div class="stat-label">Per Click</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="taskCompletedToday">0/15</div>
                    <div class="stat-label">Today's Progress</div>
                </div>
            </div>
        </div>

        <!-- Task Box -->
        <div class="task-container">

            <div class="task-stats">
                <div class="task-stat-box">
                    <h3 id="task-completed-count">0</h3>
                    <p>Completed</p>
                </div>
                <div class="task-stat-box">
                    <h3 id="task-pending-count">15</h3>
                    <p>Pending</p>
                </div>
            </div>

            <!-- CLICK BUTTON -->
            <button
                id="completeTaskBtn"
                class="task-click-button"
                onclick="completeTask()">
                Click Here
            </button>

            <!-- Progress -->
            <div class="task-progress" id="task-progress-text">
                Progress: 0/15 clicks
            </div>

            <div class="task-progress-bar">
                <div id="task-progress-fill" class="task-progress-fill"></div>
            </div>

            <!-- Success Message -->
            <div id="taskMessage" style="
                margin-top:20px;
                padding:15px;
                border-radius:10px;
                background:rgba(46,213,115,0.1);
                border:1px solid rgba(46,213,115,0.3);
                display:none;">
                <strong>✅</strong>
                <span id="taskMessageText"></span>
            </div>

        </div>
    </div>
</div>
<!-- ================= END TASK PAGE ================= -->
<!-- ================= END TASK PAGE ================= -->

        <!-- Change Password Page -->
        <div class="page" id="changePasswordPage">
            <div class="page-header">
                <h2>Change Password</h2>
                <p>Update your account password</p>
            </div>
            
            <div class="page-content">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
                </div>
                
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                    <p style="font-size:12px; color:rgba(255,255,255,0.5); margin-top:5px;">Password must be at least 6 characters</p>
                </div>
                
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                </div>
                
                <div style="text-align:center; margin-top:30px">
                    <button class="btn" onclick="changePassword()" id="changePasswordBtn">
                        <i class="fas fa-key"></i> Update Password
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
</div>

<!-- ================= ADMIN DASHBOARD ================= -->
<div id="adminDashboard" class="hidden">
<div class="wrapper">
    <!-- ADMIN SIDEBAR -->
    <div class="sidebar admin-sidebar" id="adminSidebar">
        <div>
            <h3>ADMIN MENU</h3>
            <ul>
                <li class="active" onclick="showAdminPage('adminDashboardPage')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li onclick="showAdminPage('adminUsersPage')"><i class="fas fa-users"></i> All Users</li>
                <li onclick="showAdminPage('adminDepositsPage')"><i class="fas fa-money-bill-wave"></i> Deposit Requests</li>
                <li onclick="showAdminPage('adminWithdrawalsPage')"><i class="fas fa-wallet"></i> Withdrawal Requests</li>
                <li onclick="showAdminPage('adminPackageRequestsPage')"><i class="fas fa-box"></i> Package Requests</li>
                <li onclick="showAdminPage('adminKYCVerificationPage')"><i class="fas fa-id-card"></i> KYC Verification</li>
                <li onclick="showAdminPage('adminTransactionsPage')"><i class="fas fa-exchange-alt"></i> All Transactions</li>
                <li onclick="showAdminPage('adminSettingsPage')"><i class="fas fa-cog"></i> Settings</li>
                <li class="logout" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </div>
    </div>

    <!-- ADMIN MAIN CONTENT -->
    <div class="main">
        <!-- Admin Dashboard Page -->
        <div class="page active" id="adminDashboardPage">
            <div class="page-header">
                <h2>Admin Dashboard</h2>
                <p>Welcome to CapitalRise Admin Panel</p>
            </div>

            <div class="summary">
                <div class="box">
                    <h4>Total Users</h4>
                    <p id="adminTotalUsers">0</p>
                    <div class="box-trend"><i class="fas fa-user-plus"></i> Today: <span id="adminTodayUsers">0</span></div>
                </div>
                <div class="box">
                    <h4>Active Users</h4>
                    <p id="adminActiveUsers">0</p>
                    <div class="box-trend"><i class="fas fa-chart-line"></i> Active Today: <span id="adminActiveToday">0</span></div>
                </div>
                <div class="box">
                    <h4>Total Deposits</h4>
                    <p id="adminTotalDeposits">₹0</p>
                    <div class="box-trend"><i class="fas fa-arrow-up"></i> Today: <span id="adminTodayDeposits">₹0</span></div>
                </div>
                <div class="box">
                    <h4>Total Withdrawals</h4>
                    <p id="adminTotalWithdrawals">₹0</p>
                    <div class="box-trend"><i class="fas fa-arrow-down"></i> Pending: <span id="adminPendingWithdrawals">₹0</span></div>
                </div>
            </div>

            <div class="summary">
                <div class="box">
                    <h4>Total Investments</h4>
                    <p id="adminTotalInvestments">₹0</p>
                    <div class="box-trend"><i class="fas fa-percentage"></i> Active ROI</div>
                </div>
                <div class="box">
                    <h4>Pending Requests</h4>
                    <p id="adminPendingRequests">0</p>
                    <div class="box-trend"><i class="fas fa-clock"></i> Need Approval</div>
                </div>
                <div class="box">
                    <h4>Total Commission</h4>
                    <p id="adminTotalCommission">₹0</p>
                    <div class="box-trend"><i class="fas fa-users"></i> From Referrals</div>
                </div>
                <div class="box">
                    <h4>Platform Balance</h4>
                    <p id="adminPlatformBalance">₹0</p>
                    <div class="box-trend"><i class="fas fa-coins"></i> Net Profit</div>
                </div>
            </div>

            <div class="stats-card">
                <h3 style="color: var(--primary); margin-bottom:20px;">Recent Activity</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminRecentActivity">
                            <tr><td colspan="5" class="text-center">No recent activity</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Users Page -->
        <div class="page" id="adminUsersPage">
            <div class="page-header">
                <h2>All Users</h2>
                <p>Manage all registered users</p>
            </div>
            
            <div class="page-content">
                <div class="d-flex justify-between align-center mb-20" style="flex-wrap: wrap; gap: 15px;">
                    <button class="btn" onclick="showAddUserModal()">
                        <i class="fas fa-user-plus"></i> Add New User
                    </button>
                    <div class="input-group">
                        <input type="text" id="searchUser" class="form-control" placeholder="Search by User ID or Name">
                        <button class="btn" onclick="searchUsers()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Active Packages</th>
                                <th>Status</th>
                                <th>KYC</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTable">
                            <tr><td colspan="9" class="text-center">No users found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Deposit Requests Page -->
        <div class="page" id="adminDepositsPage">
            <div class="page-header">
                <h2>Deposit Requests</h2>
                <p>Approve or reject user deposit requests instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingDepositsCount">0</div>
                        <div class="stat-label">Pending Deposits</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingDepositsAmount">₹0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayDepositsCount">0</div>
                        <div class="stat-label">Today's Deposits</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Amount</th>
                                <th>Transaction ID</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminDepositsTable">
                            <tr><td colspan="8" class="text-center">No deposit requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdrawal Requests Page -->
        <div class="page" id="adminWithdrawalsPage">
            <div class="page-header">
                <h2>Withdrawal Requests</h2>
                <p>Process user withdrawal requests instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingWithdrawalsCount">0</div>
                        <div class="stat-label">Pending Withdrawals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingWithdrawalsAmount">₹0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayWithdrawalsCount">0</div>
                        <div class="stat-label">Today's Withdrawals</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminWithdrawalsTable">
                            <tr><td colspan="8" class="text-center">No withdrawal requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Package Requests Page -->
        <div class="page" id="adminPackageRequestsPage">
            <div class="page-header">
                <h2>Package Requests</h2>
                <p>Manage package activation requests instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingPackageRequests">0</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalPackageAmount">₹0</div>
                        <div class="stat-label">Total Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayPackageRequests">0</div>
                        <div class="stat-label">Today's Requests</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminPackageRequestsTable">
                            <tr><td colspan="8" class="text-center">No package requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- KYC Verification Page -->
        <div class="page" id="adminKYCVerificationPage">
            <div class="page-header">
                <h2>KYC Verification</h2>
                <p>Verify user KYC documents instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingKYC">0</div>
                        <div class="stat-label">Pending KYC</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="verifiedKYC">0</div>
                        <div class="stat-label">Verified</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="rejectedKYC">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Aadhar</th>
                                <th>PAN</th>
                                <th>Bank Account</th>
                                <th>Submitted Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminKYCTable">
                            <tr><td colspan="8" class="text-center">No KYC requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Transactions Page -->
        <div class="page" id="adminTransactionsPage">
            <div class="page-header">
                <h2>All Transactions</h2>
                <p>View all platform transactions</p>
            </div>
            
            <div class="page-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="transactionFromDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="transactionToDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transactionType" class="form-control">
                            <option value="">All</option>
                            <option value="deposit">Deposit</option>
                            <option value="withdrawal">Withdrawal</option>
                            <option value="package">Package</option>
                            <option value="commission">Commission</option>
                            <option value="task">Task Income</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="filterTransactions()" style="margin-bottom:20px;">
                    <i class="fas fa-filter"></i> Filter
                </button>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>User ID</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminTransactionsTable">
                            <tr><td colspan="7" class="text-center">No transactions found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="adminSettingsPage">
            <div class="page-header">
                <h2>Admin Settings</h2>
                <p>Configure platform settings</p>
            </div>
            
            <div class="page-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Minimum Deposit (₹)</label>
                        <input type="number" id="minDeposit" class="form-control" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Minimum Withdrawal (₹)</label>
                        <input type="number" id="minWithdrawal" class="form-control" value="200" min="200">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Withdrawal Fee (%)</label>
                        <input type="number" id="withdrawalFee" class="form-control" value="5" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Referral Commission (%)</label>
                        <input type="number" id="referralCommission" class="form-control" value="10" min="0" max="50" step="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Daily Task Income (%)</label>
                        <input type="number" id="dailyTaskIncome" class="form-control" value="5" min="1" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Package Validity (Days)</label>
                        <input type="number" id="packageValidity" class="form-control" value="30" min="7" max="365">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>UPI ID for Payments</label>
                    <input type="text" id="adminUpiId" class="form-control" value="capitalrise@ybl">
                </div>
                
                <div class="form-group">
                    <label>QR Code Image URL</label>
                    <input type="text" id="qrCodeUrl" class="form-control" value="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl" placeholder="Enter QR code image URL">
                </div>
                
                <div class="form-group">
                    <label>Bank Details</label>
                    <textarea id="bankDetailsText" class="form-control" rows="4">State Bank of India
Account: 123456789012
IFSC: SBIN0001234
Name: CapitalRise Trading</textarea>
                </div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn" onclick="saveAdminSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
</div>

<!-- ================= MODALS ================= -->
<div class="modal" id="addUserModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
        <h3>Add New User</h3>
        
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="newUserName" class="form-control" placeholder="Enter full name">
        </div>
        
        <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="newUserEmail" class="form-control" placeholder="Enter email">
        </div>
        
        <div class="form-group">
            <label>Mobile Number</label>
            <input type="tel" id="newUserMobile" class="form-control" placeholder="Enter mobile number">
        </div>
        
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="newUserPassword" class="form-control" placeholder="Enter password">
        </div>
        
        <div class="form-group">
            <label>Initial Balance (₹)</label>
            <input type="number" id="newUserBalance" class="form-control" placeholder="Enter initial balance" value="50">
        </div>
        
        <button class="btn" onclick="createNewUser()" style="width: 100%; margin-top: 20px;">
            <i class="fas fa-user-plus"></i> Create User
        </button>
    </div>
</div>

<div class="modal" id="userDetailsModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('userDetailsModal')">&times;</button>
        <h3>User Details</h3>
        <div id="userDetailsContent">
            <!-- User details will be loaded here -->
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
    // ================= FIREBASE CONFIG =================
    const firebaseConfig = {
        apiKey: "AIzaSyA0VLVGdaMZPjMmLkwiwkWS7voiUyVE9LU",
        authDomain: "capitalrise-trading.firebaseapp.com",
        projectId: "capitalrise-trading",
        storageBucket: "capitalrise-trading.firebasestorage.app",
        messagingSenderId: "144434735671",
        appId: "1:144434735671:web:a9be99139cb0b374eeadb2"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ================= GLOBAL VARIABLES =================
    let currentUser = null;
    let userData = null;
    let adminData = null;
    let selectedPaymentMethod = 'qr';
    let successPopupActive = false;
    let realTimeListeners = [];
    let taskClicks = 0;
    const maxClicks = 15;

    // ================= HELPER FUNCTIONS =================
    function $(id) { return document.getElementById(id); }
    function show(el) { el.style.display = 'block'; }
    function hide(el) { el.style.display = 'none'; }

    function generateUserId(uid) {
        return 'CR' + uid.slice(-6).toUpperCase();
    }

    function formatDate(date) {
        if (!date) return 'N/A';
        if (date.toDate) {
            date = date.toDate();
        }
        return date.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function formatDateTime(date) {
        if (!date) return 'N/A';
        if (date.toDate) {
            date = date.toDate();
        }
        return date.toLocaleString('en-IN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatCurrency(amount) {
        return '₹' + parseFloat(amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function showToast(message, type = 'success') {
        const toast = $('toast');
        const toastIcon = $('toastIcon');
        const toastMessage = $('toastMessage');
        
        toast.className = `toast ${type}`;
        
        if (type === 'success') {
            toastIcon.className = 'fas fa-check-circle toast-icon';
        } else if (type === 'error') {
            toastIcon.className = 'fas fa-times-circle toast-icon';
        } else {
            toastIcon.className = 'fas fa-exclamation-triangle toast-icon';
        }
        
        toastMessage.textContent = message;
        show(toast);
        
        setTimeout(() => {
            hide(toast);
        }, 5000);
    }

    function showLoading() {
        show($('loadingOverlay'));
    }

    function hideLoading() {
        hide($('loadingOverlay'));
    }

    // ================= AUTH PAGES MANAGEMENT =================
    function showLogin() {
        hideAllPages();
        $('loginPage').classList.remove('hidden');
    }

    function showRegister() {
        hideAllPages();
        $('registerPage').classList.remove('hidden');
    }

    function showAdminLogin() {
        hideAllPages();
        $('adminLoginPage').classList.remove('hidden');
    }

    function showForgotPassword() {
        alert('Please contact admin for password reset.');
    }

    function hideAllPages() {
        $('loginPage').classList.add('hidden');
        $('registerPage').classList.add('hidden');
        $('adminLoginPage').classList.add('hidden');
        $('dashboard').classList.add('hidden');
        $('adminDashboard').classList.add('hidden');
    }

    // ================= USER REGISTRATION WITH POPUP =================
    async function registerUser() {
        const name = $('regFullName').value.trim();
        const email = $('regEmail').value.trim();
        const mobile = $('regMobile').value.trim();
        const password = $('regPassword').value;
        const confirmPassword = $('regConfirmPassword').value;
        const sponsorId = $('regSponsorID').value.trim() || 'ADMIN';

        // Validation
        if (!name || !email || !mobile || !password) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        if (password.length < 6) {
            showToast('Password must be at least 6 characters long', 'error');
            return;
        }

        if (password !== confirmPassword) {
            showToast('Passwords do not match', 'error');
            return;
        }

        try {
            showLoading();
            $('registerBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
            $('registerBtn').disabled = true;

            // Create user in Firebase Auth
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Generate user ID
            const userId = generateUserId(user.uid);
            
            // Create user document
            const userDoc = {
                uid: user.uid,
                userId: userId,
                name: name,
                email: email,
                mobile: mobile,
                sponsorId: sponsorId,
                balance: 0,
                totalEarnings: 0,
                referralEarnings: 0,
                totalDeposits: 0,
                totalWithdrawals: 0,
                status: 'active',
                kycStatus: 'pending',
                kycSubmitted: false,
                referralCount: 0,
                role: 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('users').doc(user.uid).set(userDoc);

            // Update sponsor's referral count
            if (sponsorId !== 'ADMIN') {
                const sponsorQuery = await db.collection('users').where('userId', '==', sponsorId).get();
                if (!sponsorQuery.empty) {
                    const sponsorDoc = sponsorQuery.docs[0];
                    await db.collection('users').doc(sponsorDoc.id).update({
                        referralCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
            }

            // Show success popup with credentials
            showSuccessPopup(userId, email, password);
            
            // Create notification for admin
            await db.collection('notifications').add({
                type: 'new_user',
                title: 'New User Registered',
                message: `New user ${name} (${userId}) has registered with sponsor ID: ${sponsorId}.`,
                userId: 'ADMIN',
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Clear form
            $('regFullName').value = '';
            $('regEmail').value = '';
            $('regMobile').value = '';
            $('regPassword').value = '';
            $('regConfirmPassword').value = '';
            $('regSponsorID').value = '';

        } catch (error) {
            showToast('Registration failed: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('registerBtn').innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            $('registerBtn').disabled = false;
        }
    }

    function showSuccessPopup(userId, email, password) {
        successPopupActive = true;
        $('popupUserId').textContent = userId;
        $('popupUserEmail').textContent = email;
        $('popupUserPassword').textContent = password;
        show($('successPopup'));
    }

    function copyCredentials() {
        const userId = $('popupUserId').textContent;
        const email = $('popupUserEmail').textContent;
        const password = $('popupUserPassword').textContent;
        
        const text = `User ID: ${userId}\nEmail: ${email}\nPassword: ${password}`;
        
        navigator.clipboard.writeText(text).then(() => {
            showToast('Credentials copied to clipboard!');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('Credentials copied to clipboard!');
        });
    }

    // Close success popup only when user clicks outside
    document.addEventListener('click', function(event) {
        const successPopup = $('successPopup');
        if (successPopupActive && successPopup.style.display === 'block') {
            if (!successPopup.contains(event.target)) {
                // Don't auto-close - keep it open
            }
        }
    });

    // ================= USER LOGIN =================
    async function loginUser() {
        const email = $('loginEmail').value.trim();
        const password = $('loginPassword').value;

        if (!email || !password) {
            showToast('Please enter email and password', 'error');
            return;
        }

        try {
            showLoading();
            $('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            $('loginBtn').disabled = true;

            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            showToast('Login failed: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            $('loginBtn').disabled = false;
        }
    }

    // ================= ADMIN LOGIN =================
    async function adminLogin() {
        const email = $('adminEmail').value.trim();
        const password = $('adminPassword').value;

        if (!email || !password) {
            showToast('Please enter admin credentials', 'error');
            return;
        }

        try {
            showLoading();
            $('adminLoginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            $('adminLoginBtn').disabled = true;

            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            showToast('Admin login failed: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('adminLoginBtn').innerHTML = '<i class="fas fa-lock"></i> Admin Login';
            $('adminLoginBtn').disabled = false;
        }
    }

    // ================= AUTH STATE LISTENER =================
    auth.onAuthStateChanged(async (user) => {
        $('loading').style.display = 'none';

        if (user) {
            try {
                // Check if user exists in database
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Update last login
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    if (userData.role === 'admin') {
                        adminData = userData;
                        currentUser = user;
                        showAdminDashboard();
                        loadAdminDashboard();
                        startCompleteRealTimeListeners();
                        loadAdminNotifications();
                    } else {
                        userData.local = userData;
                        currentUser = user;
                        showUserDashboard();
                        loadUserData();
                        startCompleteRealTimeListeners();
                        loadNotifications();
                    }
                } else {
                    // User document doesn't exist, sign out
                    await auth.signOut();
                    showLogin();
                    showToast('User account not found. Please register.', 'error');
                }
            } catch (error) {
                console.error('Auth state change error:', error);
                await auth.signOut();
                showLogin();
                showToast('Authentication error. Please login again.', 'error');
            }
        } else {
            showLogin();
        }
    });

    // ================= USER DASHBOARD =================
    function showUserDashboard() {
        hideAllPages();
        $('dashboard').classList.remove('hidden');
        toggleSidebar(); // Close sidebar on mobile
    }

    async function loadUserData() {
        if (!currentUser) return;

        try {
            showLoading();
            
            // Get user data
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            userData = userDoc.data();

            if (!userData) {
                showToast('Failed to load user data', 'error');
                return;
            }

            // Update UI
            updateUserUI();
            
            // Load packages
            loadPackages();
            
            // Load notifications
            loadNotifications();
            
            // Load activation history
            loadActivationHistory();
            
            // Load fund report
            loadFundReport();
            
            // Load referral income
            loadReferralIncome();
            
            // Load ROI income
            loadROIIncome();
            
            // Load withdrawal report
            loadWithdrawalReport();
            
            // Load task data
            loadTaskData();
            
            // Load QR code for payments
            loadQRCodeForUser();
            
        } catch (error) {
            showToast('Error loading user data: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function updateUserUI() {
        if (!userData) return;

        // User info
        $('userName').textContent = userData.name;
        $('userId').textContent = userData.userId;
        $('userAvatar').textContent = userData.name.charAt(0).toUpperCase();
        $('userBalance').textContent = formatCurrency(userData.balance);
        $('joinDate').textContent = formatDate(userData.createdAt);
        
        // Calculate active fund from active packages
        calculateActiveFund();
        
        $('referralCount').textContent = userData.referralCount || 0;
        $('userRank').textContent = getRankFromInvestment(userData.totalInvestment || 0);
        
        // Status badge
        const statusBadge = $('userStatusBadge');
        statusBadge.textContent = userData.status === 'active' ? 'Active' : 'Inactive';
        if (userData.status === 'active') {
            statusBadge.style.background = 'rgba(46, 213, 115, 0.2)';
            statusBadge.style.color = '#2ed573';
        } else if (userData.status === 'blocked') {
            statusBadge.style.background = 'rgba(255, 71, 87, 0.2)';
            statusBadge.style.color = '#ff4757';
        } else {
            statusBadge.style.background = 'rgba(255, 165, 2, 0.2)';
            statusBadge.style.color = '#ffa502';
        }

        // Dashboard stats
        $('totalIncome').textContent = formatCurrency(userData.totalEarnings || 0);
        $('todayIncomeAmount').textContent = formatCurrency(calculateTodayIncome());
        $('referralIncome').textContent = formatCurrency(userData.referralEarnings || 0);
        $('activeReferrals').textContent = userData.referralCount || 0;
        
        // Calculate total tasks completed
        calculateTotalTasks();

        // Profile page
        $('profileName').value = userData.name;
        $('profileUserId').value = userData.userId;
        $('profileEmail').value = userData.email;
        $('profileMobile').value = userData.mobile;
        $('profileJoinDate').value = formatDate(userData.createdAt);
        $('profileStatus').value = userData.status.charAt(0).toUpperCase() + userData.status.slice(1);
        $('profileKYC').value = userData.kycStatus || 'pending';
        $('profileRefLink').value = `${window.location.origin}?ref=${userData.userId}`;

        // Activation page
        $('currentPackage').textContent = getActivePackagesCount() > 0 ? `${getActivePackagesCount()} Active` : 'None';
        $('activationStatus').textContent = getActivePackagesCount() > 0 ? 'Active' : 'Inactive';
        $('activationStatus').className = getActivePackagesCount() > 0 ? 'status-active' : 'status-pending';

        // Add fund page
        $('walletBalance').textContent = formatCurrency(userData.balance);
        $('totalAdded').textContent = formatCurrency(userData.totalDeposits || 0);
        
        // Referral link
        $('refLink').value = `${window.location.origin}?ref=${userData.userId}`;
    }

    async function calculateActiveFund() {
        if (!currentUser) return;
        
        try {
            const snapshot = await db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get();
            
            let total = 0;
            snapshot.forEach(doc => {
                const pkg = doc.data();
                total += pkg.amount || 0;
            });
            
            $('userFund').textContent = formatCurrency(total);
            $('activationFund').textContent = formatCurrency(total);
        } catch (error) {
            console.error('Error calculating active fund:', error);
        }
    }

    function getRankFromInvestment(amount) {
        if (amount >= 1000000) return 'King';
        if (amount >= 500000) return 'Crown';
        if (amount >= 100000) return 'Diamond';
        if (amount >= 50000) return 'Platinum';
        if (amount >= 10000) return 'Gold';
        if (amount >= 5000) return 'Silver';
        if (amount >= 1000) return 'Bronze';
        return 'Beginner';
    }

    function calculateTodayIncome() {
        // Calculate today's income from active packages
        return 0; // Will be implemented with real data
    }

    async function calculateTotalTasks() {
        if (!currentUser) return;
        
        try {
            const today = new Date().toISOString().split('T')[0];
            const tasksSnapshot = await db.collection('tasks')
                .where('userId', '==', currentUser.uid)
                .get();
            
            let totalTasks = 0;
            let completedTasks = 0;
            
            tasksSnapshot.forEach(doc => {
                const task = doc.data();
                totalTasks += 15; // Each day has 15 tasks
                completedTasks += task.clicks || 0;
            });
            
            $('totalTasks').textContent = totalTasks;
            $('completedTasks').textContent = completedTasks;
        } catch (error) {
            console.error('Error calculating total tasks:', error);
        }
    }

    // ================= PACKAGES MANAGEMENT =================
    const packages = [
        { id: 1, name: 'BRONZE', price: 1000, color: '#cd7f32', dailyROI: 1.5, validity: 30 },
        { id: 2, name: 'SILVER', price: 5000, color: '#c0c0c0', dailyROI: 1.8, validity: 30 },
        { id: 3, name: 'GOLDEN', price: 10000, color: '#ffd700', dailyROI: 2.0, validity: 30 },
        { id: 4, name: 'PLATINUM', price: 3000, color: '#e5e4e2', dailyROI: 1.6, validity: 30 },
        { id: 5, name: 'DIAMOND', price: 20000, color: '#b9f2ff', dailyROI: 2.2, validity: 30 },
        { id: 6, name: 'CROWN', price: 50000, color: '#8a2be2', dailyROI: 2.5, validity: 30 },
        { id: 7, name: 'LEGEND', price: 70000, color: '#ff6b35', dailyROI: 2.8, validity: 30 },
        { id: 8, name: 'CONQUERER', price: 100000, color: '#4a4e69', dailyROI: 3.0, validity: 30 },
        { id: 9, name: 'CRYSTAL', price: 500000, color: '#00ffff', dailyROI: 3.5, validity: 30 }
    ];

    async function loadPackages() {
        const packagesContainer = $('packagesContainer');
        const activationPackages = $('activationPackages');
        
        if (!packagesContainer || !activationPackages) return;
        
        try {
            // Get user's active packages
            const activePackagesSnapshot = await db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get();
            
            const activePackageNames = [];
            activePackagesSnapshot.forEach(doc => {
                const pkg = doc.data();
                activePackageNames.push(pkg.name);
            });
            
            packagesContainer.innerHTML = '';
            activationPackages.innerHTML = '';
            
            packages.forEach(pkg => {
                const isActive = activePackageNames.includes(pkg.name);
                
                const packageHTML = `
                    <div class="pkg">
                        ${pkg.name === 'SILVER' ? '<span class="badge">Most Popular</span>' : ''}
                        <h3 style="color: ${pkg.color}">${pkg.name}</h3>
                        <div class="pkg-price">${formatCurrency(pkg.price)}</div>
                        <ul class="pkg-features">
                            <li><i class="fas fa-check-circle"></i> Daily ROI: ${pkg.dailyROI}%</li>
                            <li><i class="fas fa-check-circle"></i> Referral Bonus: 10%</li>
                            <li><i class="fas fa-check-circle"></i> Daily Tasks Available</li>
                            <li><i class="fas fa-check-circle"></i> Validity: ${pkg.validity} Days</li>
                            <li><i class="fas fa-check-circle"></i> Total Returns: ${(pkg.dailyROI * pkg.validity).toFixed(1)}%</li>
                        </ul>
                        <button class="pkg-btn ${isActive ? 'disabled' : ''}" 
                                onclick="${!isActive ? `activatePackage('${pkg.id}', '${pkg.name}', ${pkg.price}, ${pkg.dailyROI}, ${pkg.validity})` : ''}"
                                ${isActive ? 'disabled' : ''}>
                            <i class="fas fa-bolt"></i> 
                            ${isActive ? 'Active' : 'Activate Now'}
                        </button>
                    </div>
                `;
                
                packagesContainer.innerHTML += packageHTML;
                activationPackages.innerHTML += packageHTML;
            });
        } catch (error) {
            console.error('Error loading packages:', error);
        }
    }

    async function getActivePackagesCount() {
        if (!currentUser) return 0;
        
        try {
            const snapshot = await db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get();
            
            return snapshot.size;
        } catch (error) {
            console.error('Error getting active packages count:', error);
            return 0;
        }
    }

    async function activatePackage(packageId, packageName, amount, dailyROI, validity) {
        if (!currentUser || !userData) return;
        
        const confirmActivation = confirm(`Activate ${packageName} package for ${formatCurrency(amount)}?\nDaily ROI: ${dailyROI}%\nValidity: ${validity} days\nTotal Investment: ${formatCurrency(amount)}`);
        if (!confirmActivation) return;
        
        try {
            showLoading();
            
            // Create package activation request - GOES TO ADMIN IMMEDIATELY
            const packageRef = await db.collection('package_requests').add({
                userId: currentUser.uid,
                userName: userData.name,
                userEmail: userData.email,
                userMobile: userData.mobile,
                userCode: userData.userId,
                packageId: packageId,
                packageName: packageName,
                amount: amount,
                dailyROI: dailyROI,
                validity: validity,
                expiryDate: new Date(Date.now() + validity * 24 * 60 * 60 * 1000),
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // NO BALANCE DEDUCTION - Admin will approve first
            
            // Create notification for admin IMMEDIATELY
            await db.collection('notifications').add({
                type: 'package_request',
                title: '📦 New Package Request',
                message: `${userData.name} (${userData.userId}) requested ${packageName} package of ${formatCurrency(amount)}`,
                userId: 'ADMIN',
                userCode: userData.userId,
                requestId: packageRef.id,
                requestType: 'package',
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast(`✅ ${packageName} package request submitted! Admin will approve it immediately.`);
            
            // Reload user data
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            userData = userDoc.data();
            updateUserUI();
            loadPackages();
            loadActivationHistory();
            
            // Show success message
            $('activationMessage').classList.remove('hidden');
            $('activationMessageText').textContent = `${packageName} package request submitted! Waiting for admin approval.`;
            
        } catch (error) {
            showToast('Error activating package: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // ================= PAGE NAVIGATION =================
    function showPage(pageId) {
        // Hide all pages
        document.querySelectorAll('#dashboard .page').forEach(page => {
            page.classList.remove('active');
        });
        
        // Show selected page
        $(pageId).classList.add('active');
        
        // Update sidebar active state
        document.querySelectorAll('#dashboard .sidebar li').forEach(item => {
            item.classList.remove('active');
        });
        
        // Find and activate corresponding sidebar item
        const sidebarItems = document.querySelectorAll('#dashboard .sidebar li');
        for (let item of sidebarItems) {
            if (item.textContent.includes(getPageName(pageId))) {
                item.classList.add('active');
                break;
            }
        }
        
        // Close sidebar on mobile
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
    }

    function getPageName(pageId) {
        const pageNames = {
            'dashboardPage': 'Dashboard',
            'activationPage': 'Activation',
            'activationHistoryPage': 'Activation History',
            'profilePage': 'Profile',
            'kycPage': 'KYC',
            'changePasswordPage': 'Change Password',
            'addFundPage': 'Add Fund',
            'fundReportPage': 'Fund Report',
            'referralIncomePage': 'Referral Income',
            'roiIncomePage': 'ROI Income',
            'withdrawalPage': 'Withdrawal',
            'withdrawalReportPage': 'Withdrawal Report',
            'taskPage': 'Task'
        };
        return pageNames[pageId] || '';
    }

    // ================= LOAD DATA FUNCTIONS =================
    async function loadActivationHistory() {
        if (!currentUser) return;
        
        try {
            const packagesSnapshot = await db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .orderBy('activatedAt', 'desc')
                .get();
            
            const table = $('activationHistoryTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let totalActivations = 0;
            let totalInvestment = 0;
            let activePackages = 0;
            
            if (packagesSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="6" class="text-center">No activation history found</td></tr>';
            } else {
                packagesSnapshot.forEach(doc => {
                    const pkg = doc.data();
                    totalActivations++;
                    totalInvestment += pkg.amount;
                    if (pkg.status === 'active') activePackages++;
                    
                    const statusClass = pkg.status === 'active' ? 'status-active' : 
                                    pkg.status === 'expired' ? 'status-expired' : 'status-pending';
                    
                    const row = `
                        <tr>
                            <td>${formatDateTime(pkg.activatedAt)}</td>
                            <td>${pkg.name}</td>
                            <td>${formatCurrency(pkg.amount)}</td>
                            <td><span class="${statusClass}">${pkg.status}</span></td>
                            <td>${formatDate(pkg.expiryDate)}</td>
                            <td>${formatCurrency(pkg.amount * (pkg.dailyROI || 1.5) / 100)}</td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('totalActivations').textContent = totalActivations;
            $('totalInvestment').textContent = formatCurrency(totalInvestment);
            $('activePackages').textContent = activePackages;
            $('activationFund').textContent = formatCurrency(totalInvestment);
        } catch (error) {
            console.error('Error loading activation history:', error);
        }
    }

    async function loadFundReport() {
        if (!currentUser) return;
        
        try {
            const transactionsSnapshot = await db.collection('transactions')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            
            const table = $('fundReportTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let totalDeposits = 0;
            let totalWithdrawals = 0;
            let currentBalance = userData ? userData.balance : 0;
            
            if (transactionsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="6" class="text-center">No transactions found</td></tr>';
            } else {
                let runningBalance = currentBalance;
                
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    
                    if (transaction.type === 'deposit' && transaction.status === 'approved') {
                        totalDeposits += transaction.amount;
                    } else if (transaction.type === 'withdrawal' && transaction.status === 'approved') {
                        totalWithdrawals += transaction.amount;
                    }
                    
                    // Calculate running balance
                    if (transaction.type === 'deposit' && transaction.status === 'approved') {
                        runningBalance += transaction.amount;
                    } else if (transaction.type === 'withdrawal' && transaction.status === 'approved') {
                        runningBalance -= transaction.amount;
                    } else if (transaction.type === 'package_activation' && transaction.status === 'approved') {
                        runningBalance -= transaction.amount;
                    } else if (transaction.type === 'task_income' || transaction.type === 'roi_income' || transaction.type === 'referral_income') {
                        runningBalance += transaction.amount;
                    }
                    
                    const statusClass = transaction.status === 'approved' ? 'status-active' :
                                    transaction.status === 'pending' ? 'status-pending' : 'status-rejected';
                    
                    const row = `
                        <tr>
                            <td>${formatDateTime(transaction.timestamp)}</td>
                            <td>${doc.id.slice(-8).toUpperCase()}</td>
                            <td>${transaction.type.replace('_', ' ').toUpperCase()}</td>
                            <td>${formatCurrency(transaction.amount)}</td>
                            <td><span class="${statusClass}">${transaction.status}</span></td>
                            <td>${formatCurrency(runningBalance)}</td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('totalDeposits').textContent = formatCurrency(totalDeposits);
            $('totalWithdrawals').textContent = formatCurrency(totalWithdrawals);
            $('netBalance').textContent = formatCurrency(totalDeposits - totalWithdrawals);
        } catch (error) {
            console.error('Error loading fund report:', error);
        }
    }

    async function loadReferralIncome() {
        if (!currentUser) return;
        
        try {
            // Get referrals
            const referralsSnapshot = await db.collection('users')
                .where('sponsorId', '==', userData.userId)
                .get();
            
            const table = $('referralIncomeTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let totalReferrals = 0;
            let activeReferrals = 0;
            let totalReferralIncome = userData.referralEarnings || 0;
            
            if (referralsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="7" class="text-center">No referrals found</td></tr>';
            } else {
                for (const doc of referralsSnapshot.docs) {
                    const referral = doc.data();
                    totalReferrals++;
                    
                    // Check if referral has active packages
                    const activePackages = await db.collection('packages')
                        .where('userId', '==', doc.id)
                        .where('status', '==', 'active')
                        .get();
                    
                    if (!activePackages.empty) activeReferrals++;
                    
                    const commission = calculateReferralCommission(doc.id);
                    
                    const row = `
                        <tr>
                            <td>${formatDate(referral.createdAt)}</td>
                            <td>${referral.userId}</td>
                            <td>${referral.name}</td>
                            <td>${activePackages.empty ? 'None' : activePackages.docs[0].data().name}</td>
                            <td>10%</td>
                            <td>${formatCurrency(commission)}</td>
                            <td><span class="status-${referral.status}">${referral.status}</span></td>
                        </tr>
                    `;
                    table.innerHTML += row;
                }
            }
            
            // Update stats
            $('totalReferrals').textContent = totalReferrals;
            $('activeReferralsCount').textContent = activeReferrals;
            $('totalReferralIncome').textContent = formatCurrency(totalReferralIncome);
        } catch (error) {
            console.error('Error loading referral income:', error);
        }
    }

    async function calculateReferralCommission(userId) {
        try {
            const snapshot = await db.collection('packages')
                .where('userId', '==', userId)
                .where('status', '==', 'active')
                .get();
            
            let totalCommission = 0;
            snapshot.forEach(doc => {
                const pkg = doc.data();
                totalCommission += pkg.amount * 0.1; // 10% commission
            });
            
            return totalCommission;
        } catch (error) {
            console.error('Error calculating referral commission:', error);
            return 0;
        }
    }

    async function loadROIIncome() {
        if (!currentUser) return;
        
        try {
            const packagesSnapshot = await db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get();
            
            const table = $('roiIncomeTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let totalROI = 0;
            let todayROI = 0;
            let activeInvestments = packagesSnapshot.size;
            
            if (packagesSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="7" class="text-center">No active investments found</td></tr>';
            } else {
                packagesSnapshot.forEach(doc => {
                    const pkg = doc.data();
                    
                    // Calculate ROI income
                    const daysActive = Math.floor((new Date() - pkg.activatedAt.toDate()) / (1000 * 60 * 60 * 24));
                    const dailyIncome = pkg.amount * pkg.dailyROI / 100;
                    const totalIncome = dailyIncome * daysActive;
                    
                    totalROI += totalIncome;
                    todayROI += dailyIncome;
                    
                    const row = `
                        <tr>
                            <td>${formatDate(pkg.activatedAt)}</td>
                            <td>${pkg.name}</td>
                            <td>${formatCurrency(pkg.amount)}</td>
                            <td>${pkg.dailyROI}%</td>
                            <td>${formatCurrency(dailyIncome)}</td>
                            <td>${formatCurrency(totalIncome)}</td>
                            <td><span class="status-active">Active</span></td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('totalROI').textContent = formatCurrency(totalROI);
            $('todayROI').textContent = formatCurrency(todayROI);
            $('activeInvestments').textContent = activeInvestments;
        } catch (error) {
            console.error('Error loading ROI income:', error);
        }
    }

    async function loadWithdrawalReport() {
        if (!currentUser) return;
        
        try {
            const withdrawalsSnapshot = await db.collection('withdrawals')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();
            
            const table = $('withdrawalReportTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let totalRequests = 0;
            let approvedAmount = 0;
            let pendingAmount = 0;
            
            if (withdrawalsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="6" class="text-center">No withdrawal requests found</td></tr>';
            } else {
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    totalRequests++;
                    
                    if (withdrawal.status === 'approved') {
                        approvedAmount += withdrawal.amount;
                    } else if (withdrawal.status === 'pending') {
                        pendingAmount += withdrawal.amount;
                    }
                    
                    const statusClass = withdrawal.status === 'approved' ? 'status-active' :
                                    withdrawal.status === 'pending' ? 'status-pending' : 'status-rejected';
                    
                    const row = `
                        <tr>
                            <td>${formatDateTime(withdrawal.createdAt)}</td>
                            <td>${doc.id.slice(-8).toUpperCase()}</td>
                            <td>${formatCurrency(withdrawal.amount)}</td>
                            <td>${withdrawal.method || 'Bank Transfer'}</td>
                            <td><span class="${statusClass}">${withdrawal.status}</span></td>
                            <td>${withdrawal.processedAt ? formatDateTime(withdrawal.processedAt) : 'Pending'}</td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('withdrawalRequests').textContent = totalRequests;
            $('withdrawalApproved').textContent = formatCurrency(approvedAmount);
            $('withdrawalPending').textContent = formatCurrency(pendingAmount);
            
            // Update withdrawal page stats
            $('withdrawBalance').textContent = formatCurrency(userData.balance);
            $('withdrawPending').textContent = formatCurrency(pendingAmount);
            $('withdrawTotal').textContent = formatCurrency(approvedAmount);
        } catch (error) {
            console.error('Error loading withdrawal report:', error);
        }
    }

    // ================= TASK SYSTEM =================

// ================= LOAD TASK =================
// ================= GLOBAL =================

// ================= LOAD TASK =================
async function loadTaskData() {
    if (!currentUser || !userData) return;

    try {
        const today = new Date().toISOString().split('T')[0];
        const taskRef = db.collection('tasks').doc(`${currentUser.uid}_${today}`);
        const snap = await taskRef.get();

        if (snap.exists) {
            taskClicks = snap.data().clicks || 0;
        } else {
            taskClicks = 0;
            await taskRef.set({
                userId: currentUser.uid,
                userName: userData.name || '',
                date: today,
                clicks: 0,
                incomeAdded: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        updateTaskUI();
    } catch (err) {
        console.error('Load task error:', err);
    }
}

// ================= UPDATE UI =================
function updateTaskUI() {
    const progress = (taskClicks / maxClicks) * 100;

    $('task-completed-count').textContent = taskClicks;
    $('task-pending-count').textContent = maxClicks - taskClicks;
    $('task-progress-text').textContent =
        `Progress: ${taskClicks}/${maxClicks} clicks`;
    $('task-progress-fill').style.width = `${progress}%`;

    $('taskCompletedToday').textContent =
        `${taskClicks}/${maxClicks}`;

    calculateTaskEarnings();
}

// ================= CALCULATE (UI ONLY) =================
async function calculateTaskEarnings() {
    if (!currentUser) return;

    try {
        const pkgSnap = await db.collection('packages')
            .where('userId', '==', currentUser.uid)
            .where('status', '==', 'active')
            .get();

        let totalInvestment = 0;
        pkgSnap.forEach(d => {
            totalInvestment += Number(d.data().amount || 0);
        });

        if (totalInvestment <= 0) {
            $('taskDailyIncome').textContent = '₹0';
            $('taskPerClick').textContent = '₹0';
            return;
        }

        const dailyIncome = totalInvestment * 0.05;
        const perClick = dailyIncome / maxClicks;

        $('taskDailyIncome').textContent = formatCurrency(dailyIncome);
        $('taskPerClick').textContent = formatCurrency(perClick);

    } catch (err) {
        console.error('Earnings calc error:', err);
    }
}

// ================= COMPLETE TASK =================
async function completeTask() {
    if (!currentUser || !userData) return;

    if (taskClicks >= maxClicks) {
        showToast('Daily task already completed', 'warning');
        return;
    }

    try {
        // 🔍 Active package check
        const pkgSnap = await db.collection('packages')
            .where('userId', '==', currentUser.uid)
            .where('status', '==', 'active')
            .get();

        if (pkgSnap.empty) {
            showToast('Activate a package first', 'error');
            showPage('activationPage');
            return;
        }

        // 💰 Total investment
        let totalInvestment = 0;
        pkgSnap.forEach(d => {
            totalInvestment += Number(d.data().amount || 0);
        });

        const dailyIncome = totalInvestment * 0.05;

        taskClicks++;

        const today = new Date().toISOString().split('T')[0];
        const taskRef = db.collection('tasks').doc(`${currentUser.uid}_${today}`);

        // ➕ update clicks
        await taskRef.update({
            clicks: taskClicks,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 🔥 ADD INCOME ONLY ONCE (15/15)
        if (taskClicks === maxClicks) {
            await db.runTransaction(async (t) => {
                const taskSnap = await t.get(taskRef);

                // 🚫 already added
                if (taskSnap.data().incomeAdded) return;

                const userRef = db.collection('users').doc(currentUser.uid);

                // ✅ AUTO ADD 5%
                t.update(userRef, {
                    balance: firebase.firestore.FieldValue.increment(dailyIncome),
                    totalEarnings: firebase.firestore.FieldValue.increment(dailyIncome)
                });

                // 🔒 lock
                t.update(taskRef, { incomeAdded: true });

                // 🧾 transaction history
                t.set(db.collection('transactions').doc(), {
                    userId: currentUser.uid,
                    type: 'task_income',
                    amount: dailyIncome,
                    description: 'Daily Task Completion (5%)',
                    status: 'approved',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            $('taskMessage').style.display = 'block';
            $('taskMessageText').textContent =
                `🎉 Task completed! ${formatCurrency(dailyIncome)} added`;
        }

        updateTaskUI();

    } catch (err) {
        console.error('Complete task error:', err);
        taskClicks--;
        showToast(err.message, 'error');
    }
}
    // ================= PAYMENT SYSTEM =================
    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        
        // Update UI
        document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('selected');
            el.querySelector('.fa-check-circle').style.color = 'rgba(255,255,255,0.1)';
        });
        
        event.currentTarget.classList.add('selected');
        event.currentTarget.querySelector('.fa-check-circle').style.color = 'var(--success)';
        
        // Show selected payment details
        if (method === 'qr') {
            $('qrPaymentDetails').style.display = 'block';
            $('upiPaymentDetails').style.display = 'none';
            loadQRCodeForUser();
        } else {
            $('qrPaymentDetails').style.display = 'none';
            $('upiPaymentDetails').style.display = 'block';
        }
    }

    async function loadQRCodeForUser() {
        try {
            const settingsDoc = await db.collection('settings').doc('platform').get();
            let qrCodeUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl';
            
            if (settingsDoc.exists) {
                const settings = settingsDoc.data();
                qrCodeUrl = settings.qrCodeUrl || qrCodeUrl;
                $('adminUpiIdDisplay').textContent = settings.adminUpiId || 'capitalrise@ybl';
            }
            
            const qrDisplay = $('qrCodeDisplay');
            qrDisplay.innerHTML = `
                <img src="${qrCodeUrl}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">
            `;
        } catch (error) {
            console.error('Error loading QR code:', error);
            const qrDisplay = $('qrCodeDisplay');
            qrDisplay.innerHTML = `
                <div style="text-align: center; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="width: 180px; height: 180px; background: #f0f0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                        <div style="font-size: 60px; color: #333;">QR</div>
                    </div>
                    <div style="color: #333; font-size: 12px; margin-top: 10px;">Scan to pay</div>
                </div>
            `;
        }
    }

    async function processPayment() {
        if (!currentUser || !userData) return;
        
        const amount = parseFloat($('fundAmount').value);
        let transactionId = '';
        
        if (selectedPaymentMethod === 'qr') {
            transactionId = $('userUpiTransactionId').value.trim();
        } else {
            transactionId = $('userUpiTransactionId2').value.trim();
        }
        
        // NO MINIMUM AMOUNT - User can add any amount
        if (!amount || amount <= 0) {
            showToast('Please enter a valid amount', 'error');
            return;
        }
        
        if (!transactionId) {
            showToast('Please enter your UPI Transaction ID', 'error');
            return;
        }
        
        try {
            showLoading();
            $('paymentBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            $('paymentBtn').disabled = true;
            
            // Create deposit request - GOES TO ADMIN IMMEDIATELY
            const depositRef = await db.collection('deposits').add({
                userId: currentUser.uid,
                userName: userData.name,
                userEmail: userData.email,
                userMobile: userData.mobile,
                userCode: userData.userId,
                amount: amount,
                transactionId: transactionId,
                method: selectedPaymentMethod === 'qr' ? 'QR Code' : 'UPI',
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for admin IMMEDIATELY
            await db.collection('notifications').add({
                type: 'deposit_request',
                title: '💳 New Deposit Request',
                message: `${userData.name} (${userData.userId}) requested deposit of ${formatCurrency(amount)} via ${selectedPaymentMethod === 'qr' ? 'QR Code' : 'UPI'}`,
                userId: 'ADMIN',
                userCode: userData.userId,
                requestId: depositRef.id,
                requestType: 'deposit',
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Deposit request submitted successfully! Admin will process it immediately.');
            
            // Reset form
            $('fundAmount').value = '';
            $('userUpiTransactionId').value = '';
            $('userUpiTransactionId2').value = '';
            
        } catch (error) {
            showToast('Error submitting payment request: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('paymentBtn').innerHTML = '<i class="fas fa-credit-card"></i> Submit Payment Request';
            $('paymentBtn').disabled = false;
        }
    }

    // ================= WITHDRAWAL SYSTEM =================
    async function processWithdrawal() {
        if (!currentUser || !userData) return;
        
        const amount = parseFloat($('withdrawAmount').value);
        const method = $('withdrawMethod').value;
        
        if (!amount || amount < 200) {
            showToast('Minimum withdrawal amount is ₹200', 'error');
            return;
        }
        
        if (amount > userData.balance) {
            showToast('Insufficient balance', 'error');
            return;
        }
        
        // Check KYC status
        if (userData.kycStatus !== 'verified') {
            showToast('Please complete KYC verification before withdrawing funds.', 'error');
            showPage('kycPage');
            return;
        }
        
        let accountDetails = {};
        if (method === 'bank') {
            const bankName = $('bankName').value.trim();
            const accountNumber = $('accountNumber').value.trim();
            const ifscCode = $('ifscCodeInput').value.trim();
            const accountHolder = $('accountHolder').value.trim();
            
            if (!bankName || !accountNumber || !ifscCode || !accountHolder) {
                showToast('Please fill all bank details', 'error');
                return;
            }
            
            accountDetails = { bankName, accountNumber, ifscCode, accountHolder };
        } else if (method === 'upi') {
            const upiId = $('upiIdInput').value.trim();
            if (!upiId) {
                showToast('Please enter UPI ID', 'error');
                return;
            }
            accountDetails = { upiId };
        }
        
        const confirmWithdrawal = confirm(`Request withdrawal of ${formatCurrency(amount)} via ${method}?\nA 5% fee will be deducted.`);
        if (!confirmWithdrawal) return;
        
        try {
            showLoading();
            $('withdrawBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            $('withdrawBtn').disabled = true;
            
            const fee = amount * 0.05;
            const netAmount = amount - fee;
            
            // Create withdrawal request - GOES TO ADMIN IMMEDIATELY
            const withdrawalRef = await db.collection('withdrawals').add({
                userId: currentUser.uid,
                userName: userData.name,
                userEmail: userData.email,
                userMobile: userData.mobile,
                userCode: userData.userId,
                amount: amount,
                netAmount: netAmount,
                fee: fee,
                method: method,
                accountDetails: accountDetails,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Deduct amount from user balance
            await db.collection('users').doc(currentUser.uid).update({
                balance: firebase.firestore.FieldValue.increment(-amount),
                totalWithdrawals: firebase.firestore.FieldValue.increment(amount)
            });
            
            // Create notification for admin IMMEDIATELY
            await db.collection('notifications').add({
                type: 'withdrawal_request',
                title: '💸 New Withdrawal Request',
                message: `${userData.name} (${userData.userId}) requested withdrawal of ${formatCurrency(amount)} via ${method}. Net amount: ${formatCurrency(netAmount)}`,
                userId: 'ADMIN',
                userCode: userData.userId,
                requestId: withdrawalRef.id,
                requestType: 'withdrawal',
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Withdrawal request submitted successfully! Admin will process it immediately.');
            
            // Reset form
            $('withdrawAmount').value = '';
            if (method === 'bank') {
                $('bankName').value = '';
                $('accountNumber').value = '';
                $('ifscCodeInput').value = '';
                $('accountHolder').value = '';
            } else {
                $('upiIdInput').value = '';
            }
            
            // Reload user data
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            userData = userDoc.data();
            updateUserUI();
            loadWithdrawalReport();
            
        } catch (error) {
            showToast('Error processing withdrawal: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('withdrawBtn').innerHTML = '<i class="fas fa-money-check-alt"></i> Request Withdrawal';
            $('withdrawBtn').disabled = false;
        }
    }

    // ================= KYC SUBMISSION =================
    async function submitKYC() {
        if (!currentUser || !userData) return;
        
        const name = $('kycName').value.trim();
        const dob = $('kycDob').value;
        const aadhar = $('kycAadhar').value.trim();
        const pan = $('kycPan').value.trim();
        const accountNumber = $('kycAccountNumber').value.trim();
        const ifscCode = $('kycIfscCode').value.trim();
        const bankName = $('kycBankName').value.trim();
        const accountHolder = $('kycAccountHolder').value.trim();
        
        if (!name || !dob || !aadhar || !pan || !accountNumber || !ifscCode || !bankName || !accountHolder) {
            showToast('Please fill all KYC details', 'error');
            return;
        }
        
        if (aadhar.length !== 12 || !/^\d+$/.test(aadhar)) {
            showToast('Please enter a valid 12-digit Aadhar number', 'error');
            return;
        }
        
        if (pan.length !== 10) {
            showToast('Please enter a valid 10-digit PAN number', 'error');
            return;
        }
        
        try {
            showLoading();
            $('kycSubmitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            $('kycSubmitBtn').disabled = true;
            
            // Update user KYC status
            await db.collection('users').doc(currentUser.uid).update({
                kycName: name,
                kycDob: dob,
                kycAadhar: aadhar,
                kycPan: pan,
                kycAccountNumber: accountNumber,
                kycIfscCode: ifscCode,
                kycBankName: bankName,
                kycAccountHolder: accountHolder,
                kycStatus: 'pending',
                kycSubmitted: true,
                kycSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for admin IMMEDIATELY
            await db.collection('notifications').add({
                type: 'kyc_submitted',
                title: '🆔 New KYC Submission',
                message: `${userData.name} (${userData.userId}) submitted KYC for verification.`,
                userId: 'ADMIN',
                userCode: userData.userId,
                requestType: 'kyc',
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ KYC submitted successfully! Admin will verify it immediately.');
            
            // Update UI
            userData.kycStatus = 'pending';
            $('profileKYC').value = 'pending';
            $('kycStatusText').textContent = 'Pending';
            $('kycStatusText').className = 'text-warning';
            
        } catch (error) {
            showToast('Error submitting KYC: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('kycSubmitBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Submit KYC';
            $('kycSubmitBtn').disabled = false;
        }
    }

    // ================= PASSWORD CHANGE =================
    async function changePassword() {
        if (!currentUser) return;
        
        const currentPassword = $('currentPassword').value;
        const newPassword = $('newPassword').value;
        const confirmPassword = $('confirmPassword').value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showToast('Please fill all password fields', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            showToast('New password must be at least 6 characters long', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showToast('New passwords do not match', 'error');
            return;
        }
        
        try {
            showLoading();
            $('changePasswordBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            $('changePasswordBtn').disabled = true;
            
            // Re-authenticate user
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email,
                currentPassword
            );
            
            await currentUser.reauthenticateWithCredential(credential);
            
            // Update password
            await currentUser.updatePassword(newPassword);
            
            showToast('✅ Password updated successfully!');
            
            // Clear form
            $('currentPassword').value = '';
            $('newPassword').value = '';
            $('confirmPassword').value = '';
            
        } catch (error) {
            showToast('Error changing password: ' + error.message, 'error');
        } finally {
            hideLoading();
            $('changePasswordBtn').innerHTML = '<i class="fas fa-key"></i> Update Password';
            $('changePasswordBtn').disabled = false;
        }
    }

    // ================= NOTIFICATIONS =================
    async function loadNotifications() {
        if (!currentUser) return;
        
        try {
            const notificationsSnapshot = await db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            const notificationList = $('notificationList');
            if (!notificationList) return;
            
            notificationList.innerHTML = '';
            
            let unreadCount = 0;
            
            if (notificationsSnapshot.empty) {
                notificationList.innerHTML = '<div class="notification-item"><p>No notifications yet</p></div>';
            } else {
                notificationsSnapshot.forEach(doc => {
                    const notification = doc.data();
                    if (!notification.read) unreadCount++;
                    
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    notificationItem.innerHTML = `
                        <p><strong>${notification.title || 'Notification'}</strong></p>
                        <p>${notification.message || ''}</p>
                        <div class="notification-time">${formatDateTime(notification.createdAt)}</div>
                    `;
                    
                    notificationItem.onclick = () => markNotificationAsRead(doc.id);
                    notificationList.appendChild(notificationItem);
                });
            }
            
            $('notificationCount').textContent = unreadCount;
            if (unreadCount > 0) {
                $('notificationBtn').classList.add('pulse');
            } else {
                $('notificationBtn').classList.remove('pulse');
            }
            
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    async function markNotificationAsRead(notificationId) {
        try {
            await db.collection('notifications').doc(notificationId).update({
                read: true
            });
            
            loadNotifications();
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    function toggleNotifications() {
        const popup = $('notificationPopup');
        if (popup.style.display === 'block') {
            popup.style.display = 'none';
        } else {
            popup.style.display = 'block';
            if (adminData && adminData.role === 'admin') {
                loadAdminNotifications();
            } else {
                loadNotifications();
            }
        }
    }

    // ================= UTILITY FUNCTIONS =================
    function copyReferralLink() {
        const refLink = $('refLink');
        refLink.select();
        refLink.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showToast('Referral link copied to clipboard!');
    }

    function shareOnTelegram() {
        const refLink = $('refLink').value;
        const text = encodeURIComponent(`Join CapitalRise Trading Platform and start earning! Use my referral link: ${refLink}`);
        window.open(`https://t.me/share/url?url=${refLink}&text=${text}`, '_blank');
    }

    function shareOnWhatsApp() {
        const refLink = $('refLink').value;
        const text = encodeURIComponent(`Join CapitalRise Trading Platform and start earning! Use my referral link: ${refLink}`);
        window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    function toggleSidebar() {
        const sidebar = $('sidebar') || $('adminSidebar');
        const overlay = $('mobileOverlay');
        
        if (sidebar) {
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                if (overlay) overlay.classList.add('active');
            }
        }
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        const sidebar = $('sidebar') || $('adminSidebar');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const overlay = $('mobileOverlay');
        
        if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('open')) {
            if (!sidebar.contains(event.target) && 
                !mobileMenuBtn.contains(event.target) && 
                event.target !== mobileMenuBtn) {
                sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
            }
        }
    });

    async function logout() {
        try {
            // Clear real-time listeners
            realTimeListeners.forEach(unsubscribe => unsubscribe());
            realTimeListeners = [];
            
            await auth.signOut();
            showToast('Logged out successfully');
            window.location.reload();
        } catch (error) {
            console.error('Logout error:', error);
            showToast('Logout failed: ' + error.message, 'error');
        }
    }

    async function adminLogout() {
        try {
            // Clear real-time listeners
            realTimeListeners.forEach(unsubscribe => unsubscribe());
            realTimeListeners = [];
            
            await auth.signOut();
            showToast('Logged out successfully');
            window.location.reload();
        } catch (error) {
            console.error('Logout error:', error);
            showToast('Logout failed: ' + error.message, 'error');
        }
    }

    // ================= COMPLETE REAL-TIME LISTENERS =================
    function startCompleteRealTimeListeners() {
        if (!currentUser) return;
        
        // Clear existing listeners
        realTimeListeners.forEach(unsubscribe => unsubscribe());
        realTimeListeners = [];
        
        // ================= FOR USERS =================
        if (userData && userData.role === 'user') {
            // 1. User data changes
            const userListener = db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        updateUserUI();
                    }
                });
            realTimeListeners.push(userListener);
            
            // 2. Notifications
            const notificationListener = db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    loadNotifications();
                });
            realTimeListeners.push(notificationListener);
            
            // 3. Packages
            const packageListener = db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    loadPackages();
                    loadActivationHistory();
                    loadROIIncome();
                    updateTaskUI();
                    calculateActiveFund();
                });
            realTimeListeners.push(packageListener);
            
            // 4. Deposit requests status
            const depositListener = db.collection('deposits')
                .where('userId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    loadFundReport();
                    showToastForStatusChanges(snapshot, 'deposit');
                }, (error) => {
                    console.error("Deposit listener error:", error);
                });
            realTimeListeners.push(depositListener);
            
            // 5. Withdrawal requests status
            const withdrawalListener = db.collection('withdrawals')
                .where('userId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    loadWithdrawalReport();
                    showToastForStatusChanges(snapshot, 'withdrawal');
                });
            realTimeListeners.push(withdrawalListener);
            
            // 6. Package requests status
            const packageRequestListener = db.collection('package_requests')
                .where('userId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    loadActivationHistory();
                    showToastForStatusChanges(snapshot, 'package');
                });
            realTimeListeners.push(packageRequestListener);
            
            // 7. KYC status changes
            const kycListener = db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.kycStatus === 'verified') {
                            showToast('✅ Your KYC has been verified! You can now withdraw funds.');
                            $('profileKYC').value = 'verified';
                            $('kycStatusText').textContent = 'Verified';
                            $('kycStatusText').className = 'text-success';
                        } else if (userData.kycStatus === 'rejected') {
                            showToast('❌ Your KYC was rejected. Please check and resubmit.', 'error');
                        }
                    }
                });
            realTimeListeners.push(kycListener);
            
            // 8. Transactions
            const transactionListener = db.collection('transactions')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    loadFundReport();
                });
            realTimeListeners.push(transactionListener);
            
            // 9. Task updates
            const taskListener = db.collection('tasks')
                .where('userId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    loadTaskData();
                });
            realTimeListeners.push(taskListener);
        }
        
        // ================= FOR ADMIN =================
        if (adminData && adminData.role === 'admin') {
            // 1. Deposit requests
            const adminDepositListener = db.collection('deposits')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    if ($('adminDepositsPage').classList.contains('active')) {
                        loadDepositRequestsAdmin();
                    }
                    loadAdminDashboard();
                    updateAdminNotificationCount('deposit', snapshot.size);
                });
            realTimeListeners.push(adminDepositListener);
            
            // 2. Withdrawal requests
            const adminWithdrawalListener = db.collection('withdrawals')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    if ($('adminWithdrawalsPage').classList.contains('active')) {
                        loadWithdrawalRequestsAdmin();
                    }
                    loadAdminDashboard();
                    updateAdminNotificationCount('withdrawal', snapshot.size);
                });
            realTimeListeners.push(adminWithdrawalListener);
            
            // 3. Package requests
            const adminPackageListener = db.collection('package_requests')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    if ($('adminPackageRequestsPage').classList.contains('active')) {
                        loadPackageRequestsAdmin();
                    }
                    loadAdminDashboard();
                    updateAdminNotificationCount('package', snapshot.size);
                });
            realTimeListeners.push(adminPackageListener);
            
            // 4. KYC requests
            const adminKYCListener = db.collection('users')
                .where('role', '==', 'user')
                .where('kycSubmitted', '==', true)
                .where('kycStatus', '==', 'pending')
                .onSnapshot((snapshot) => {
                    if ($('adminKYCVerificationPage').classList.contains('active')) {
                        loadKYCRequestsAdmin();
                    }
                    loadAdminDashboard();
                    updateAdminNotificationCount('kyc', snapshot.size);
                });
            realTimeListeners.push(adminKYCListener);
            
            // 5. All users for dashboard
            const adminUsersListener = db.collection('users')
                .where('role', '==', 'user')
                .onSnapshot((snapshot) => {
                    if ($('adminUsersPage').classList.contains('active')) {
                        loadAllUsersAdmin();
                    }
                    loadAdminDashboard();
                });
            realTimeListeners.push(adminUsersListener);
            
            // 6. Admin notifications
            const adminNotificationListener = db.collection('notifications')
                .where('userId', '==', 'ADMIN')
                .where('read', '==', false)
                .onSnapshot((snapshot) => {
                    updateAdminNotificationBadge(snapshot.size);
                });
            realTimeListeners.push(adminNotificationListener);
        }
    }

    function showToastForStatusChanges(snapshot, type) {
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'modified') {
                const data = change.doc.data();
                const oldData = change.doc._previousData;
                
                if (oldData && oldData.status !== data.status) {
                    let message = '';
                    let toastType = 'success';
                    
                    switch(type) {
                        case 'deposit':
                            if (data.status === 'approved') {
                                message = `✅ Deposit approved! ${formatCurrency(data.amount)} added to your balance.`;
                            } else if (data.status === 'rejected') {
                                message = `❌ Deposit rejected: ${data.rejectReason || 'Contact admin'}`;
                                toastType = 'error';
                            }
                            break;
                            
                        case 'withdrawal':
                            if (data.status === 'approved') {
                                message = `✅ Withdrawal approved! ${formatCurrency(data.netAmount)} will be sent.`;
                            } else if (data.status === 'rejected') {
                                message = `❌ Withdrawal rejected: ${data.rejectReason || 'Contact admin'}. Amount refunded.`;
                                toastType = 'error';
                            }
                            break;
                            
                        case 'package':
                            if (data.status === 'approved') {
                                message = `✅ Package activated! ${data.packageName} package is now active.`;
                            } else if (data.status === 'rejected') {
                                message = `❌ Package request rejected: ${data.rejectReason || 'Contact admin'}`;
                                toastType = 'error';
                            }
                            break;
                    }
                    
                    if (message) {
                        showToast(message, toastType);
                        // Reload all user data
                        if (userData) {
                            updateUserUI();
                            loadPackages();
                            loadActivationHistory();
                            loadFundReport();
                            loadWithdrawalReport();
                        }
                    }
                }
            }
        });
    }

    function updateAdminNotificationCount(type, count) {
        if (count > 0) {
            showToast(`New ${type} request(s) received: ${count}`, 'warning');
        }
    }

    function updateAdminNotificationBadge(count) {
        $('notificationCount').textContent = count;
        if (count > 0) {
            $('notificationBtn').classList.add('pulse');
        } else {
            $('notificationBtn').classList.remove('pulse');
        }
    }

    async function loadAdminNotifications() {
        try {
            const snapshot = await db.collection('notifications')
                .where('userId', '==', 'ADMIN')
                .where('read', '==', false)
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
            
            let unreadCount = 0;
            const notificationList = $('notificationList');
            
            if (notificationList) {
                notificationList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    unreadCount++;
                    const notification = doc.data();
                    
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'notification-item unread';
                    notificationItem.innerHTML = `
                        <p><strong>${notification.title || 'Notification'}</strong></p>
                        <p>${notification.message || ''}</p>
                        <div class="notification-time">${formatDateTime(notification.createdAt)}</div>
                    `;
                    
                    notificationItem.onclick = () => {
                        markNotificationAsRead(doc.id);
                        // Navigate to relevant page based on notification type
                        if (notification.requestType === 'deposit') {
                            showAdminPage('adminDepositsPage');
                        } else if (notification.requestType === 'withdrawal') {
                            showAdminPage('adminWithdrawalsPage');
                        } else if (notification.requestType === 'package') {
                            showAdminPage('adminPackageRequestsPage');
                        } else if (notification.requestType === 'kyc') {
                            showAdminPage('adminKYCVerificationPage');
                        }
                    };
                    notificationList.appendChild(notificationItem);
                });
                
                if (snapshot.empty) {
                    notificationList.innerHTML = '<div class="notification-item"><p>No new notifications</p></div>';
                }
            }
            
            $('notificationCount').textContent = unreadCount;
            if (unreadCount > 0) {
                $('notificationBtn').classList.add('pulse');
            } else {
                $('notificationBtn').classList.remove('pulse');
            }
            
        } catch (error) {
            console.error('Error loading admin notifications:', error);
        }
    }

    // ================= ADMIN DASHBOARD =================
    function showAdminDashboard() {
        hideAllPages();
        $('adminDashboard').classList.remove('hidden');
        toggleSidebar(); // Close sidebar on mobile
    }

    function showAdminPage(pageId) {
        // Hide all admin pages
        document.querySelectorAll('#adminDashboard .page').forEach(page => {
            page.classList.remove('active');
        });
        
        // Show selected page
        $(pageId).classList.add('active');
        
        // Update sidebar active state
        document.querySelectorAll('#adminDashboard .sidebar li').forEach(item => {
            item.classList.remove('active');
        });
        
        // Find and activate corresponding sidebar item
        const sidebarItems = document.querySelectorAll('#adminDashboard .sidebar li');
        for (let item of sidebarItems) {
            if (item.textContent.includes(getAdminPageName(pageId))) {
                item.classList.add('active');
                break;
            }
        }
        
        // Close sidebar on mobile
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
        
        // Load page data
        switch(pageId) {
            case 'adminDashboardPage':
                loadAdminDashboard();
                break;
            case 'adminUsersPage':
                loadAllUsersAdmin();
                break;
            case 'adminDepositsPage':
                loadDepositRequestsAdmin();
                break;
            case 'adminWithdrawalsPage':
                loadWithdrawalRequestsAdmin();
                break;
            case 'adminPackageRequestsPage':
                loadPackageRequestsAdmin();
                break;
            case 'adminKYCVerificationPage':
                loadKYCRequestsAdmin();
                break;
            case 'adminTransactionsPage':
                loadAllTransactionsAdmin();
                break;
            case 'adminSettingsPage':
                loadAdminSettings();
                break;
        }
    }

    function getAdminPageName(pageId) {
        const pageNames = {
            'adminDashboardPage': 'Dashboard',
            'adminUsersPage': 'All Users',
            'adminDepositsPage': 'Deposit Requests',
            'adminWithdrawalsPage': 'Withdrawal Requests',
            'adminPackageRequestsPage': 'Package Requests',
            'adminKYCVerificationPage': 'KYC Verification',
            'adminTransactionsPage': 'All Transactions',
            'adminSettingsPage': 'Settings'
        };
        return pageNames[pageId] || '';
    }

    async function loadAdminDashboard() {
        try {
            // Load total users
            const usersSnapshot = await db.collection('users').where('role', '==', 'user').get();
            $('adminTotalUsers').textContent = usersSnapshot.size;
            
            // Load today's users
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayUsersSnapshot = await db.collection('users')
                .where('role', '==', 'user')
                .where('createdAt', '>=', today)
                .get();
            $('adminTodayUsers').textContent = todayUsersSnapshot.size;
            
            // Load active users (with active packages)
            const activeUsersSnapshot = await db.collection('packages')
                .where('status', '==', 'active')
                .get();
            
            const activeUserIds = new Set();
            activeUsersSnapshot.forEach(doc => {
                activeUserIds.add(doc.data().userId);
            });
            $('adminActiveUsers').textContent = activeUserIds.size;
            
            // Load total deposits
            const depositsSnapshot = await db.collection('deposits').get();
            let totalDeposits = 0;
            let todayDeposits = 0;
            let pendingDepositsAmount = 0;
            depositsSnapshot.forEach(doc => {
                const deposit = doc.data();
                if (deposit.status === 'approved') {
                    totalDeposits += deposit.amount;
                }
                if (deposit.createdAt && deposit.createdAt.toDate() >= today) {
                    todayDeposits += deposit.amount;
                }
                if (deposit.status === 'pending') {
                    pendingDepositsAmount += deposit.amount;
                }
            });
            $('adminTotalDeposits').textContent = formatCurrency(totalDeposits);
            $('adminTodayDeposits').textContent = formatCurrency(todayDeposits);
            
            // Load total withdrawals
            const withdrawalsSnapshot = await db.collection('withdrawals').get();
            let totalWithdrawals = 0;
            let pendingWithdrawals = 0;
            withdrawalsSnapshot.forEach(doc => {
                const withdrawal = doc.data();
                if (withdrawal.status === 'approved') {
                    totalWithdrawals += withdrawal.amount;
                } else if (withdrawal.status === 'pending') {
                    pendingWithdrawals += withdrawal.amount;
                }
            });
            $('adminTotalWithdrawals').textContent = formatCurrency(totalWithdrawals);
            $('adminPendingWithdrawals').textContent = formatCurrency(pendingWithdrawals);
            
            // Load total investments
            const packagesSnapshot = await db.collection('packages').where('status', '==', 'active').get();
            let totalInvestments = 0;
            packagesSnapshot.forEach(doc => {
                const pkg = doc.data();
                totalInvestments += pkg.amount;
            });
            $('adminTotalInvestments').textContent = formatCurrency(totalInvestments);
            
            // Load pending requests
            const pendingDeposits = await db.collection('deposits').where('status', '==', 'pending').get();
            const pendingWithdrawalsCount = await db.collection('withdrawals').where('status', '==', 'pending').get();
            const pendingPackages = await db.collection('package_requests').where('status', '==', 'pending').get();
            $('adminPendingRequests').textContent = pendingDeposits.size + pendingWithdrawalsCount.size + pendingPackages.size;
            
            // Load total commission
            const users = await db.collection('users').where('role', '==', 'user').get();
            let totalCommission = 0;
            users.forEach(doc => {
                const user = doc.data();
                totalCommission += user.referralEarnings || 0;
            });
            $('adminTotalCommission').textContent = formatCurrency(totalCommission);
            
            // Load platform balance
            const platformBalance = totalDeposits - totalWithdrawals - totalCommission;
            $('adminPlatformBalance').textContent = formatCurrency(platformBalance);
            
            // Load recent activity
            loadRecentActivityAdmin();
        } catch (error) {
            console.error('Error loading admin dashboard:', error);
            showToast('Error loading admin dashboard: ' + error.message, 'error');
        }
    }

    async function loadRecentActivityAdmin() {
        try {
            const transactionsSnapshot = await db.collection('transactions')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
            
            const table = $('adminRecentActivity');
            if (!table) return;
            
            table.innerHTML = '';
            
            if (transactionsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="5" class="text-center">No recent activity</td></tr>';
            } else {
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    const statusClass = transaction.status === 'approved' ? 'status-active' :
                                    transaction.status === 'pending' ? 'status-pending' : 'status-rejected';
                    
                    const row = `
                        <tr>
                            <td>${formatDateTime(transaction.timestamp)}</td>
                            <td>${getUserCode(transaction.userId)}</td>
                            <td>${transaction.description || transaction.type}</td>
                            <td>${formatCurrency(transaction.amount)}</td>
                            <td><span class="${statusClass}">${transaction.status}</span></td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
        } catch (error) {
            console.error('Error loading recent activity:', error);
        }
    }

    function getUserCode(uid) {
        if (uid === 'ADMIN') return 'ADMIN';
        if (uid && uid.length >= 6) {
            return 'CR' + uid.slice(-6).toUpperCase();
        }
        return 'Unknown';
    }

    // ================= ADMIN USER MANAGEMENT =================
    async function loadAllUsersAdmin() {
        try {
            const usersSnapshot = await db.collection('users').where('role', '==', 'user').get();
            const table = $('adminUsersTable');
            
            if (!table) return;
            
            table.innerHTML = '';
            
            if (usersSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="9" class="text-center">No users found</td></tr>';
            } else {
                for (const doc of usersSnapshot.docs) {
                    const user = doc.data();
                    
                    // Get active packages count
                    const packagesSnapshot = await db.collection('packages')
                        .where('userId', '==', doc.id)
                        .where('status', '==', 'active')
                        .get();
                    
                    const activePackages = packagesSnapshot.size;
                    
                    const row = `
                        <tr>
                            <td>${user.userId}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${formatCurrency(user.balance)}</td>
                            <td>${activePackages}</td>
                            <td><span class="status-${user.status}">${user.status}</span></td>
                            <td><span class="status-${user.kycStatus || 'pending'}">${user.kycStatus || 'pending'}</span></td>
                            <td>${formatDate(user.createdAt)}</td>
                            <td>
                                <button class="btn btn-small" onclick="viewUserDetailsAdmin('${doc.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-success btn-small" onclick="activateUser('${doc.id}')" title="Activate" ${user.status === 'active' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-warning btn-small" onclick="deactivateUser('${doc.id}')" title="Deactivate" ${user.status !== 'active' ? 'disabled' : ''}>
                                    <i class="fas fa-ban"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="blockUser('${doc.id}')" title="Block" ${user.status === 'blocked' ? 'disabled' : ''}>
                                    <i class="fas fa-lock"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                }
            }
        } catch (error) {
            console.error('Error loading all users:', error);
            showToast('Error loading users: ' + error.message, 'error');
        }
    }

    function showAddUserModal() {
        showModal('addUserModal');
    }

    async function createNewUser() {
        const name = $('newUserName').value.trim();
        const email = $('newUserEmail').value.trim();
        const mobile = $('newUserMobile').value.trim();
        const password = $('newUserPassword').value;
        const balance = parseFloat($('newUserBalance').value) || 0;

        if (!name || !email || !mobile || !password) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        if (password.length < 6) {
            showToast('Password must be at least 6 characters long', 'error');
            return;
        }

        try {
            showLoading();
            
            // Create user in Firebase Auth
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Generate user ID
            const userId = generateUserId(user.uid);
            
            // Create user document
            await db.collection('users').doc(user.uid).set({
                uid: user.uid,
                userId: userId,
                name: name,
                email: email,
                mobile: mobile,
                sponsorId: 'ADMIN',
                balance: balance,
                totalEarnings: 0,
                referralEarnings: 0,
                totalDeposits: 0,
                totalWithdrawals: 0,
                status: 'active',
                kycStatus: 'pending',
                kycSubmitted: false,
                referralCount: 0,
                role: 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('✅ User created successfully!');
            closeModal('addUserModal');
            loadAllUsersAdmin();
            
            // Clear form
            $('newUserName').value = '';
            $('newUserEmail').value = '';
            $('newUserMobile').value = '';
            $('newUserPassword').value = '';
            $('newUserBalance').value = '50';
            
        } catch (error) {
            showToast('Error creating user: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function viewUserDetailsAdmin(userId) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                showToast('User not found', 'error');
                return;
            }
            
            const user = userDoc.data();
            
            // Get user packages
            const packagesSnapshot = await db.collection('packages')
                .where('userId', '==', userId)
                .orderBy('activatedAt', 'desc')
                .get();
            
            // Get user transactions
            const transactionsSnapshot = await db.collection('transactions')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
            
            let packagesHTML = '';
            packagesSnapshot.forEach(doc => {
                const pkg = doc.data();
                packagesHTML += `
                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 5px;">
                        <strong>${pkg.name}</strong> - ${formatCurrency(pkg.amount)}<br>
                        <small>Status: ${pkg.status} | Activated: ${formatDate(pkg.activatedAt)}</small>
                    </div>
                `;
            });
            
            let transactionsHTML = '';
            transactionsSnapshot.forEach(doc => {
                const transaction = doc.data();
                transactionsHTML += `
                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 5px;">
                        <strong>${transaction.type}</strong> - ${formatCurrency(transaction.amount)}<br>
                        <small>Status: ${transaction.status} | Date: ${formatDateTime(transaction.timestamp)}</small>
                    </div>
                `;
            });
            
            const content = `
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" class="form-control" value="${user.userId}" readonly>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-control" value="${user.name}" readonly>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" value="${user.email}" readonly>
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="text" class="form-control" value="${user.mobile}" readonly>
                </div>
                <div class="form-group">
                    <label>Balance</label>
                    <input type="text" class="form-control" value="${formatCurrency(user.balance)}" readonly>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <input type="text" class="form-control" value="${user.status}" readonly>
                </div>
                <div class="form-group">
                    <label>KYC Status</label>
                    <input type="text" class="form-control" value="${user.kycStatus || 'pending'}" readonly>
                </div>
                <div class="form-group">
                    <label>Active Packages (${packagesSnapshot.size})</label>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${packagesHTML || 'No packages found'}
                    </div>
                </div>
                <div class="form-group">
                    <label>Recent Transactions</label>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${transactionsHTML || 'No transactions found'}
                    </div>
                </div>
            `;
            
            $('userDetailsContent').innerHTML = content;
            showModal('userDetailsModal');
        } catch (error) {
            console.error('Error viewing user details:', error);
            showToast('Error loading user details: ' + error.message, 'error');
        }
    }

    async function activateUser(userId) {
        try {
            showLoading();
            
            await db.collection('users').doc(userId).update({
                status: 'active'
            });
            
            // Create notification for user
            const userDoc = await db.collection('users').doc(userId).get();
            const user = userDoc.data();
            
            await db.collection('notifications').add({
                type: 'account_activated',
                title: 'Account Activated',
                message: 'Your account has been activated by admin.',
                userId: userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ User activated successfully!');
            loadAllUsersAdmin();
        } catch (error) {
            showToast('Error activating user: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function deactivateUser(userId) {
        try {
            showLoading();
            
            await db.collection('users').doc(userId).update({
                status: 'inactive'
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'account_deactivated',
                title: 'Account Deactivated',
                message: 'Your account has been deactivated by admin.',
                userId: userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ User deactivated successfully!');
            loadAllUsersAdmin();
        } catch (error) {
            showToast('Error deactivating user: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function blockUser(userId) {
        try {
            showLoading();
            
            await db.collection('users').doc(userId).update({
                status: 'blocked'
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'account_blocked',
                title: 'Account Blocked',
                message: 'Your account has been blocked by admin.',
                userId: userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ User blocked successfully!');
            loadAllUsersAdmin();
        } catch (error) {
            showToast('Error blocking user: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function searchUsers() {
        const searchTerm = $('searchUser').value.toLowerCase();
        const table = $('adminUsersTable');
        const rows = table.getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;
            
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                    found = true;
                    break;
                }
            }
            
            rows[i].style.display = found ? '' : 'none';
        }
    }

    // ================= ADMIN DEPOSIT MANAGEMENT =================
    async function loadDepositRequestsAdmin() {
        try {
            const depositsSnapshot = await db.collection('deposits')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
            
            const table = $('adminDepositsTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let pendingCount = 0;
            let pendingAmount = 0;
            let todayCount = 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (depositsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="8" class="text-center">No deposit requests found</td></tr>';
            } else {
                depositsSnapshot.forEach(doc => {
                    const deposit = doc.data();
                    pendingCount++;
                    pendingAmount += deposit.amount;
                    
                    if (deposit.createdAt && deposit.createdAt.toDate() >= today) {
                        todayCount++;
                    }
                    
                    const row = `
                        <tr>
                            <td>${doc.id.slice(-8).toUpperCase()}</td>
                            <td>${deposit.userCode || getUserCode(deposit.userId)}</td>
                            <td>${deposit.userName}</td>
                            <td>${formatCurrency(deposit.amount)}</td>
                            <td>${deposit.transactionId}</td>
                            <td>${formatDate(deposit.createdAt)}</td>
                            <td><span class="status-pending">Pending</span></td>
                            <td>
                                <button class="btn btn-success btn-small" onclick="approveDeposit('${doc.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="rejectDeposit('${doc.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('pendingDepositsCount').textContent = pendingCount;
            $('pendingDepositsAmount').textContent = formatCurrency(pendingAmount);
            $('todayDepositsCount').textContent = todayCount;
        } catch (error) {
            console.error('Error loading deposit requests:', error);
            showToast('Error loading deposit requests: ' + error.message, 'error');
        }
    }

    async function approveDeposit(depositId) {
        try {
            showLoading();
            
            const depositDoc = await db.collection('deposits').doc(depositId).get();
            const deposit = depositDoc.data();
            
            if (!deposit) {
                showToast('Deposit request not found', 'error');
                return;
            }
            
            // Update user balance
            await db.collection('users').doc(deposit.userId).update({
                balance: firebase.firestore.FieldValue.increment(deposit.amount),
                totalDeposits: firebase.firestore.FieldValue.increment(deposit.amount)
            });
            
            // Update deposit status
            await db.collection('deposits').doc(depositId).update({
                status: 'approved',
                approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                approvedBy: adminData.userId
            });
            
            // Create transaction record
            await db.collection('transactions').add({
                userId: deposit.userId,
                userCode: deposit.userCode,
                type: 'deposit',
                amount: deposit.amount,
                description: 'Deposit Approved',
                status: 'approved',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'deposit_approved',
                title: '✅ Deposit Approved',
                message: `Your deposit of ${formatCurrency(deposit.amount)} has been approved and added to your balance.`,
                userId: deposit.userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Deposit approved successfully!');
            
            // Force reload all admin data
            loadDepositRequestsAdmin();
            loadAdminDashboard();
            
        } catch (error) {
            showToast('Error approving deposit: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function rejectDeposit(depositId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) {
            showToast('Rejection reason is required', 'error');
            return;
        }
        
        try {
            showLoading();
            
            const depositDoc = await db.collection('deposits').doc(depositId).get();
            const deposit = depositDoc.data();
            
            if (!deposit) {
                showToast('Deposit request not found', 'error');
                return;
            }
            
            // Update deposit status
            await db.collection('deposits').doc(depositId).update({
                status: 'rejected',
                rejectReason: reason,
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectedBy: adminData.userId
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'deposit_rejected',
                title: '❌ Deposit Rejected',
                message: `Your deposit of ${formatCurrency(deposit.amount)} was rejected. Reason: ${reason}`,
                userId: deposit.userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('❌ Deposit rejected!');
            loadDepositRequestsAdmin();
            
        } catch (error) {
            showToast('Error rejecting deposit: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // ================= ADMIN WITHDRAWAL MANAGEMENT =================
    async function loadWithdrawalRequestsAdmin() {
        try {
            const withdrawalsSnapshot = await db.collection('withdrawals')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
            
            const table = $('adminWithdrawalsTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let pendingCount = 0;
            let pendingAmount = 0;
            let todayCount = 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (withdrawalsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="8" class="text-center">No withdrawal requests found</td></tr>';
            } else {
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    pendingCount++;
                    pendingAmount += withdrawal.amount;
                    
                    if (withdrawal.createdAt && withdrawal.createdAt.toDate() >= today) {
                        todayCount++;
                    }
                    
                    const row = `
                        <tr>
                            <td>${doc.id.slice(-8).toUpperCase()}</td>
                            <td>${withdrawal.userCode || getUserCode(withdrawal.userId)}</td>
                            <td>${withdrawal.userName}</td>
                            <td>${formatCurrency(withdrawal.amount)}</td>
                            <td>${withdrawal.method}</td>
                            <td>${formatDate(withdrawal.createdAt)}</td>
                            <td><span class="status-pending">Pending</span></td>
                            <td>
                                <button class="btn btn-success btn-small" onclick="approveWithdrawal('${doc.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="rejectWithdrawal('${doc.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('pendingWithdrawalsCount').textContent = pendingCount;
            $('pendingWithdrawalsAmount').textContent = formatCurrency(pendingAmount);
            $('todayWithdrawalsCount').textContent = todayCount;
        } catch (error) {
            console.error('Error loading withdrawal requests:', error);
            showToast('Error loading withdrawal requests: ' + error.message, 'error');
        }
    }

    async function approveWithdrawal(withdrawalId) {
        try {
            showLoading();
            
            const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
            const withdrawal = withdrawalDoc.data();
            
            if (!withdrawal) {
                showToast('Withdrawal request not found', 'error');
                return;
            }
            
            // Update withdrawal status
            await db.collection('withdrawals').doc(withdrawalId).update({
                status: 'approved',
                processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: adminData.userId
            });
            
            // Create transaction record
            await db.collection('transactions').add({
                userId: withdrawal.userId,
                type: 'withdrawal',
                amount: withdrawal.amount,
                description: 'Withdrawal Approved',
                status: 'approved',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'withdrawal_approved',
                title: '✅ Withdrawal Approved',
                message: `Your withdrawal of ${formatCurrency(withdrawal.amount)} has been approved and will be processed shortly.`,
                userId: withdrawal.userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Withdrawal approved successfully!');
            loadWithdrawalRequestsAdmin();
            loadAdminDashboard();
            
        } catch (error) {
            showToast('Error approving withdrawal: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function rejectWithdrawal(withdrawalId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) {
            showToast('Rejection reason is required', 'error');
            return;
        }
        
        try {
            showLoading();
            
            const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
            const withdrawal = withdrawalDoc.data();
            
            if (!withdrawal) {
                showToast('Withdrawal request not found', 'error');
                return;
            }
            
            // Refund amount to user
            await db.collection('users').doc(withdrawal.userId).update({
                balance: firebase.firestore.FieldValue.increment(withdrawal.amount)
            });
            
            // Update withdrawal status
            await db.collection('withdrawals').doc(withdrawalId).update({
                status: 'rejected',
                rejectReason: reason,
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectedBy: adminData.userId
            });
            
            // Create transaction record
            await db.collection('transactions').add({
                userId: withdrawal.userId,
                type: 'withdrawal_refund',
                amount: withdrawal.amount,
                description: 'Withdrawal Rejected - Amount Refunded',
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'withdrawal_rejected',
                title: '❌ Withdrawal Rejected',
                message: `Your withdrawal of ${formatCurrency(withdrawal.amount)} was rejected. Reason: ${reason}. Amount has been refunded to your balance.`,
                userId: withdrawal.userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('❌ Withdrawal rejected and amount refunded!');
            loadWithdrawalRequestsAdmin();
            
        } catch (error) {
            showToast('Error rejecting withdrawal: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // ================= ADMIN PACKAGE REQUESTS =================
    async function loadPackageRequestsAdmin() {
        try {
            const requestsSnapshot = await db.collection('package_requests')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get();
            
            const table = $('adminPackageRequestsTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let pendingCount = 0;
            let totalAmount = 0;
            let todayCount = 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (requestsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="8" class="text-center">No package requests found</td></tr>';
            } else {
                requestsSnapshot.forEach(doc => {
                    const request = doc.data();
                    pendingCount++;
                    totalAmount += request.amount;
                    
                    if (request.createdAt && request.createdAt.toDate() >= today) {
                        todayCount++;
                    }
                    
                    const row = `
                        <tr>
                            <td>${doc.id.slice(-8).toUpperCase()}</td>
                            <td>${request.userCode || getUserCode(request.userId)}</td>
                            <td>${request.userName}</td>
                            <td>${request.packageName}</td>
                            <td>${formatCurrency(request.amount)}</td>
                            <td>${formatDate(request.createdAt)}</td>
                            <td><span class="status-pending">Pending</span></td>
                            <td>
                                <button class="btn btn-success btn-small" onclick="approvePackageRequest('${doc.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="rejectPackageRequest('${doc.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('pendingPackageRequests').textContent = pendingCount;
            $('totalPackageAmount').textContent = formatCurrency(totalAmount);
            $('todayPackageRequests').textContent = todayCount;
        } catch (error) {
            console.error('Error loading package requests:', error);
            showToast('Error loading package requests: ' + error.message, 'error');
        }
    }

    async function approvePackageRequest(requestId) {
        try {
            showLoading();
            
            const requestDoc = await db.collection('package_requests').doc(requestId).get();
            const request = requestDoc.data();
            
            if (!request) {
                showToast('Package request not found', 'error');
                return;
            }
            
            // Create package - VALID FOR 30 DAYS
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + request.validity);
            
            await db.collection('packages').add({
                userId: request.userId,
                userName: request.userName,
                userEmail: request.userEmail,
                packageId: request.packageId,
                name: request.packageName,
                amount: request.amount,
                dailyROI: request.dailyROI,
                validity: request.validity,
                status: 'active',
                activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiryDate: expiryDate
            });
            
            // Update package request status
            await db.collection('package_requests').doc(requestId).update({
                status: 'approved',
                approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                approvedBy: adminData.userId
            });
            
            // Create transaction record
            await db.collection('transactions').add({
                userId: request.userId,
                type: 'package_activation',
                amount: request.amount,
                description: `${request.packageName} Package Activated`,
                status: 'approved',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'package_approved',
                title: '✅ Package Activated',
                message: `Your ${request.packageName} package of ${formatCurrency(request.amount)} has been activated for ${request.validity} days.`,
                userId: request.userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ Package request approved successfully!');
            loadPackageRequestsAdmin();
            loadAdminDashboard();
            
        } catch (error) {
            showToast('Error approving package request: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function rejectPackageRequest(requestId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) {
            showToast('Rejection reason is required', 'error');
            return;
        }
        
        try {
            showLoading();
            
            const requestDoc = await db.collection('package_requests').doc(requestId).get();
            const request = requestDoc.data();
            
            if (!request) {
                showToast('Package request not found', 'error');
                return;
            }
            
            // Refund amount to user
            await db.collection('users').doc(request.userId).update({
                balance: firebase.firestore.FieldValue.increment(request.amount)
            });
            
            // Update package request status
            await db.collection('package_requests').doc(requestId).update({
                status: 'rejected',
                rejectReason: reason,
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectedBy: adminData.userId
            });
            
            // Create transaction record
            await db.collection('transactions').add({
                userId: request.userId,
                type: 'package_refund',
                amount: request.amount,
                description: 'Package Request Rejected - Amount Refunded',
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'package_rejected',
                title: '❌ Package Request Rejected',
                message: `Your ${request.packageName} package request was rejected. Reason: ${reason}. Amount has been refunded to your balance.`,
                userId: request.userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('❌ Package request rejected and amount refunded!');
            loadPackageRequestsAdmin();
            
        } catch (error) {
            showToast('Error rejecting package request: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // ================= ADMIN KYC VERIFICATION =================
    async function loadKYCRequestsAdmin() {
        try {
            const usersSnapshot = await db.collection('users')
                .where('role', '==', 'user')
                .where('kycSubmitted', '==', true)
                .where('kycStatus', '==', 'pending')
                .get();
            
            const table = $('adminKYCTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            let pendingCount = 0;
            let verifiedCount = 0;
            let rejectedCount = 0;
            
            // Count all KYC statuses
            const allUsers = await db.collection('users').where('role', '==', 'user').get();
            allUsers.forEach(doc => {
                const user = doc.data();
                if (user.kycStatus === 'verified') verifiedCount++;
                else if (user.kycStatus === 'rejected') rejectedCount++;
            });
            
            pendingCount = usersSnapshot.size;
            
            if (usersSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="8" class="text-center">No pending KYC requests found</td></tr>';
            } else {
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const row = `
                        <tr>
                            <td>${user.userId}</td>
                            <td>${user.name}</td>
                            <td>${user.kycAadhar ? '****' + user.kycAadhar.slice(-4) : 'Not provided'}</td>
                            <td>${user.kycPan || 'Not provided'}</td>
                            <td>${user.kycAccountNumber ? '****' + user.kycAccountNumber.slice(-4) : 'Not provided'}</td>
                            <td>${formatDate(user.kycSubmittedAt)}</td>
                            <td><span class="status-pending">Pending</span></td>
                            <td>
                                <button class="btn btn-success btn-small" onclick="approveKYC('${doc.id}')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-danger btn-small" onclick="rejectKYC('${doc.id}')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button class="btn btn-small" onclick="viewKYCDetails('${doc.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
            
            // Update stats
            $('pendingKYC').textContent = pendingCount;
            $('verifiedKYC').textContent = verifiedCount;
            $('rejectedKYC').textContent = rejectedCount;
        } catch (error) {
            console.error('Error loading KYC requests:', error);
            showToast('Error loading KYC requests: ' + error.message, 'error');
        }
    }

    async function viewKYCDetails(userId) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                showToast('User not found', 'error');
                return;
            }
            
            const user = userDoc.data();
            
            const content = `
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" class="form-control" value="${user.userId}" readonly>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-control" value="${user.kycName || user.name}" readonly>
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="text" class="form-control" value="${user.kycDob || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>Aadhar Number</label>
                    <input type="text" class="form-control" value="${user.kycAadhar || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>PAN Number</label>
                    <input type="text" class="form-control" value="${user.kycPan || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" class="form-control" value="${user.kycBankName || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" class="form-control" value="${user.kycAccountNumber || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>IFSC Code</label>
                    <input type="text" class="form-control" value="${user.kycIfscCode || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>Account Holder</label>
                    <input type="text" class="form-control" value="${user.kycAccountHolder || 'Not provided'}" readonly>
                </div>
                <div class="form-group">
                    <label>Submitted Date</label>
                    <input type="text" class="form-control" value="${formatDate(user.kycSubmittedAt)}" readonly>
                </div>
            `;
            
            $('userDetailsContent').innerHTML = content;
            showModal('userDetailsModal');
        } catch (error) {
            console.error('Error viewing KYC details:', error);
            showToast('Error loading KYC details: ' + error.message, 'error');
        }
    }

    async function approveKYC(userId) {
        try {
            showLoading();
            
            await db.collection('users').doc(userId).update({
                kycStatus: 'verified',
                kycVerifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                kycVerifiedBy: adminData.userId
            });
            
            // Create notification for user
            const userDoc = await db.collection('users').doc(userId).get();
            const user = userDoc.data();
            
            await db.collection('notifications').add({
                type: 'kyc_approved',
                title: '✅ KYC Approved',
                message: 'Your KYC verification has been approved. You can now withdraw funds.',
                userId: userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('✅ KYC approved successfully!');
            loadKYCRequestsAdmin();
            
        } catch (error) {
            showToast('Error approving KYC: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function rejectKYC(userId) {
        const reason = prompt('Enter rejection reason:');
        if (!reason) {
            showToast('Rejection reason is required', 'error');
            return;
        }
        
        try {
            showLoading();
            
            await db.collection('users').doc(userId).update({
                kycStatus: 'rejected',
                kycRejectReason: reason,
                kycRejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                kycRejectedBy: adminData.userId
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'kyc_rejected',
                title: '❌ KYC Rejected',
                message: `Your KYC verification was rejected. Reason: ${reason}`,
                userId: userId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('❌ KYC rejected!');
            loadKYCRequestsAdmin();
            
        } catch (error) {
            showToast('Error rejecting KYC: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // ================= ADMIN TRANSACTIONS =================
    async function loadAllTransactionsAdmin() {
        try {
            let query = db.collection('transactions').orderBy('timestamp', 'desc').limit(100);
            
            const fromDate = $('transactionFromDate').value;
            const toDate = $('transactionToDate').value;
            const type = $('transactionType').value;
            
            if (fromDate) {
                const startDate = new Date(fromDate);
                startDate.setHours(0, 0, 0, 0);
                query = query.where('timestamp', '>=', startDate);
            }
            
            if (toDate) {
                const endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999);
                query = query.where('timestamp', '<=', endDate);
            }
            
            if (type) {
                query = query.where('type', '==', type);
            }
            
            const transactionsSnapshot = await query.get();
            const table = $('adminTransactionsTable');
            
            if (!table) return;
            
            table.innerHTML = '';
            
            if (transactionsSnapshot.empty) {
                table.innerHTML = '<tr><td colspan="7" class="text-center">No transactions found</td></tr>';
            } else {
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    const statusClass = transaction.status === 'approved' ? 'status-active' :
                                    transaction.status === 'pending' ? 'status-pending' : 'status-rejected';
                    
                    const row = `
                        <tr>
                            <td>${doc.id.slice(-8).toUpperCase()}</td>
                            <td>${getUserCode(transaction.userId)}</td>
                            <td>${transaction.type.replace('_', ' ').toUpperCase()}</td>
                            <td>${formatCurrency(transaction.amount)}</td>
                            <td>${transaction.description}</td>
                            <td>${formatDateTime(transaction.timestamp)}</td>
                            <td><span class="${statusClass}">${transaction.status}</span></td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
            }
        } catch (error) {
            console.error('Error loading all transactions:', error);
            showToast('Error loading transactions: ' + error.message, 'error');
        }
    }

    function filterTransactions() {
        loadAllTransactionsAdmin();
    }

    // ================= ADMIN SETTINGS =================
    async function loadAdminSettings() {
        try {
            const settingsDoc = await db.collection('settings').doc('platform').get();
            
            if (settingsDoc.exists) {
                const settings = settingsDoc.data();
                
                $('minDeposit').value = settings.minDeposit || 1;
                $('minWithdrawal').value = settings.minWithdrawal || 200;
                $('withdrawalFee').value = settings.withdrawalFee || 5;
                $('referralCommission').value = settings.referralCommission || 10;
                $('dailyTaskIncome').value = settings.dailyTaskIncome || 5;
                $('packageValidity').value = settings.packageValidity || 30;
                $('adminUpiId').value = settings.adminUpiId || 'capitalrise@ybl';
                $('qrCodeUrl').value = settings.qrCodeUrl || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl';
                $('bankDetailsText').value = settings.bankDetails || 'State Bank of India\nAccount: 123456789012\nIFSC: SBIN0001234\nName: CapitalRise Trading';
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            showToast('Error loading settings: ' + error.message, 'error');
        }
    }

    async function saveAdminSettings() {
        try {
            showLoading();
            
            const settings = {
                minDeposit: parseFloat($('minDeposit').value) || 1,
                minWithdrawal: parseFloat($('minWithdrawal').value) || 200,
                withdrawalFee: parseFloat($('withdrawalFee').value) || 5,
                referralCommission: parseFloat($('referralCommission').value) || 10,
                dailyTaskIncome: parseFloat($('dailyTaskIncome').value) || 5,
                packageValidity: parseInt($('packageValidity').value) || 30,
                adminUpiId: $('adminUpiId').value.trim() || 'capitalrise@ybl',
                qrCodeUrl: $('qrCodeUrl').value.trim() || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl',
                bankDetails: $('bankDetailsText').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: adminData.userId
            };
            
            await db.collection('settings').doc('platform').set(settings, { merge: true });
            
            showToast('✅ Settings saved successfully!');
            
        } catch (error) {
            showToast('Error saving settings: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // ================= MODAL MANAGEMENT =================
    function showModal(modalId) {
        $(modalId).style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        $(modalId).style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    };

    // ================= WITHDRAWAL METHOD TOGGLE =================
    if ($('withdrawMethod')) {
        $('withdrawMethod').addEventListener('change', function() {
            const method = this.value;
            $('bankDetailsSection').style.display = method === 'bank' ? 'block' : 'none';
            $('upiDetailsSection').style.display = method === 'upi' ? 'block' : 'none';
        });
    }

    // ================= PACKAGE EXPIRY CHECK =================
    async function checkPackageExpiry() {
        if (!currentUser) return;
        
        try {
            const now = new Date();
            const packagesSnapshot = await db.collection('packages')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get();
            
            packagesSnapshot.forEach(async (doc) => {
                const pkg = doc.data();
                if (pkg.expiryDate && pkg.expiryDate.toDate() < now) {
                    // Mark package as expired after 30 days
                    await db.collection('packages').doc(doc.id).update({
                        status: 'expired'
                    });
                    
                    // Create notification for user
                    await db.collection('notifications').add({
                        type: 'package_expired',
                        title: 'Package Expired',
                        message: `Your ${pkg.name} package has expired after 30 days.`,
                        userId: currentUser.uid,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });
        } catch (error) {
            console.error('Error checking package expiry:', error);
        }
    }

    // ================= INITIALIZATION =================
    window.addEventListener('DOMContentLoaded', function() {
        // Set today's date as max for date inputs
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(input => {
            input.max = today;
            if (input.id === 'transactionFromDate' || input.id === 'transactionToDate') {
                input.value = today;
            }
        });
        
        // Check for referral in URL
        const urlParams = new URLSearchParams(window.location.search);
        const referralId = urlParams.get('ref');
        if (referralId) {
            localStorage.setItem('referralId', referralId);
            $('regSponsorID').value = referralId;
        }
        
        // Initialize withdrawal method toggle
        if ($('withdrawMethod')) {
            $('withdrawMethod').dispatchEvent(new Event('change'));
        }
        
        // Load QR code
        if ($('qrCodeDisplay')) {
            loadQRCodeForUser();
        }
        
        // Check package expiry periodically
        setInterval(checkPackageExpiry, 60000); // Check every minute
        
        // Auto refresh dashboard every 30 seconds
        setInterval(() => {
            if (userData) {
                updateUserUI();
            }
            if (adminData) {
                loadAdminDashboard();
            }
        }, 30000);
        
        // Auto-hide toast after 5 seconds
        setInterval(() => {
            const toast = $('toast');
            if (toast.style.display === 'block') {
                hide(toast);
            }
        }, 5000);
        
        console.log('CapitalRise Trading Platform v3.0 - Pro Version Initialized');
        
        // Prevent zoom on mobile
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    });
    firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) return;

  const userRef = db.collection('users').doc(user.uid);
  const snap = await userRef.get();

  // 🔥 AUTO CREATE USER DOC (FOR ALL USERS)
  if (!snap.exists) {
    await userRef.set({
      role: "user",
      balance: 0,
      totalEarnings: 0,
      kycStatus: "approved",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
});

    </script>

</body>
</html>
