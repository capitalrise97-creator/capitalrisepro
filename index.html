<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CapitalRise Trading Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================= RESET & BASE STYLES ================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #a970ff;
            --secondary: #ff6b9d;
            --success: #2ed573;
            --danger: #ff4757;
            --warning: #ffa502;
            --info: #1e90ff;
            --dark: #0c0c0c;
            --darker: #1a1a2e;
            --light: #ffffff;
            --gray: #8a8a8a;
            --border: rgba(169, 112, 255, 0.2);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 50%, #16213e 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ================= LOADING ================= */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ================= HEADER ================= */
        .header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-tagline {
            font-size: 12px;
            color: var(--gray);
            opacity: 0.8;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-btn {
            background: rgba(169, 112, 255, 0.1);
            border: 1px solid rgba(169, 112, 255, 0.3);
            color: var(--light);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .notification-btn:hover {
            background: rgba(169, 112, 255, 0.2);
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: var(--light);
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--light);
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        /* ================= AUTH PAGES ================= */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease;
            position: relative;
            z-index: 100;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(169, 112, 255, 0.3);
            border-radius: 10px;
            color: var(--light);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(169, 112, 255, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--light);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(169, 112, 255, 0.3);
        }

        .auth-footer {
            margin-top: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .auth-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        /* ================= DASHBOARD LAYOUT ================= */
        .wrapper {
            display: flex;
            min-height: 100vh;
            padding-top: 70px;
        }

        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 20px;
            position: fixed;
            height: calc(100vh - 70px);
            overflow-y: auto;
            border-right: 1px solid var(--border);
            transition: transform 0.3s ease;
            z-index: 999;
        }

        .sidebar h3 {
            color: var(--primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 30px 0 15px 0;
            padding-left: 10px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .sidebar li:hover {
            background: rgba(169, 112, 255, 0.1);
            color: var(--primary);
        }

        .sidebar li.active {
            background: rgba(169, 112, 255, 0.2);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        .sidebar li.logout {
            color: var(--danger);
            margin-top: 30px;
        }

        .sidebar li.logout:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        .main {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
            overflow-y: auto;
        }

        /* ================= MOBILE OVERLAY ================= */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* ================= USER INFO ================= */
        .user-info {
            background: linear-gradient(135deg, rgba(169, 112, 255, 0.1), rgba(255, 107, 157, 0.1));
            border-radius: 20px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .user-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .user-details {
            flex: 1;
        }

        .user-details h3 {
            font-size: 22px;
            margin-bottom: 5px;
            color: var(--light);
        }

        .user-details p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 5px 0;
        }

        .user-status {
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* ================= BALANCE STRIP ================= */
        .balance-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .strip {
            background: linear-gradient(135deg, rgba(169, 112, 255, 0.2), rgba(255, 107, 157, 0.2));
            border-radius: 20px;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s;
        }

        .strip:hover {
            transform: translateY(-5px);
        }

        .strip.purple {
            background: linear-gradient(135deg, rgba(169, 112, 255, 0.2), rgba(109, 33, 255, 0.2));
        }

        .strip.green {
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(39, 174, 96, 0.2));
        }

        .strip-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .strip-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--light);
        }

        .strip-icon {
            font-size: 40px;
            opacity: 0.3;
        }

        /* ================= SUMMARY BOXES ================= */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(169, 112, 255, 0.1);
            position: relative;
            transition: transform 0.3s;
        }

        .box:hover {
            transform: translateY(-5px);
            border-color: rgba(169, 112, 255, 0.3);
        }

        .live-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .box h4 {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        .box p {
            font-size: 32px;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 15px;
        }

        .box-trend {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ================= PACKAGES ================= */
        .packages-section {
            margin-bottom: 40px;
        }

        .section-title {
            color: var(--primary);
            font-size: 22px;
            margin-bottom: 20px;
        }

        .packages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .pkg {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(169, 112, 255, 0.1);
            position: relative;
            transition: all 0.3s;
        }

        .pkg:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(169, 112, 255, 0.1);
        }

        .pkg h3 {
            color: var(--primary);
            font-size: 20px;
            margin-bottom: 15px;
        }

        .pkg-price {
            font-size: 32px;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 20px;
        }

        .pkg-features {
            list-style: none;
            margin-bottom: 25px;
        }

        .pkg-features li {
            padding: 8px 0;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .pkg-features li i {
            color: var(--success);
            font-size: 14px;
        }

        .pkg-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .pkg-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(169, 112, 255, 0.3);
        }

        .pkg-btn.disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(45deg, var(--secondary), var(--danger);
            color: var(--light);
            padding: 5px 15px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ================= AFFILIATE SECTION ================= */
        .affiliate {
            background: rgba(169, 112, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .affiliate h3 {
            color: var(--primary);
            font-size: 20px;
            margin-bottom: 20px;
        }

        .referral-link {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .referral-link input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(169, 112, 255, 0.3);
            border-radius: 10px;
            color: var(--light);
            font-size: 14px;
        }

        .copy-btn {
            padding: 12px 25px;
            background: rgba(169, 112, 255, 0.2);
            border: 1px solid rgba(169, 112, 255, 0.4);
            border-radius: 10px;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .copy-btn:hover {
            background: rgba(169, 112, 255, 0.3);
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            color: var(--light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .share-btn.telegram {
            background: #0088cc;
        }

        .share-btn.whatsapp {
            background: #25D366;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* ================= PAGES ================= */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h2 {
            font-size: 28px;
            color: var(--light);
            margin-bottom: 10px;
        }

        .page-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .page-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
        }

        /* ================= FORM STYLES ================= */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--light);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(169, 112, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #ff3838);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #1dd1a1);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #ffb142);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }

        /* ================= TABLE STYLES ================= */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        table th {
            background: rgba(169, 112, 255, 0.1);
            padding: 15px;
            text-align: left;
            color: var(--primary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }

        table tr:hover {
            background: rgba(169, 112, 255, 0.05);
        }

        .status-active {
            color: var(--success);
            background: rgba(46, 213, 115, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            color: var(--warning);
            background: rgba(255, 165, 2, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-rejected {
            color: var(--danger);
            background: rgba(255, 71, 87, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-blocked {
            color: var(--danger);
            background: rgba(255, 71, 87, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-expired {
            color: var(--gray);
            background: rgba(138, 138, 138, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        /* ================= STATS CARD ================= */
        .stats-card {
            background: rgba(169, 112, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ================= PAYMENT METHOD ================= */
        .payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(169, 112, 255, 0.1);
        }

        .payment-method:hover {
            background: rgba(169, 112, 255, 0.05);
        }

        .payment-icon {
            width: 50px;
            height: 50px;
            background: rgba(169, 112, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
        }

        .payment-info h4 {
            color: var(--light);
            margin-bottom: 5px;
            font-size: 16px;
        }

        .payment-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        /* ================= MODAL STYLES ================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 90%;
            width: 500px;
            border: 1px solid var(--border);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 30px;
            cursor: pointer;
            transition: color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* ================= TASK STYLES ================= */
        .task-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .task-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .task-header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .task-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .task-stat-box {
            text-align: center;
            padding: 20px;
            background: rgba(169, 112, 255, 0.1);
            border-radius: 15px;
        }

        .task-stat-box h3 {
            font-size: 36px;
            color: var(--light);
            margin-bottom: 5px;
        }

        .task-stat-box p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .task-click-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            color: var(--light);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s;
        }

        .task-click-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(169, 112, 255, 0.4);
        }

        .task-click-button:active {
            transform: scale(0.95);
        }

        .task-click-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .task-progress {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
        }

        .task-progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s ease;
        }

        /* ================= FOOTER INFO ================= */
        .footer-info {
            background: rgba(169, 112, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid var(--border);
        }

        .footer-info p {
            margin: 10px 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .footer-info a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer-info a:hover {
            text-decoration: underline;
        }

        /* ================= ADMIN STYLES ================= */
        .admin-sidebar {
            background: rgba(0, 0, 0, 0.95);
        }

        .admin-alert {
            background: rgba(169, 112, 255, 0.1);
            border: 1px solid rgba(169, 112, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-alert i {
            color: var(--primary);
            font-size: 20px;
            margin-top: 2px;
        }

        /* ================= QR CODE STYLES ================= */
        .qr-container {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            margin: 20px 0;
        }

        .qr-code-display {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            background: var(--light);
            padding: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-code-display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .qr-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .qr-upload-btn, .qr-remove-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .qr-upload-btn {
            background: rgba(169, 112, 255, 0.2);
            color: var(--primary);
            border: 1px solid rgba(169, 112, 255, 0.4);
        }

        .qr-remove-btn {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 71, 87, 0.4);
        }

        .qr-upload-btn:hover {
            background: rgba(169, 112, 255, 0.3);
        }

        .qr-remove-btn:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        /* ================= FILE UPLOAD ================= */
        .file-upload {
            border: 2px dashed rgba(169, 112, 255, 0.3);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(169, 112, 255, 0.05);
        }

        .file-upload i {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* ================= NOTIFICATION POPUP ================= */
        .notification-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            width: 350px;
            max-width: 90%;
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .notification-header h4 {
            color: var(--primary);
            font-size: 16px;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }

        .notification-item.unread {
            border-left-color: var(--danger);
            background: rgba(255, 71, 87, 0.1);
        }

        .notification-item p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ================= SUCCESS POPUP ================= */
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid var(--success);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            z-index: 100000;
            text-align: center;
            display: none;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .success-icon {
            font-size: 60px;
            color: var(--success);
            margin-bottom: 20px;
        }

        .success-popup h3 {
            color: var(--light);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .success-popup p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .credentials-box {
            background: rgba(169, 112, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .credential-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .credential-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .credential-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .credential-value {
            color: var(--light);
            font-weight: 600;
            font-family: monospace;
        }

        .copy-credentials-btn {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--light);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* ================= RESPONSIVE STYLES ================= */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main {
                margin-left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .packages {
                grid-template-columns: 1fr;
            }
            
            .balance-strip {
                grid-template-columns: 1fr;
            }
            
            .summary {
                grid-template-columns: 1fr;
            }
            
            .auth-box {
                padding: 30px 20px;
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .logo-tagline {
                display: none;
            }
            
            .main {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .notification-popup {
                width: 90%;
                right: 5%;
                bottom: 10px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
            }
            
            .user-details {
                text-align: center;
            }
            
            .task-click-button {
                width: 150px;
                height: 150px;
            }
        }

        @media (max-width: 480px) {
            .auth-box {
                padding: 25px 15px;
            }
            
            .header {
                padding: 10px 15px;
            }
            
            .main {
                padding: 15px;
            }
            
            .strip-amount {
                font-size: 24px;
            }
            
            .box p {
                font-size: 24px;
            }
            
            .pkg-price {
                font-size: 24px;
            }
            
            .share-buttons {
                flex-direction: column;
            }
            
            .share-btn {
                width: 100%;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
            
            .task-click-button {
                width: 120px;
                height: 120px;
                font-size: 18px;
            }
        }

        /* ================= SCROLLBAR ================= */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(169, 112, 255, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(169, 112, 255, 0.7);
        }

        /* ================= UTILITY CLASSES ================= */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-success {
            color: var(--success);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-info {
            color: var(--info);
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        /* ================= ANIMATIONS ================= */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .blink {
            animation: blink 1s infinite;
        }
        
        /* ================= REAL-TIME BADGE ================= */
        .realtime-badge {
            animation: blink 1s infinite;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
<!-- ================= LOADING ================= -->
<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-size: 16px;">Loading Platform...</p>
</div>

<!-- ================= HEADER ================= -->
<div class="header">
    <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <div class="logo">CapitalRise</div>
            <div class="logo-tagline">Professional Trading Platform</div>
        </div>
    </div>
    
    <div class="header-right">
        <button class="notification-btn" onclick="toggleNotifications()" id="notificationBtn">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount">0</span>
        </button>
    </div>
</div>

<!-- ================= MOBILE OVERLAY ================= -->
<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

<!-- ================= NOTIFICATION POPUP ================= -->
<div class="notification-popup" id="notificationPopup">
    <div class="notification-header">
        <h4>Notifications</h4>
        <button class="close-modal" onclick="toggleNotifications()">&times;</button>
    </div>
    <div class="notification-list" id="notificationList">
        <!-- Notifications will be loaded here -->
    </div>
</div>

<!-- ================= SUCCESS POPUP ================= -->
<div class="success-popup" id="successPopup">
    <div class="success-icon">
        <i class="fas fa-check-circle"></i>
    </div>
    <h3>Registration Successful!</h3>
    <p>Your account has been created successfully.</p>
    <p>Please save your login credentials:</p>
    
    <div class="credentials-box">
        <div class="credential-item">
            <span class="credential-label">User ID:</span>
            <span class="credential-value" id="popupUserId">CR000001</span>
        </div>
        <div class="credential-item">
            <span class="credential-label">Email:</span>
            <span class="credential-value" id="popupUserEmail">user@example.com</span>
        </div>
        <div class="credential-item">
            <span class="credential-label">Password:</span>
            <span class="credential-value" id="popupUserPassword">********</span>
        </div>
    </div>
    
    <button class="copy-credentials-btn" onclick="copyCredentials()">
        <i class="fas fa-copy"></i> Copy Credentials
    </button>
</div>

<!-- ================= LOGIN PAGE ================= -->
<div id="loginPage" class="auth-container">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Welcome to CapitalRise</h2>
            <p>Login to access your trading dashboard</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
            </div>
            
            <button class="auth-btn" onclick="loginUser()" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="auth-footer">
                <p>
                    <span class="auth-link" onclick="showForgotPassword()">
                        Forgot Password?
                    </span>
                </p>
                <p style="margin-top: 15px;">
                    Don't have an account? 
                    <span class="auth-link" onclick="showRegister()">Register Now</span>
                </p>
                <p style="margin-top: 15px;">
                    <span class="auth-link" onclick="showAdminLogin()">
                        Admin Login
                    </span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= REGISTER PAGE ================= -->
<div id="registerPage" class="auth-container hidden">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Create Account</h2>
            <p>Join CapitalRise to start trading</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="regFullName">Full Name *</label>
                <input type="text" id="regFullName" class="form-control" placeholder="Enter your full name">
            </div>
            
            <div class="form-group">
                <label for="regEmail">Email Address *</label>
                <input type="email" id="regEmail" class="form-control" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="regMobile">Mobile Number *</label>
                <input type="tel" id="regMobile" class="form-control" placeholder="Enter your mobile number">
            </div>
            
            <div class="form-group">
                <label for="regPassword">Password *</label>
                <input type="password" id="regPassword" class="form-control" placeholder="Create a password (min. 6 characters)">
            </div>
            
            <div class="form-group">
                <label for="regConfirmPassword">Confirm Password *</label>
                <input type="password" id="regConfirmPassword" class="form-control" placeholder="Confirm your password">
            </div>
            
            <div class="form-group">
                <label for="regSponsorID">Sponsor ID (Optional)</label>
                <input type="text" id="regSponsorID" class="form-control" placeholder="Enter sponsor ID if any">
            </div>
            
            <button class="auth-btn" onclick="registerUser()" id="registerBtn">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
            
            <div class="auth-footer">
                <p>
                    Already have an account? 
                    <span class="auth-link" onclick="showLogin()">Login Here</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= ADMIN LOGIN PAGE ================= -->
<div id="adminLoginPage" class="auth-container hidden">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Admin Access</h2>
            <p>Administrator login only</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="adminEmail">Admin Email</label>
                <input type="email" id="adminEmail" class="form-control" placeholder="Enter admin email">
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
            </div>
            
            <button class="auth-btn" onclick="adminLogin()" id="adminLoginBtn">
                <i class="fas fa-lock"></i> Admin Login
            </button>
            
            <div class="auth-footer">
                <p>
                    User Login? 
                    <span class="auth-link" onclick="showLogin()">Click Here</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= USER DASHBOARD ================= -->
<div id="dashboard" class="hidden">
<div class="wrapper">
    <!-- USER SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div>
            <h3>MENU</h3>
            <ul>
                <li class="active" onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</li>
                <li onclick="showPage('activationPage')"><i class="fas fa-bolt"></i> Activation</li>
                <li onclick="showPage('activationHistoryPage')"><i class="fas fa-history"></i> Activation History</li>
            </ul>
            
            <h3>PROFILE</h3>
            <ul>
                <li onclick="showPage('profilePage')"><i class="fas fa-user"></i> Profile</li>
                <li onclick="showPage('kycPage')"><i class="fas fa-id-card"></i> KYC</li>
                <li onclick="showPage('changePasswordPage')"><i class="fas fa-key"></i> Change Password</li>
            </ul>
            
            <h3>FUND MANAGEMENT</h3>
            <ul>
                <li onclick="showPage('addFundPage')"><i class="fas fa-plus-circle"></i> Add Fund</li>
                <li onclick="showPage('fundReportPage')"><i class="fas fa-file-alt"></i> Fund Report</li>
            </ul>
            
            <h3>EARNINGS</h3>
            <ul>
                <li onclick="showPage('referralIncomePage')"><i class="fas fa-users"></i> Referral Income</li>
                <li onclick="showPage('roiIncomePage')"><i class="fas fa-percentage"></i> ROI Income</li>
                <li onclick="showPage('taskPage')"><i class="fas fa-tasks"></i> Task</li>
            </ul>
            
            <h3>WALLET</h3>
            <ul>
                <li onclick="showPage('withdrawalPage')"><i class="fas fa-wallet"></i> Withdrawal</li>
                <li onclick="showPage('withdrawalReportPage')"><i class="fas fa-file-invoice-dollar"></i> Withdrawal Report</li>
                <li class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </div>
    </div>

    <!-- USER MAIN CONTENT -->
    <div class="main">
        <!-- Dashboard Page -->
        <div class="page active" id="dashboardPage">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h3 id="userName">Loading...</h3>
                    <p>ID: <span id="userId" class="text-info">CR000001</span>  Join Date: <span id="joinDate">01/01/2024</span></p>
                    <p>Referrals: <strong id="referralCount" class="text-success">0</strong>  Rank: <strong id="userRank" class="text-warning">Beginner</strong></p>
                </div>
                <div class="user-status" id="userStatusBadge">Active</div>
            </div>

            <div class="balance-strip">
                <div class="strip purple">
                    <div>
                        <div class="strip-label">Available Balance</div>
                        <div class="strip-amount" id="userBalance">0</div>
                    </div>
                    <i class="fas fa-wallet strip-icon"></i>
                </div>
                <div class="strip green">
                    <div>
                        <div class="strip-label">Active Fund</div>
                        <div class="strip-amount" id="userFund">0</div>
                    </div>
                    <i class="fas fa-chart-line strip-icon"></i>
                </div>
            </div>

            <div class="summary">
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Total Income</h4>
                    <p id="totalIncome">0</p>
                    <div class="box-trend"><i class="fas fa-arrow-up"></i> <span id="todayIncome">0</span> Today</div>
                </div>
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Today's Income</h4>
                    <p id="todayIncomeAmount">0</p>
                    <div class="box-trend"><i class="fas fa-sync"></i> Updated Now</div>
                </div>
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Referral Income</h4>
                    <p id="referralIncome">0</p>
                    <div class="box-trend"><i class="fas fa-users"></i> <span id="activeReferrals">0</span> Active</div>
                </div>
                <div class="box">
                    <span class="live-badge">Live</span>
                    <h4>Total Tasks</h4>
                    <p id="totalTasks">0</p>
                    <div class="box-trend"><i class="fas fa-tasks"></i> <span id="completedTasks">0</span> Completed</div>
                </div>
            </div>

            <div class="packages-section">
                <h3 class="section-title">Investment Packages</h3>
                <div class="packages" id="packagesContainer">
                    <!-- Packages will be loaded dynamically -->
                </div>
            </div>

            <div class="affiliate">
                <h3>Affiliate Program</h3>
                <p class="mb-20">
                    <i class="fas fa-hand-point-right"></i> Your Referral Link - Earn 10% commission on every successful referral
                </p>
                <div class="referral-link">
                    <input type="text" id="refLink" value="https://capitalrise.com/register?ref=USER0001" readonly>
                    <button class="copy-btn" onclick="copyReferralLink()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="share-buttons mt-20">
                    <button class="share-btn telegram" onclick="shareOnTelegram()">
                        <i class="fab fa-telegram"></i> Telegram
                    </button>
                    <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>
            
            <div class="footer-info">
                <p><strong><i class="fas fa-info-circle"></i> Withdrawal Information:</strong> Minimum: 200 | Processing: 24-48 hours | Fee: 5%</p>
                <p><strong><i class="fas fa-bullhorn"></i> Join our Official Telegram Channel:</strong> <a href="https://t.me/CapitalRise" target="_blank">@CapitalRise</a></p>
                <p><strong><i class="fas fa-headset"></i> 24/7 Support:</strong> <a href="tel:+919876543210">+91 98765 43210</a></p>
            </div>
        </div>

        <!-- Activation Page -->
        <div class="page" id="activationPage">
            <div class="page-header">
                <h2>Account Activation</h2>
                <p>Activate your trading account with a package</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:20px;">Current Account Status</h3>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="currentPackage">None</div>
                            <div class="stat-label">Active Package</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activationFund">0</div>
                            <div class="stat-label">Activated Fund</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activationStatus" class="status-active">Inactive</div>
                            <div class="stat-label">Account Status</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Select Package to Activate</h3>
                
                <div class="packages" id="activationPackages">
                    <!-- Activation packages will be loaded here -->
                </div>
                
                <div id="activationMessage" class="hidden" style="background: rgba(46, 213, 115, 0.1); padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid rgba(46, 213, 115, 0.3);">
                    <i class="fas fa-check-circle text-success"></i> 
                    <span id="activationMessageText"></span>
                </div>
            </div>
        </div>

        <!-- Activation History Page -->
        <div class="page" id="activationHistoryPage">
            <div class="page-header">
                <h2>Activation History</h2>
                <p>View your package activation history</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalActivations">0</div>
                        <div class="stat-label">Total Activations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalInvestment">0</div>
                        <div class="stat-label">Total Investment</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activePackages">0</div>
                        <div class="stat-label">Active Packages</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Validity Till</th>
                                <th>Daily Income</th>
                            </tr>
                        </thead>
                        <tbody id="activationHistoryTable">
                            <tr><td colspan="6" class="text-center">No activation history found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
            <div class="page-header">
                <h2>Profile Information</h2>
                <p>View and manage your account details</p>
            </div>
            
            <div class="page-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="profileUserId" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="text" id="profileMobile" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Join Date</label>
                        <input type="text" id="profileJoinDate" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Account Status</label>
                        <input type="text" id="profileStatus" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Active Package</label>
                        <input type="text" id="profilePackage" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>KYC Status</label>
                        <input type="text" id="profileKYC" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Referral Link</label>
                    <input type="text" id="profileRefLink" class="form-control" readonly>
                </div>
            </div>
        </div>

        <!-- KYC Page -->
        <div class="page" id="kycPage">
            <div class="page-header">
                <h2>KYC Verification</h2>
                <p>Complete KYC for full account access</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:15px;">KYC Status: <span id="kycStatusText" class="text-warning">Pending</span></h3>
                    <p>Complete KYC to enable withdrawals and access all features. KYC verification typically takes 24-48 hours.</p>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Personal Information</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name (as per Aadhar)</label>
                        <input type="text" id="kycName" class="form-control" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="kycDob" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Aadhar Card Number</label>
                        <input type="text" id="kycAadhar" class="form-control" placeholder="Enter 12-digit Aadhar Number" maxlength="12">
                    </div>
                    <div class="form-group">
                        <label>PAN Card Number</label>
                        <input type="text" id="kycPan" class="form-control" placeholder="Enter PAN Card Number" maxlength="10">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Bank Account Number</label>
                        <input type="text" id="kycAccountNumber" class="form-control" placeholder="Enter Bank Account Number">
                    </div>
                    <div class="form-group">
                        <label>IFSC Code</label>
                        <input type="text" id="kycIfscCode" class="form-control" placeholder="Enter IFSC Code">
                    </div>
                </div>

                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="kycBankName" class="form-control" placeholder="Enter Bank Name">
                </div>
                
                <div class="form-group mt-30">
                    <button class="btn" onclick="submitKYC()" id="kycSubmitBtn">
                        <i class="fas fa-paper-plane"></i> Submit KYC
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Fund Page -->
        <div class="page" id="addFundPage">
            <div class="page-header">
                <h2>Add Fund</h2>
                <p>Add funds to your wallet</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="walletBalance">0</div>
                            <div class="stat-label">Current Balance</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalAdded">0</div>
                            <div class="stat-label">Total Added</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="lastAdded">0</div>
                            <div class="stat-label">Last Added</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Add Funds</h3>
                
                <div class="form-group">
                    <label>Amount to Add ()</label>
                    <input type="number" id="fundAmount" class="form-control" placeholder="Enter amount" min="100" step="100">
                    <p style="font-size:12px; color:rgba(255,255,255,0.5); margin-top:5px;">Minimum amount: 100</p>
                </div>
                
                <h4 style="color: var(--primary); margin:25px 0 15px;">Payment Method</h4>
                
                <div class="payment-method selected" onclick="selectPaymentMethod('qr')">
                    <div class="payment-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="payment-info">
                        <h4>QR Code Payment</h4>
                        <p>Scan QR code to pay</p>
                    </div>
                    <i class="fas fa-check-circle" style="color: var(--success); font-size:20px;"></i>
                </div>
                
                <div id="qrPaymentDetails" style="background:rgba(169,112,255,0.1); padding:20px; border-radius:12px; margin:20px 0; display:block;">
                    <h4 style="color: var(--primary); margin-bottom:15px;">Scan QR Code to Pay:</h4>
                    <div class="qr-container">
                        <div class="qr-code-display" id="qrCodeDisplay">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise%40ybl&format=png" alt="QR Code" id="qrCodeImage">
                        </div>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">Scan this QR code with your UPI app to pay</p>
                        <p><strong>UPI ID:</strong> capitalrise@ybl</p>
                    </div>
                    
                    <div class="form-group">
                        <label>UPI Transaction ID (Mandatory)</label>
                        <input type="text" id="userUpiTransactionId" class="form-control" placeholder="Enter UPI transaction reference number">
                    </div>
                    
                    <div class="form-group">
                        <label>Amount Paid ()</label>
                        <input type="number" id="paidAmount" class="form-control" placeholder="Enter amount you paid">
                    </div>
                </div>
                
                <div style="text-align:center">
                    <button class="btn" onclick="processPayment()" id="paymentBtn">
                        <i class="fas fa-credit-card"></i> Submit Payment Request
                    </button>
                </div>
            </div>
        </div>

        <!-- Fund Report Page -->
        <div class="page" id="fundReportPage">
            <div class="page-header">
                <h2>Fund Report</h2>
                <p>View your fund transaction history</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDeposits">0</div>
                        <div class="stat-label">Total Deposits</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalWithdrawals">0</div>
                        <div class="stat-label">Total Withdrawals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="netBalance">0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Transaction ID</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="fundReportTable">
                            <tr><td colspan="6" class="text-center">No transactions found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Referral Income Page -->
        <div class="page" id="referralIncomePage">
            <div class="page-header">
                <h2>Referral Income</h2>
                <p>View your referral commission income</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeReferralsCount">0</div>
                        <div class="stat-label">Active Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferralIncome">0</div>
                        <div class="stat-label">Total Referral Income</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Referral ID</th>
                                <th>Name</th>
                                <th>Package</th>
                                <th>Commission</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="referralIncomeTable">
                            <tr><td colspan="7" class="text-center">No referral income found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ROI Income Page -->
        <div class="page" id="roiIncomePage">
            <div class="page-header">
                <h2>ROI Income</h2>
                <p>View your return on investment income</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="totalROI">0</div>
                        <div class="stat-label">Total ROI Income</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayROI">0</div>
                        <div class="stat-label">Today's ROI</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeInvestments">0</div>
                        <div class="stat-label">Active Investments</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Package</th>
                                <th>Investment</th>
                                <th>ROI %</th>
                                <th>Daily Income</th>
                                <th>Total Income</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="roiIncomeTable">
                            <tr><td colspan="7" class="text-center">No ROI income found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdrawal Page -->
        <div class="page" id="withdrawalPage">
            <div class="page-header">
                <h2>Withdrawal</h2>
                <p>Withdraw your earnings to bank/UPI</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:15px;">Withdrawal Information</h3>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="withdrawBalance">0</div>
                            <div class="stat-label">Available Balance</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withdrawPending">0</div>
                            <div class="stat-label">Pending Withdrawals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withdrawTotal">0</div>
                            <div class="stat-label">Total Withdrawn</div>
                        </div>
                    </div>
                    <p style="margin-top:15px; font-size:14px; color:rgba(255,255,255,0.7);">
                        <i class="fas fa-info-circle"></i> Minimum withdrawal: 200 | Processing time: 24-48 hours | Fee: 5%
                    </p>
                </div>
                
                <h3 style="color: var(--primary); margin:30px 0 20px;">Request Withdrawal</h3>
                
                <div class="form-group">
                    <label>Withdrawal Amount ()</label>
                    <input type="number" id="withdrawAmount" class="form-control" placeholder="Enter amount" min="200" step="100">
                </div>
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="withdrawMethod" class="form-control">
                        <option value="bank">Bank Transfer</option>
                        <option value="upi">UPI</option>
                    </select>
                </div>
                
                <div id="bankDetailsSection" style="display:block;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bank Name</label>
                            <input type="text" id="bankName" class="form-control" placeholder="Enter bank name">
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" id="accountNumber" class="form-control" placeholder="Enter account number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>IFSC Code</label>
                            <input type="text" id="ifscCodeInput" class="form-control" placeholder="Enter IFSC code">
                        </div>
                        <div class="form-group">
                            <label>Account Holder Name</label>
                            <input type="text" id="accountHolder" class="form-control" placeholder="Enter account holder name">
                        </div>
                    </div>
                </div>
                
                <div id="upiDetailsSection" style="display:none;">
                    <div class="form-group">
                        <label>UPI ID</label>
                        <input type="text" id="upiIdInput" class="form-control" placeholder="Enter UPI ID">
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:30px">
                    <button class="btn" onclick="processWithdrawal()" id="withdrawBtn">
                        <i class="fas fa-money-check-alt"></i> Request Withdrawal
                    </button>
                </div>
            </div>
        </div>

        <!-- Withdrawal Report Page -->
        <div class="page" id="withdrawalReportPage">
            <div class="page-header">
                <h2>Withdrawal Report</h2>
                <p>View your withdrawal history</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="withdrawalRequests">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="withdrawalApproved">0</div>
                        <div class="stat-label">Approved Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="withdrawalPending">0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request Date</th>
                                <th>Request ID</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Processed Date</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalReportTable">
                            <tr><td colspan="6" class="text-center">No withdrawal requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Task Page -->
        <div class="page" id="taskPage">
            <div class="page-header">
                <h2>Daily Tasks - Click Challenge</h2>
                <p>Complete tasks to earn daily income</p>
            </div>
            
            <div class="page-content">
                <div class="stats-card">
                    <h3 style="color: var(--primary); margin-bottom:15px;">Task Information</h3>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="taskDailyIncome">0</div>
                            <div class="stat-label">Daily Income</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="taskPerClick">0</div>
                            <div class="stat-label">Per Click Income</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="taskCompletedToday">0/15</div>
                            <div class="stat-label">Today's Progress</div>
                        </div>
                    </div>
                </div>
                
                <div class="task-container">
                    <div class="task-header">
                        <h1>Daily Tasks</h1>
                        <p>Complete 15 clicks daily to earn 5% of your investment</p>
                    </div>
                    
                    <div class="task-stats">
                        <div class="task-stat-box">
                            <h3 id="task-completed-count">0</h3>
                            <p>Tasks Completed</p>
                        </div>
                        <div class="task-stat-box">
                            <h3 id="task-pending-count">15</h3>
                            <p>Clicks Pending</p>
                        </div>
                    </div>
                    
                    <button class="task-click-button" id="task-click-button" onclick="completeTask()">
                        Click Here
                    </button>
                    
                    <div class="task-progress" id="task-progress-text">Progress: 0/15 clicks</div>
                    
                    <div class="task-progress-bar">
                        <div class="task-progress-fill" id="task-progress-fill"></div>
                    </div>
                    
                    <div id="taskMessage" style="margin-top: 20px; padding: 15px; border-radius: 10px; background: rgba(46, 213, 115, 0.1); border: 1px solid rgba(46, 213, 115, 0.3); display: none;">
                        <i class="fas fa-check-circle text-success"></i> 
                        <span id="taskMessageText"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Page -->
        <div class="page" id="changePasswordPage">
            <div class="page-header">
                <h2>Change Password</h2>
                <p>Update your account password</p>
            </div>
            
            <div class="page-content">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
                </div>
                
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                    <p style="font-size:12px; color:rgba(255,255,255,0.5); margin-top:5px;">Password must be at least 6 characters</p>
                </div>
                
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                </div>
                
                <div style="text-align:center; margin-top:30px">
                    <button class="btn" onclick="changePassword()" id="changePasswordBtn">
                        <i class="fas fa-key"></i> Update Password
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
</div>

<!-- ================= ADMIN DASHBOARD ================= -->
<div id="adminDashboard" class="hidden">
<div class="wrapper">
    <!-- ADMIN SIDEBAR -->
    <div class="sidebar admin-sidebar" id="adminSidebar">
        <div>
            <h3>ADMIN MENU</h3>
            <ul>
                <li class="active" onclick="showAdminPage('adminDashboardPage')"><i class="fas fa-tachometer-alt"></i> Dashboard <span id="dashboardBadge" class="realtime-badge">0</span></li>
                <li onclick="showAdminPage('adminUsersPage')"><i class="fas fa-users"></i> All Users</li>
                <li onclick="showAdminPage('adminDepositsPage')"><i class="fas fa-money-bill-wave"></i> Deposit Requests <span id="depositBadge" class="realtime-badge">0</span></li>
                <li onclick="showAdminPage('adminWithdrawalsPage')"><i class="fas fa-wallet"></i> Withdrawal Requests <span id="withdrawalBadge" class="realtime-badge">0</span></li>
                <li onclick="showAdminPage('adminPackageRequestsPage')"><i class="fas fa-box"></i> Package Requests <span id="packageBadge" class="realtime-badge">0</span></li>
                <li onclick="showAdminPage('adminKYCVerificationPage')"><i class="fas fa-id-card"></i> KYC Verification <span id="kycBadge" class="realtime-badge">0</span></li>
                <li onclick="showAdminPage('adminTransactionsPage')"><i class="fas fa-exchange-alt"></i> All Transactions</li>
                <li onclick="showAdminPage('adminSettingsPage')"><i class="fas fa-cog"></i> Settings</li>
                <li class="logout" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </div>
    </div>

    <!-- ADMIN MAIN CONTENT -->
    <div class="main">
        <!-- Admin Dashboard Page -->
        <div class="page active" id="adminDashboardPage">
            <div class="page-header">
                <h2>Admin Dashboard</h2>
                <p>Welcome to CapitalRise Admin Panel</p>
            </div>

            <div class="admin-alert">
                <i class="fas fa-bell"></i>
                <div>
                    <p><strong>Real-time Updates:</strong> All requests appear instantly. Click menu items with red badges to see pending requests.</p>
                </div>
            </div>

            <div class="summary">
                <div class="box">
                    <h4>Total Users</h4>
                    <p id="adminTotalUsers">0</p>
                    <div class="box-trend"><i class="fas fa-user-plus"></i> Today: <span id="adminTodayUsers">0</span></div>
                </div>
                <div class="box">
                    <h4>Active Users</h4>
                    <p id="adminActiveUsers">0</p>
                    <div class="box-trend"><i class="fas fa-chart-line"></i> Active Today: <span id="adminActiveToday">0</span></div>
                </div>
                <div class="box">
                    <h4>Total Deposits</h4>
                    <p id="adminTotalDeposits">0</p>
                    <div class="box-trend"><i class="fas fa-arrow-up"></i> Today: <span id="adminTodayDeposits">0</span></div>
                </div>
                <div class="box">
                    <h4>Total Withdrawals</h4>
                    <p id="adminTotalWithdrawals">0</p>
                    <div class="box-trend"><i class="fas fa-arrow-down"></i> Pending: <span id="adminPendingWithdrawals">0</span></div>
                </div>
            </div>

            <div class="summary">
                <div class="box">
                    <h4>Total Investments</h4>
                    <p id="adminTotalInvestments">0</p>
                    <div class="box-trend"><i class="fas fa-percentage"></i> Active ROI</div>
                </div>
                <div class="box">
                    <h4>Pending Requests</h4>
                    <p id="adminPendingRequests">0</p>
                    <div class="box-trend"><i class="fas fa-clock"></i> Need Approval</div>
                </div>
                <div class="box">
                    <h4>Total Commission</h4>
                    <p id="adminTotalCommission">0</p>
                    <div class="box-trend"><i class="fas fa-users"></i> From Referrals</div>
                </div>
                <div class="box">
                    <h4>Platform Balance</h4>
                    <p id="adminPlatformBalance">0</p>
                    <div class="box-trend"><i class="fas fa-coins"></i> Net Profit</div>
                </div>
            </div>

            <div class="stats-card">
                <h3 style="color: var(--primary); margin-bottom:20px;">Recent Activity</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User ID</th>
                                <th>Action</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="adminRecentActivity">
                            <tr><td colspan="6" class="text-center">No recent activity</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Users Page -->
        <div class="page" id="adminUsersPage">
            <div class="page-header">
                <h2>All Users</h2>
                <p>Manage all registered users</p>
            </div>
            
            <div class="page-content">
                <div class="d-flex justify-between align-center mb-20" style="flex-wrap: wrap; gap: 15px;">
                    <button class="btn" onclick="showAddUserModal()">
                        <i class="fas fa-user-plus"></i> Add New User
                    </button>
                    <div class="d-flex gap-10" style="flex-wrap: wrap;">
                        <input type="text" id="searchUser" class="form-control" placeholder="Search by User ID or Name" style="min-width:200px; flex:1;">
                        <button class="btn" onclick="searchUsers()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Active Packages</th>
                                <th>Status</th>
                                <th>KYC</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTable">
                            <tr><td colspan="9" class="text-center">No users found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Deposit Requests Page -->
        <div class="page" id="adminDepositsPage">
            <div class="page-header">
                <h2>Deposit Requests <span id="depositCounter" class="realtime-badge">0</span></h2>
                <p>Approve or reject user deposit requests instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingDepositsCount">0</div>
                        <div class="stat-label">Pending Deposits</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingDepositsAmount">0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayDepositsCount">0</div>
                        <div class="stat-label">Today's Deposits</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Amount</th>
                                <th>Transaction ID</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminDepositsTable">
                            <tr><td colspan="8" class="text-center">No deposit requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdrawal Requests Page -->
        <div class="page" id="adminWithdrawalsPage">
            <div class="page-header">
                <h2>Withdrawal Requests <span id="withdrawalCounter" class="realtime-badge">0</span></h2>
                <p>Process user withdrawal requests instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingWithdrawalsCount">0</div>
                        <div class="stat-label">Pending Withdrawals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingWithdrawalsAmount">0</div>
                        <div class="stat-label">Pending Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayWithdrawalsCount">0</div>
                        <div class="stat-label">Today's Withdrawals</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminWithdrawalsTable">
                            <tr><td colspan="8" class="text-center">No withdrawal requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Package Requests Page -->
        <div class="page" id="adminPackageRequestsPage">
            <div class="page-header">
                <h2>Package Requests <span id="packageCounter" class="realtime-badge">0</span></h2>
                <p>Manage package activation requests instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingPackageRequests">0</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalPackageAmount">0</div>
                        <div class="stat-label">Total Amount</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayPackageRequests">0</div>
                        <div class="stat-label">Today's Requests</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminPackageRequestsTable">
                            <tr><td colspan="8" class="text-center">No package requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- KYC Verification Page -->
        <div class="page" id="adminKYCVerificationPage">
            <div class="page-header">
                <h2>KYC Verification <span id="kycCounter" class="realtime-badge">0</span></h2>
                <p>Verify user KYC documents instantly</p>
            </div>
            
            <div class="page-content">
                <div class="stats-row mb-30">
                    <div class="stat-item">
                        <div class="stat-value" id="pendingKYC">0</div>
                        <div class="stat-label">Pending KYC</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="verifiedKYC">0</div>
                        <div class="stat-label">Verified</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="rejectedKYC">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Aadhar</th>
                                <th>PAN</th>
                                <th>Bank Account</th>
                                <th>IFSC Code</th>
                                <th>Submitted Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminKYCTable">
                            <tr><td colspan="9" class="text-center">No KYC requests found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Transactions Page -->
        <div class="page" id="adminTransactionsPage">
            <div class="page-header">
                <h2>All Transactions</h2>
                <p>View all platform transactions</p>
            </div>
            
            <div class="page-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="transactionFromDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="transactionToDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transactionType" class="form-control">
                            <option value="">All</option>
                            <option value="deposit">Deposit</option>
                            <option value="withdrawal">Withdrawal</option>
                            <option value="package">Package</option>
                            <option value="commission">Commission</option>
                            <option value="task">Task Income</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="filterTransactions()" style="margin-bottom:20px;">
                    <i class="fas fa-filter"></i> Filter
                </button>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>User ID</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminTransactionsTable">
                            <tr><td colspan="7" class="text-center">No transactions found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="adminSettingsPage">
            <div class="page-header">
                <h2>Admin Settings</h2>
                <p>Configure platform settings</p>
            </div>
            
            <div class="page-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Minimum Deposit ()</label>
                        <input type="number" id="minDeposit" class="form-control" value="100" min="100">
                    </div>
                    <div class="form-group">
                        <label>Minimum Withdrawal ()</label>
                        <input type="number" id="minWithdrawal" class="form-control" value="200" min="200">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Withdrawal Fee (%)</label>
                        <input type="number" id="withdrawalFee" class="form-control" value="5" min="0" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Referral Commission (%)</label>
                        <input type="number" id="referralCommission" class="form-control" value="10" min="0" max="50" step="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Daily Task Income (%)</label>
                        <input type="number" id="dailyTaskIncome" class="form-control" value="5" min="1" max="20" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Package Validity (Days)</label>
                        <input type="number" id="packageValidity" class="form-control" value="30" min="7" max="365">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>UPI ID for Payments</label>
                    <input type="text" id="adminUpiId" class="form-control" value="capitalrise@ybl">
                </div>
                
                <div class="form-group">
                    <label>QR Code Image URL</label>
                    <input type="text" id="qrCodeUrl" class="form-control" value="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl" placeholder="Enter QR code image URL">
                    <button class="btn btn-small mt-10" onclick="updateQRCode()" style="width:100%">
                        <i class="fas fa-sync"></i> Update QR Code
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Bank Details</label>
                    <textarea id="bankDetailsText" class="form-control" rows="4">State Bank of India
Account: 123456789012
IFSC: SBIN0001234
Name: CapitalRise Trading</textarea>
                </div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn" onclick="saveAdminSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
</div>

<!-- ================= MODALS ================= -->
<div class="modal" id="addUserModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
        <h3>Add New User</h3>
        
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="newUserName" class="form-control" placeholder="Enter full name">
        </div>
        
        <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="newUserEmail" class="form-control" placeholder="Enter email">
        </div>
        
        <div class="form-group">
            <label>Mobile Number</label>
            <input type="tel" id="newUserMobile" class="form-control" placeholder="Enter mobile number">
        </div>
        
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="newUserPassword" class="form-control" placeholder="Enter password">
        </div>
        
        <div class="form-group">
            <label>Initial Balance ()</label>
            <input type="number" id="newUserBalance" class="form-control" placeholder="Enter initial balance" value="50">
        </div>
        
        <button class="btn" onclick="createNewUser()" style="width: 100%; margin-top: 20px;">
            <i class="fas fa-user-plus"></i> Create User
        </button>
    </div>
</div>

<div class="modal" id="userDetailsModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('userDetailsModal')">&times;</button>
        <h3>User Details</h3>
        <div id="userDetailsContent">
            <!-- User details will be loaded here -->
        </div>
    </div>
</div>

<div class="modal" id="kycDetailsModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('kycDetailsModal')">&times;</button>
        <h3>KYC Details</h3>
        <div id="kycDetailsContent">
            <!-- KYC details will be loaded here -->
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
    apiKey: "AIzaSyA0VLVGdaMZPjMmLkwiwkWS7voiUyVE9LU",
    authDomain: "capitalrise-trading.firebaseapp.com",
    projectId: "capitalrise-trading",
    storageBucket: "capitalrise-trading.firebasestorage.app",
    messagingSenderId: "144434735671",
    appId: "1:144434735671:web:a9be99139cb0b374eeadb2"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ================= GLOBAL VARIABLES =================
let currentUser = null;
let userData = null;
let adminData = null;
let selectedPaymentMethod = 'qr';
let realtimeListeners = [];
let packages = [];

// ================= HELPER FUNCTIONS =================
function $(id) { return document.getElementById(id); }
function show(el) { el.style.display = 'block'; }
function hide(el) { el.style.display = 'none'; }

function generateUserId(uid) {
    return 'CR' + uid.slice(-6).toUpperCase();
}

function formatDate(date) {
    if (!date) return 'N/A';
    if (date.toDate) {
        date = date.toDate();
    }
    return date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function formatDateTime(date) {
    if (!date) return 'N/A';
    if (date.toDate) {
        date = date.toDate();
    }
    return date.toLocaleString('en-IN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatCurrency(amount) {
    return '' + parseFloat(amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
}

// ================= AUTH PAGES MANAGEMENT =================
function showLogin() {
    hideAllPages();
    $('loginPage').classList.remove('hidden');
}

function showRegister() {
    hideAllPages();
    $('registerPage').classList.remove('hidden');
}

function showAdminLogin() {
    hideAllPages();
    $('adminLoginPage').classList.remove('hidden');
}

function showForgotPassword() {
    alert('Please contact admin for password reset.');
}

function hideAllPages() {
    $('loginPage').classList.add('hidden');
    $('registerPage').classList.add('hidden');
    $('adminLoginPage').classList.add('hidden');
    $('dashboard').classList.add('hidden');
    $('adminDashboard').classList.add('hidden');
    hide($('successPopup'));
}

// ================= USER REGISTRATION WITH POPUP =================
async function registerUser() {
    const name = $('regFullName').value.trim();
    const email = $('regEmail').value.trim();
    const mobile = $('regMobile').value.trim();
    const password = $('regPassword').value;
    const confirmPassword = $('regConfirmPassword').value;
    const sponsorId = $('regSponsorID').value.trim() || 'ADMIN';

    // Validation
    if (!name || !email || !mobile || !password) {
        alert('Please fill all required fields');
        return;
    }

    if (password.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
    }

    if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }

    try {
        // Disable register button
        $('registerBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
        $('registerBtn').disabled = true;

        // Create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Generate user ID
        const userId = generateUserId(user.uid);
        
        // Create user document
        const userDoc = {
            uid: user.uid,
            userId: userId,
            name: name,
            email: email,
            mobile: mobile,
            sponsorId: sponsorId,
            balance: 0,
            totalEarnings: 0,
            referralEarnings: 0,
            totalDeposits: 0,
            totalWithdrawals: 0,
            status: 'active',
            kycStatus: 'pending',
            kycSubmitted: false,
            referralCount: 0,
            role: 'user',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('users').doc(user.uid).set(userDoc);

        // Update sponsor's referral count
        if (sponsorId !== 'ADMIN') {
            const sponsorQuery = await db.collection('users').where('userId', '==', sponsorId).get();
            if (!sponsorQuery.empty) {
                const sponsorDoc = sponsorQuery.docs[0];
                await db.collection('users').doc(sponsorDoc.id).update({
                    referralCount: firebase.firestore.FieldValue.increment(1)
                });
            }
        }

        // Show success popup with credentials
        showSuccessPopup(userId, email, password);
        
        // Create notification for admin
        await db.collection('notifications').add({
            type: 'new_user',
            title: 'New User Registered',
            message: `New user ${name} (${userId}) has registered.`,
            userId: 'ADMIN',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

    } catch (error) {
        alert('Registration failed: ' + error.message);
    } finally {
        $('registerBtn').innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
        $('registerBtn').disabled = false;
    }
}

function showSuccessPopup(userId, email, password) {
    $('popupUserId').textContent = userId;
    $('popupUserEmail').textContent = email;
    $('popupUserPassword').textContent = password;
    show($('successPopup'));
}

function copyCredentials() {
    const userId = $('popupUserId').textContent;
    const email = $('popupUserEmail').textContent;
    const password = $('popupUserPassword').textContent;
    
    const text = `User ID: ${userId}\nEmail: ${email}\nPassword: ${password}`;
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Credentials copied to clipboard!');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Credentials copied to clipboard!');
    });
}

// ================= USER LOGIN =================
async function loginUser() {
    const email = $('loginEmail').value.trim();
    const password = $('loginPassword').value;

    if (!email || !password) {
        alert('Please enter email and password');
        return;
    }

    try {
        $('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        $('loginBtn').disabled = true;

        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        alert('Login failed: ' + error.message);
        $('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        $('loginBtn').disabled = false;
    }
}

// ================= ADMIN LOGIN =================
async function adminLogin() {
    const email = $('adminEmail').value.trim();
    const password = $('adminPassword').value;

    if (!email || !password) {
        alert('Please enter admin credentials');
        return;
    }

    try {
        $('adminLoginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        $('adminLoginBtn').disabled = true;

        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        alert('Admin login failed: ' + error.message);
        $('adminLoginBtn').innerHTML = '<i class="fas fa-lock"></i> Admin Login';
        $('adminLoginBtn').disabled = false;
    }
}

// ================= AUTH STATE LISTENER =================
auth.onAuthStateChanged(async (user) => {
    $('loading').style.display = 'none';

    if (user) {
        // Check if user exists in database
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            
            // Update last login
            await db.collection('users').doc(user.uid).update({
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });

            if (userData.role === 'admin') {
                adminData = userData;
                currentUser = user;
                showAdminDashboard();
                loadAdminDashboard();
                startAdminRealTimeUpdates();
                loadPackagesFromDB();
            } else {
                userData.local = userData;
                currentUser = user;
                showUserDashboard();
                loadUserData();
                startUserRealTimeUpdates();
                loadPackagesFromDB();
            }
        } else {
            // User document doesn't exist, sign out
            await auth.signOut();
            showLogin();
        }
    } else {
        showLogin();
    }
});

// ================= USER DASHBOARD =================
function showUserDashboard() {
    hideAllPages();
    $('dashboard').classList.remove('hidden');
}

async function loadUserData() {
    if (!currentUser) return;

    // Get user data
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    userData = userDoc.data();

    // Update UI
    updateUserUI();
    
    // Load packages
    loadPackages();
    
    // Load notifications
    loadNotifications();
    
    // Load activation history
    loadActivationHistory();
    
    // Load fund report
    loadFundReport();
    
    // Load referral income
    loadReferralIncome();
    
    // Load ROI income
    loadROIIncome();
    
    // Load withdrawal report
    loadWithdrawalReport();
    
    // Load task data
    loadTaskData();
}

function updateUserUI() {
    if (!userData) return;

    // User info
    $('userName').textContent = userData.name;
    $('userId').textContent = userData.userId;
    $('userAvatar').textContent = userData.name.charAt(0).toUpperCase();
    $('userBalance').textContent = formatCurrency(userData.balance);
    
    // Calculate active fund from active packages
    calculateActiveFund();
    
    $('referralCount').textContent = userData.referralCount || 0;
    $('userRank').textContent = getRankFromInvestment(userData.totalInvestment || 0);
    
    // Status badge
    const statusBadge = $('userStatusBadge');
    statusBadge.textContent = userData.status === 'active' ? 'Active' : 'Inactive';
    if (userData.status === 'active') {
        statusBadge.style.background = 'rgba(46, 213, 115, 0.2)';
        statusBadge.style.color = '#2ed573';
    } else if (userData.status === 'blocked') {
        statusBadge.style.background = 'rgba(255, 71, 87, 0.2)';
        statusBadge.style.color = '#ff4757';
    } else {
        statusBadge.style.background = 'rgba(255, 165, 2, 0.2)';
        statusBadge.style.color = '#ffa502';
    }

    // Dashboard stats
    $('totalIncome').textContent = formatCurrency(userData.totalEarnings || 0);
    $('todayIncomeAmount').textContent = formatCurrency(calculateTodayIncome());
    $('referralIncome').textContent = formatCurrency(userData.referralEarnings || 0);
    $('activeReferrals').textContent = userData.referralCount || 0;
    
    // Calculate total tasks completed
    calculateTotalTasks();

    // Profile page
    $('profileName').value = userData.name;
    $('profileUserId').value = userData.userId;
    $('profileEmail').value = userData.email;
    $('profileMobile').value = userData.mobile;
    $('profileJoinDate').value = formatDate(userData.createdAt);
    $('profileStatus').value = userData.status.charAt(0).toUpperCase() + userData.status.slice(1);
    $('profileKYC').value = userData.kycStatus || 'pending';
    $('profileRefLink').value = `${window.location.origin}?ref=${userData.userId}`;

    // Activation page
    $('currentPackage').textContent = getActivePackagesCount() > 0 ? `${getActivePackagesCount()} Active` : 'None';
    $('activationStatus').textContent = getActivePackagesCount() > 0 ? 'Active' : 'Inactive';
    $('activationStatus').className = getActivePackagesCount() > 0 ? 'status-active' : 'status-pending';

    // Add fund page
    $('walletBalance').textContent = formatCurrency(userData.balance);
    $('totalAdded').textContent = formatCurrency(userData.totalDeposits || 0);
    
    // Referral link
    $('refLink').value = `${window.location.origin}?ref=${userData.userId}`;
}

async function calculateActiveFund() {
    if (!currentUser) return;
    
    const snapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    let totalFund = 0;
    snapshot.forEach(doc => {
        const pkg = doc.data();
        totalFund += pkg.amount || 0;
    });
    
    $('userFund').textContent = formatCurrency(totalFund);
    $('activationFund').textContent = formatCurrency(totalFund);
}

function getRankFromInvestment(amount) {
    if (amount >= 1000000) return 'King';
    if (amount >= 500000) return 'Crown';
    if (amount >= 100000) return 'Diamond';
    if (amount >= 50000) return 'Platinum';
    if (amount >= 10000) return 'Gold';
    if (amount >= 5000) return 'Silver';
    if (amount >= 1000) return 'Bronze';
    return 'Beginner';
}

async function calculateTodayIncome() {
    if (!currentUser) return 0;
    
    const snapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    let todayIncome = 0;
    snapshot.forEach(doc => {
        const pkg = doc.data();
        todayIncome += (pkg.amount * (pkg.dailyROI || 1.5) / 100);
    });
    
    return todayIncome;
}

async function calculateTotalTasks() {
    if (!currentUser) return;
    
    const today = new Date().toISOString().split('T')[0];
    const tasksSnapshot = await db.collection('tasks')
        .where('userId', '==', currentUser.uid)
        .get();
    
    let totalTasks = 0;
    let completedTasks = 0;
    
    tasksSnapshot.forEach(doc => {
        const task = doc.data();
        totalTasks += 15; // Each day has 15 tasks
        completedTasks += task.clicks || 0;
    });
    
    $('totalTasks').textContent = totalTasks;
    $('completedTasks').textContent = completedTasks;
}

// ================= PACKAGES MANAGEMENT =================
async function loadPackagesFromDB() {
    const snapshot = await db.collection('packages_config').get();
    if (!snapshot.empty) {
        packages = snapshot.docs[0].data().packages || [];
    } else {
        // Default packages
        packages = [
            { id: 1, name: 'BRONZE', price: 1000, color: '#cd7f32', dailyROI: 1.5, validity: 30 },
            { id: 2, name: 'SILVER', price: 5000, color: '#c0c0c0', dailyROI: 1.8, validity: 30 },
            { id: 3, name: 'GOLDEN', price: 10000, color: '#ffd700', dailyROI: 2.0, validity: 30 },
            { id: 4, name: 'PLATINUM', price: 3000, color: '#e5e4e2', dailyROI: 1.6, validity: 30 },
            { id: 5, name: 'DIAMOND', price: 20000, color: '#b9f2ff', dailyROI: 2.2, validity: 30 },
            { id: 6, name: 'CROWN', price: 50000, color: '#8a2be2', dailyROI: 2.5, validity: 30 },
            { id: 7, name: 'LEGEND', price: 70000, color: '#ff6b35', dailyROI: 2.8, validity: 30 },
            { id: 8, name: 'CONQUERER', price: 100000, color: '#4a4e69', dailyROI: 3.0, validity: 30 },
            { id: 9, name: 'CRYSTAL', price: 500000, color: '#00ffff', dailyROI: 3.5, validity: 30 }
        ];
        await db.collection('packages_config').doc('default').set({ packages });
    }
}

async function loadPackages() {
    const packagesContainer = $('packagesContainer');
    const activationPackages = $('activationPackages');
    
    if (!packagesContainer || !activationPackages) return;
    
    packagesContainer.innerHTML = '';
    activationPackages.innerHTML = '';
    
    // Get user's active packages
    const activePackagesSnapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    const activePackageNames = [];
    activePackagesSnapshot.forEach(doc => {
        const pkg = doc.data();
        activePackageNames.push(pkg.name);
    });
    
    packages.forEach(pkg => {
        const isActive = activePackageNames.includes(pkg.name);
        const canActivate = userData && userData.balance >= pkg.price;
        
        const packageHTML = `
            <div class="pkg">
                ${pkg.name === 'SILVER' ? '<span class="badge">Most Popular</span>' : ''}
                <h3 style="color: ${pkg.color}">${pkg.name}</h3>
                <div class="pkg-price">${formatCurrency(pkg.price)}</div>
                <ul class="pkg-features">
                    <li><i class="fas fa-check-circle"></i> Daily ROI: ${pkg.dailyROI}%</li>
                    <li><i class="fas fa-check-circle"></i> Referral Bonus: 10%</li>
                    <li><i class="fas fa-check-circle"></i> Daily Tasks Available</li>
                    <li><i class="fas fa-check-circle"></i> Validity: ${pkg.validity} Days</li>
                    <li><i class="fas fa-check-circle"></i> Total Returns: ${(pkg.dailyROI * pkg.validity).toFixed(1)}%</li>
                </ul>
                <button class="pkg-btn ${isActive ? 'disabled' : (!canActivate ? 'disabled' : '')}" 
                        onclick="${canActivate && !isActive ? `activatePackage(${pkg.id}, '${pkg.name}', ${pkg.price}, ${pkg.dailyROI}, ${pkg.validity})` : ''}"
                        ${isActive || !canActivate ? 'disabled' : ''}>
                    <i class="fas fa-bolt"></i> 
                    ${isActive ? 'Active' : (canActivate ? 'Activate Now' : 'Insufficient Funds')}
                </button>
            </div>
        `;
        
        packagesContainer.innerHTML += packageHTML;
        activationPackages.innerHTML += packageHTML;
    });
}

async function getActivePackagesCount() {
    if (!currentUser) return 0;
    
    const snapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    return snapshot.size;
}

async function activatePackage(packageId, packageName, amount, dailyROI, validity) {
    if (!currentUser || !userData) return;
    
    if (userData.balance < amount) {
        alert('Insufficient balance. Please add funds first.');
        showPage('addFundPage');
        return;
    }
    
    const confirmActivation = confirm(`Activate ${packageName} package for ${formatCurrency(amount)}?\nDaily ROI: ${dailyROI}%\nValidity: ${validity} days\nTotal Investment: ${formatCurrency(amount)}`);
    if (!confirmActivation) return;
    
    try {
        // Calculate expiry date (30 days from now)
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 30); // Fixed 30 days validity
        
        // Deduct amount from balance
        await db.collection('users').doc(currentUser.uid).update({
            balance: firebase.firestore.FieldValue.increment(-amount),
            totalInvestment: firebase.firestore.FieldValue.increment(amount)
        });
        
        // Create package activation
        await db.collection('packages').add({
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            packageId: packageId,
            name: packageName,
            amount: amount,
            dailyROI: dailyROI,
            validity: 30, // Fixed 30 days
            status: 'active',
            activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            expiryDate: expiryDate
        });
        
        // Create notification for admin (REAL-TIME)
        await db.collection('notifications').add({
            type: 'package_activated',
            title: 'Package Activated',
            message: `${userData.name} (${userData.userId}) activated ${packageName} package of ${formatCurrency(amount)}`,
            userId: 'ADMIN',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create transaction record
        await db.collection('transactions').add({
            userId: currentUser.uid,
            type: 'package_activation',
            amount: amount,
            description: `${packageName} Package Activated`,
            status: 'completed',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(` ${packageName} package activated successfully!`);
        
        // Reload user data
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        userData = userDoc.data();
        updateUserUI();
        loadPackages();
        loadActivationHistory();
        
        // Show success message
        $('activationMessage').classList.remove('hidden');
        $('activationMessageText').textContent = `${packageName} package activated successfully!`;
        
    } catch (error) {
        alert('Error activating package: ' + error.message);
    }
}

// ================= PAGE NAVIGATION =================
function showPage(pageId) {
    // Hide all pages
    document.querySelectorAll('#dashboard .page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Show selected page
    $(pageId).classList.add('active');
    
    // Update sidebar active state
    document.querySelectorAll('#dashboard .sidebar li').forEach(item => {
        item.classList.remove('active');
    });
    
    // Find and activate corresponding sidebar item
    const sidebarItems = document.querySelectorAll('#dashboard .sidebar li');
    for (let item of sidebarItems) {
        if (item.textContent.includes(getPageName(pageId))) {
            item.classList.add('active');
            break;
        }
    }
    
    // Mobile: close sidebar
    if (window.innerWidth <= 1024) {
        toggleSidebar();
    }
}

function getPageName(pageId) {
    const pageNames = {
        'dashboardPage': 'Dashboard',
        'activationPage': 'Activation',
        'activationHistoryPage': 'Activation History',
        'profilePage': 'Profile',
        'kycPage': 'KYC',
        'changePasswordPage': 'Change Password',
        'addFundPage': 'Add Fund',
        'fundReportPage': 'Fund Report',
        'referralIncomePage': 'Referral Income',
        'roiIncomePage': 'ROI Income',
        'withdrawalPage': 'Withdrawal',
        'withdrawalReportPage': 'Withdrawal Report',
        'taskPage': 'Task'
    };
    return pageNames[pageId] || '';
}

// ================= LOAD DATA FUNCTIONS =================
async function loadActivationHistory() {
    if (!currentUser) return;
    
    const packagesSnapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .orderBy('activatedAt', 'desc')
        .get();
    
    const table = $('activationHistoryTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let totalActivations = 0;
    let totalInvestment = 0;
    let activePackages = 0;
    
    if (packagesSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">No activation history found</td></tr>';
    } else {
        packagesSnapshot.forEach(doc => {
            const pkg = doc.data();
            totalActivations++;
            totalInvestment += pkg.amount;
            if (pkg.status === 'active') activePackages++;
            
            const statusClass = pkg.status === 'active' ? 'status-active' : 
                              pkg.status === 'expired' ? 'status-expired' : 'status-pending';
            
            const row = `
                <tr>
                    <td>${formatDateTime(pkg.activatedAt)}</td>
                    <td>${pkg.name}</td>
                    <td>${formatCurrency(pkg.amount)}</td>
                    <td><span class="${statusClass}">${pkg.status}</span></td>
                    <td>${formatDate(pkg.expiryDate)}</td>
                    <td>${formatCurrency(pkg.amount * (pkg.dailyROI || 1.5) / 100)}</td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('totalActivations').textContent = totalActivations;
    $('totalInvestment').textContent = formatCurrency(totalInvestment);
    $('activePackages').textContent = activePackages;
    $('activationFund').textContent = formatCurrency(totalInvestment);
}

async function loadFundReport() {
    if (!currentUser) return;
    
    const transactionsSnapshot = await db.collection('transactions')
        .where('userId', '==', currentUser.uid)
        .orderBy('timestamp', 'desc')
        .limit(50)
        .get();
    
    const table = $('fundReportTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let totalDeposits = 0;
    let totalWithdrawals = 0;
    let currentBalance = userData ? userData.balance : 0;
    
    if (transactionsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">No transactions found</td></tr>';
    } else {
        let runningBalance = currentBalance;
        
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            
            if (transaction.type === 'deposit' && transaction.status === 'completed') {
                totalDeposits += transaction.amount;
            } else if (transaction.type === 'withdrawal' && transaction.status === 'completed') {
                totalWithdrawals += transaction.amount;
            }
            
            // Calculate running balance
            if (transaction.type === 'deposit' && transaction.status === 'completed') {
                runningBalance -= transaction.amount;
            } else if (transaction.type === 'withdrawal' && transaction.status === 'completed') {
                runningBalance += transaction.amount;
            } else if (transaction.type === 'package_activation' && transaction.status === 'completed') {
                runningBalance += transaction.amount;
            } else if (transaction.type === 'task_income' || transaction.type === 'roi_income' || transaction.type === 'referral_income') {
                runningBalance -= transaction.amount;
            }
            
            const statusClass = transaction.status === 'completed' ? 'status-active' :
                              transaction.status === 'pending' ? 'status-pending' : 'status-rejected';
            
            const row = `
                <tr>
                    <td>${formatDateTime(transaction.timestamp)}</td>
                    <td>${doc.id.slice(-8).toUpperCase()}</td>
                    <td>${transaction.type.replace('_', ' ').toUpperCase()}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td><span class="${statusClass}">${transaction.status}</span></td>
                    <td>${formatCurrency(runningBalance)}</td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('totalDeposits').textContent = formatCurrency(totalDeposits);
    $('totalWithdrawals').textContent = formatCurrency(totalWithdrawals);
    $('netBalance').textContent = formatCurrency(totalDeposits - totalWithdrawals);
}

async function loadReferralIncome() {
    if (!currentUser) return;
    
    // Get referrals
    const referralsSnapshot = await db.collection('users')
        .where('sponsorId', '==', userData.userId)
        .get();
    
    const table = $('referralIncomeTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let totalReferrals = 0;
    let activeReferrals = 0;
    let totalReferralIncome = userData.referralEarnings || 0;
    
    if (referralsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="7" class="text-center">No referrals found</td></tr>';
    } else {
        for (const doc of referralsSnapshot.docs) {
            const referral = doc.data();
            totalReferrals++;
            
            // Check if referral has active packages
            const packageSnapshot = await db.collection('packages')
                .where('userId', '==', doc.id)
                .where('status', '==', 'active')
                .get();
            
            if (!packageSnapshot.empty) activeReferrals++;
            
            const activePackage = await getUserActivePackage(doc.id);
            const commission = calculateReferralCommission(doc.id);
            
            const row = `
                <tr>
                    <td>${formatDate(referral.createdAt)}</td>
                    <td>${referral.userId}</td>
                    <td>${referral.name}</td>
                    <td>${activePackage}</td>
                    <td>10%</td>
                    <td>${formatCurrency(await commission)}</td>
                    <td><span class="status-${referral.status}">${referral.status}</span></td>
                </tr>
            `;
            table.innerHTML += row;
        }
    }
    
    // Update stats
    $('totalReferrals').textContent = totalReferrals;
    $('activeReferralsCount').textContent = activeReferrals;
    $('totalReferralIncome').textContent = formatCurrency(totalReferralIncome);
}

async function getUserActivePackage(userId) {
    const snapshot = await db.collection('packages')
        .where('userId', '==', userId)
        .where('status', '==', 'active')
        .limit(1)
        .get();
    
    if (snapshot.empty) return 'None';
    
    return snapshot.docs[0].data().name;
}

async function calculateReferralCommission(userId) {
    const snapshot = await db.collection('packages')
        .where('userId', '==', userId)
        .where('status', '==', 'active')
        .get();
    
    let totalCommission = 0;
    snapshot.forEach(doc => {
        const pkg = doc.data();
        totalCommission += pkg.amount * 0.1; // 10% commission
    });
    
    return totalCommission;
}

async function loadROIIncome() {
    if (!currentUser) return;
    
    const packagesSnapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    const table = $('roiIncomeTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let totalROI = 0;
    let todayROI = 0;
    let activeInvestments = packagesSnapshot.size;
    
    if (packagesSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="7" class="text-center">No active investments found</td></tr>';
    } else {
        packagesSnapshot.forEach(doc => {
            const pkg = doc.data();
            
            // Calculate ROI income
            const daysActive = Math.floor((new Date() - pkg.activatedAt.toDate()) / (1000 * 60 * 60 * 24));
            const dailyIncome = pkg.amount * pkg.dailyROI / 100;
            const totalIncome = dailyIncome * daysActive;
            
            totalROI += totalIncome;
            todayROI += dailyIncome;
            
            const row = `
                <tr>
                    <td>${formatDate(pkg.activatedAt)}</td>
                    <td>${pkg.name}</td>
                    <td>${formatCurrency(pkg.amount)}</td>
                    <td>${pkg.dailyROI}%</td>
                    <td>${formatCurrency(dailyIncome)}</td>
                    <td>${formatCurrency(totalIncome)}</td>
                    <td><span class="status-active">Active</span></td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('totalROI').textContent = formatCurrency(totalROI);
    $('todayROI').textContent = formatCurrency(todayROI);
    $('activeInvestments').textContent = activeInvestments;
}

async function loadWithdrawalReport() {
    if (!currentUser) return;
    
    const withdrawalsSnapshot = await db.collection('withdrawals')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .get();
    
    const table = $('withdrawalReportTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let totalRequests = 0;
    let approvedAmount = 0;
    let pendingAmount = 0;
    
    if (withdrawalsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">No withdrawal requests found</td></tr>';
    } else {
        withdrawalsSnapshot.forEach(doc => {
            const withdrawal = doc.data();
            totalRequests++;
            
            if (withdrawal.status === 'approved') {
                approvedAmount += withdrawal.amount;
            } else if (withdrawal.status === 'pending') {
                pendingAmount += withdrawal.amount;
            }
            
            const statusClass = withdrawal.status === 'approved' ? 'status-active' :
                              withdrawal.status === 'pending' ? 'status-pending' : 'status-rejected';
            
            const row = `
                <tr>
                    <td>${formatDateTime(withdrawal.createdAt)}</td>
                    <td>${doc.id.slice(-8).toUpperCase()}</td>
                    <td>${formatCurrency(withdrawal.amount)}</td>
                    <td>${withdrawal.method || 'Bank Transfer'}</td>
                    <td><span class="${statusClass}">${withdrawal.status}</span></td>
                    <td>${withdrawal.processedAt ? formatDateTime(withdrawal.processedAt) : 'Pending'}</td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('withdrawalRequests').textContent = totalRequests;
    $('withdrawalApproved').textContent = formatCurrency(approvedAmount);
    $('withdrawalPending').textContent = formatCurrency(pendingAmount);
    
    // Update withdrawal page stats
    $('withdrawBalance').textContent = formatCurrency(userData.balance);
    $('withdrawPending').textContent = formatCurrency(pendingAmount);
    $('withdrawTotal').textContent = formatCurrency(approvedAmount);
}

// ================= TASK SYSTEM =================
let taskClicks = 0;
const maxClicks = 15;

async function loadTaskData() {
    if (!currentUser) return;
    
    // Load today's task progress
    const today = new Date().toISOString().split('T')[0];
    const taskDoc = await db.collection('tasks').doc(`${currentUser.uid}_${today}`).get();
    
    if (taskDoc.exists) {
        taskClicks = taskDoc.data().clicks || 0;
    } else {
        taskClicks = 0;
        await db.collection('tasks').doc(`${currentUser.uid}_${today}`).set({
            userId: currentUser.uid,
            userName: userData.name,
            date: today,
            clicks: 0,
            earnings: 0
        });
    }
    
    updateTaskUI();
}

function updateTaskUI() {
    const progress = (taskClicks / maxClicks) * 100;
    
    $('task-completed-count').textContent = taskClicks;
    $('task-pending-count').textContent = maxClicks - taskClicks;
    $('task-progress-text').textContent = `Progress: ${taskClicks}/${maxClicks} clicks`;
    $('task-progress-fill').style.width = `${progress}%`;
    
    // Calculate earnings based on active packages
    calculateTaskEarnings();
}

async function calculateTaskEarnings() {
    if (!currentUser || !userData) return;
    
    // Get all active packages
    const packagesSnapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    let totalInvestment = 0;
    packagesSnapshot.forEach(doc => {
        const pkg = doc.data();
        totalInvestment += pkg.amount;
    });
    
    if (totalInvestment > 0) {
        const dailyIncome = totalInvestment * 0.05; // 5% daily
        const perClick = dailyIncome / maxClicks;
        const earnedToday = perClick * taskClicks;
        
        $('taskDailyIncome').textContent = formatCurrency(dailyIncome);
        $('taskPerClick').textContent = formatCurrency(perClick);
        $('taskCompletedToday').textContent = `${taskClicks}/${maxClicks}`;
        
        // Update task message
        if (taskClicks === maxClicks) {
            $('taskMessage').style.display = 'block';
            $('taskMessageText').textContent = `Task completed! ${formatCurrency(dailyIncome)} added to balance`;
        }
    } else {
        $('taskDailyIncome').textContent = '0';
        $('taskPerClick').textContent = '0';
        $('taskCompletedToday').textContent = '0/15';
    }
}

async function completeTask() {
    if (!currentUser || !userData) return;
    
    // Check if user has active packages
    const packagesSnapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    if (packagesSnapshot.empty) {
        alert('Please activate a package first to start earning from tasks.');
        showPage('activationPage');
        return;
    }
    
    if (taskClicks >= maxClicks) {
        alert('Daily task limit reached. Come back tomorrow!');
        return;
    }
    
    taskClicks++;
    
    // Calculate total investment from active packages
    let totalInvestment = 0;
    packagesSnapshot.forEach(doc => {
        const pkg = doc.data();
        totalInvestment += pkg.amount;
    });
    
    // Calculate earnings
    const dailyIncome = totalInvestment * 0.05; // 5% daily
    const perClick = dailyIncome / maxClicks;
    
    try {
        // Update task progress
        const today = new Date().toISOString().split('T')[0];
        await db.collection('tasks').doc(`${currentUser.uid}_${today}`).update({
            clicks: taskClicks,
            earnings: firebase.firestore.FieldValue.increment(perClick),
            lastClick: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add earnings to balance if task is completed
        if (taskClicks === maxClicks) {
            await db.collection('users').doc(currentUser.uid).update({
                balance: firebase.firestore.FieldValue.increment(dailyIncome),
                totalEarnings: firebase.firestore.FieldValue.increment(dailyIncome)
            });
            
            // Create transaction record
            await db.collection('transactions').add({
                userId: currentUser.uid,
                type: 'task_income',
                amount: dailyIncome,
                description: 'Daily Task Completion',
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create notification
            await db.collection('notifications').add({
                type: 'task_completed',
                title: 'Task Completed',
                message: `You earned ${formatCurrency(dailyIncome)} from daily tasks.`,
                userId: currentUser.uid,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Reload user data
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            userData = userDoc.data();
        }
        
        updateTaskUI();
        
    } catch (error) {
        console.error('Error updating task:', error);
        taskClicks--; // Revert if error
    }
}

// ================= PAYMENT SYSTEM =================
function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
}

async function processPayment() {
    if (!currentUser || !userData) return;
    
    const amount = parseFloat($('fundAmount').value);
    const paidAmount = parseFloat($('paidAmount').value);
    const transactionId = $('userUpiTransactionId').value.trim();
    
    if (!amount || amount < 100) {
        alert('Please enter a valid amount (minimum 100)');
        return;
    }
    
    if (!transactionId) {
        alert('Please enter your UPI Transaction ID');
        return;
    }
    
    if (!paidAmount || paidAmount < amount) {
        alert('Please enter the exact amount you paid');
        return;
    }
    
    try {
        $('paymentBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        $('paymentBtn').disabled = true;
        
        // Create deposit request
        await db.collection('deposits').add({
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            amount: amount,
            paidAmount: paidAmount,
            transactionId: transactionId,
            method: 'QR Code',
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for admin (REAL-TIME)
        await db.collection('notifications').add({
            type: 'deposit_request',
            title: 'New Deposit Request',
            message: `${userData.name} (${userData.userId}) requested deposit of ${formatCurrency(amount)}`,
            userId: 'ADMIN',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' Deposit request submitted successfully! It will be processed instantly.');
        
        // Reset form
        $('fundAmount').value = '';
        $('paidAmount').value = '';
        $('userUpiTransactionId').value = '';
        
    } catch (error) {
        alert('Error submitting payment request: ' + error.message);
    } finally {
        $('paymentBtn').innerHTML = '<i class="fas fa-credit-card"></i> Submit Payment Request';
        $('paymentBtn').disabled = false;
    }
}

// ================= WITHDRAWAL SYSTEM =================
async function processWithdrawal() {
    if (!currentUser || !userData) return;
    
    const amount = parseFloat($('withdrawAmount').value);
    const method = $('withdrawMethod').value;
    
    if (!amount || amount < 200) {
        alert('Minimum withdrawal amount is 200');
        return;
    }
    
    if (amount > userData.balance) {
        alert('Insufficient balance');
        return;
    }
    
    // Check KYC status
    if (userData.kycStatus !== 'verified') {
        alert('Please complete KYC verification before withdrawing funds.');
        showPage('kycPage');
        return;
    }
    
    let accountDetails = {};
    if (method === 'bank') {
        const bankName = $('bankName').value.trim();
        const accountNumber = $('accountNumber').value.trim();
        const ifscCode = $('ifscCodeInput').value.trim();
        const accountHolder = $('accountHolder').value.trim();
        
        if (!bankName || !accountNumber || !ifscCode || !accountHolder) {
            alert('Please fill all bank details');
            return;
        }
        
        accountDetails = { bankName, accountNumber, ifscCode, accountHolder };
    } else if (method === 'upi') {
        const upiId = $('upiIdInput').value.trim();
        if (!upiId) {
            alert('Please enter UPI ID');
            return;
        }
        accountDetails = { upiId };
    }
    
    const confirmWithdrawal = confirm(`Request withdrawal of ${formatCurrency(amount)} via ${method}?\nA 5% fee will be deducted.`);
    if (!confirmWithdrawal) return;
    
    try {
        $('withdrawBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        $('withdrawBtn').disabled = true;
        
        const fee = amount * 0.05;
        const netAmount = amount - fee;
        
        // Create withdrawal request
        await db.collection('withdrawals').add({
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            amount: amount,
            netAmount: netAmount,
            fee: fee,
            method: method,
            accountDetails: accountDetails,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Deduct amount from user balance
        await db.collection('users').doc(currentUser.uid).update({
            balance: firebase.firestore.FieldValue.increment(-amount),
            totalWithdrawals: firebase.firestore.FieldValue.increment(amount)
        });
        
        // Create notification for admin (REAL-TIME)
        await db.collection('notifications').add({
            type: 'withdrawal_request',
            title: 'New Withdrawal Request',
            message: `${userData.name} (${userData.userId}) requested withdrawal of ${formatCurrency(amount)}`,
            userId: 'ADMIN',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' Withdrawal request submitted successfully! It will be processed instantly.');
        
        // Reset form
        $('withdrawAmount').value = '';
        if (method === 'bank') {
            $('bankName').value = '';
            $('accountNumber').value = '';
            $('ifscCodeInput').value = '';
            $('accountHolder').value = '';
        } else {
            $('upiIdInput').value = '';
        }
        
        // Reload user data
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        userData = userDoc.data();
        updateUserUI();
        loadWithdrawalReport();
        
    } catch (error) {
        alert('Error processing withdrawal: ' + error.message);
    } finally {
        $('withdrawBtn').innerHTML = '<i class="fas fa-money-check-alt"></i> Request Withdrawal';
        $('withdrawBtn').disabled = false;
    }
}

// ================= KYC SUBMISSION =================
async function submitKYC() {
    if (!currentUser || !userData) return;
    
    const name = $('kycName').value.trim();
    const dob = $('kycDob').value;
    const aadhar = $('kycAadhar').value.trim();
    const pan = $('kycPan').value.trim();
    const accountNumber = $('kycAccountNumber').value.trim();
    const ifscCode = $('kycIfscCode').value.trim();
    const bankName = $('kycBankName').value.trim();
    
    if (!name || !dob || !aadhar || !pan || !accountNumber || !ifscCode || !bankName) {
        alert('Please fill all KYC details');
        return;
    }
    
    if (aadhar.length !== 12 || !/^\d+$/.test(aadhar)) {
        alert('Please enter a valid 12-digit Aadhar number');
        return;
    }
    
    if (pan.length !== 10) {
        alert('Please enter a valid 10-digit PAN number');
        return;
    }
    
    try {
        $('kycSubmitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        $('kycSubmitBtn').disabled = true;
        
        // Update user KYC status
        await db.collection('users').doc(currentUser.uid).update({
            kycName: name,
            kycDob: dob,
            kycAadhar: aadhar,
            kycPan: pan,
            kycAccountNumber: accountNumber,
            kycIfscCode: ifscCode,
            kycBankName: bankName,
            kycStatus: 'pending',
            kycSubmitted: true,
            kycSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for admin (REAL-TIME)
        await db.collection('notifications').add({
            type: 'kyc_submitted',
            title: 'New KYC Submission',
            message: `${userData.name} (${userData.userId}) submitted KYC for verification`,
            userId: 'ADMIN',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' KYC submitted successfully! It will be verified instantly.');
        
        // Update UI
        userData.kycStatus = 'pending';
        $('profileKYC').value = 'pending';
        $('kycStatusText').textContent = 'Pending';
        $('kycStatusText').className = 'text-warning';
        
    } catch (error) {
        alert('Error submitting KYC: ' + error.message);
    } finally {
        $('kycSubmitBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Submit KYC';
        $('kycSubmitBtn').disabled = false;
    }
}

// ================= PASSWORD CHANGE =================
async function changePassword() {
    if (!currentUser) return;
    
    const currentPassword = $('currentPassword').value;
    const newPassword = $('newPassword').value;
    const confirmPassword = $('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill all password fields');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('New password must be at least 6 characters long');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }
    
    try {
        $('changePasswordBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        $('changePasswordBtn').disabled = true;
        
        // Re-authenticate user
        const credential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
        );
        
        await currentUser.reauthenticateWithCredential(credential);
        
        // Update password
        await currentUser.updatePassword(newPassword);
        
        alert(' Password updated successfully!');
        
        // Clear form
        $('currentPassword').value = '';
        $('newPassword').value = '';
        $('confirmPassword').value = '';
        
    } catch (error) {
        alert('Error changing password: ' + error.message);
    } finally {
        $('changePasswordBtn').innerHTML = '<i class="fas fa-key"></i> Update Password';
        $('changePasswordBtn').disabled = false;
    }
}

// ================= NOTIFICATIONS =================
async function loadNotifications() {
    if (!currentUser) return;
    
    const notificationsSnapshot = await db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .limit(20)
        .get();
    
    const notificationList = $('notificationList');
    if (!notificationList) return;
    
    notificationList.innerHTML = '';
    
    let unreadCount = 0;
    
    if (notificationsSnapshot.empty) {
        notificationList.innerHTML = '<div class="notification-item"><p>No notifications</p></div>';
    } else {
        notificationsSnapshot.forEach(doc => {
            const notification = doc.data();
            if (!notification.read) unreadCount++;
            
            const notificationItem = document.createElement('div');
            notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
            notificationItem.innerHTML = `
                <p><strong>${notification.title}</strong></p>
                <p>${notification.message}</p>
                <div class="notification-time">${formatDateTime(notification.createdAt)}</div>
            `;
            
            notificationItem.onclick = () => markNotificationAsRead(doc.id);
            notificationList.appendChild(notificationItem);
        });
    }
    
    $('notificationCount').textContent = unreadCount;
}

async function markNotificationAsRead(notificationId) {
    try {
        await db.collection('notifications').doc(notificationId).update({
            read: true
        });
        
        loadNotifications();
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

function toggleNotifications() {
    const popup = $('notificationPopup');
    if (popup.style.display === 'block') {
        popup.style.display = 'none';
    } else {
        popup.style.display = 'block';
        loadNotifications();
    }
}

// ================= UTILITY FUNCTIONS =================
function copyReferralLink() {
    const refLink = $('refLink');
    refLink.select();
    refLink.setSelectionRange(0, 99999);
    document.execCommand('copy');
    alert('Referral link copied to clipboard!');
}

function shareOnTelegram() {
    const refLink = $('refLink').value;
    const text = encodeURIComponent(`Join CapitalRise Trading Platform and start earning! Use my referral link: ${refLink}`);
    window.open(`https://t.me/share/url?url=${refLink}&text=${text}`, '_blank');
}

function shareOnWhatsApp() {
    const refLink = $('refLink').value;
    const text = encodeURIComponent(`Join CapitalRise Trading Platform and start earning! Use my referral link: ${refLink}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function toggleSidebar() {
    const sidebar = $('sidebar') || $('adminSidebar');
    const overlay = $('mobileOverlay');
    
    if (sidebar) {
        sidebar.classList.toggle('open');
        if (overlay) overlay.classList.toggle('active');
    }
}

async function logout() {
    try {
        await auth.signOut();
        window.location.reload();
    } catch (error) {
        console.error('Logout error:', error);
    }
}

async function adminLogout() {
    try {
        await auth.signOut();
        window.location.reload();
    } catch (error) {
        console.error('Logout error:', error);
    }
}

// ================= REAL-TIME UPDATES =================
function startUserRealTimeUpdates() {
    if (!currentUser) return;
    
    // Listen for user data changes
    db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
        if (doc.exists) {
            userData = doc.data();
            updateUserUI();
        }
    });
    
    // Listen for notifications
    db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot((snapshot) => {
            loadNotifications();
        });
    
    // Listen for package status changes
    db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            loadPackages();
            loadActivationHistory();
            loadROIIncome();
            updateTaskUI();
            calculateActiveFund();
        });
}

function startAdminRealTimeUpdates() {
    // Clear existing listeners
    realtimeListeners.forEach(unsubscribe => unsubscribe());
    realtimeListeners = [];
    
    // Listen for deposit requests (REAL-TIME)
    const depositListener = db.collection('deposits')
        .where('status', '==', 'pending')
        .onSnapshot((snapshot) => {
            updatePendingCounts();
            if ($('adminDepositsPage').classList.contains('active')) {
                loadDepositRequestsAdmin();
            }
        });
    realtimeListeners.push(depositListener);
    
    // Listen for withdrawal requests (REAL-TIME)
    const withdrawalListener = db.collection('withdrawals')
        .where('status', '==', 'pending')
        .onSnapshot((snapshot) => {
            updatePendingCounts();
            if ($('adminWithdrawalsPage').classList.contains('active')) {
                loadWithdrawalRequestsAdmin();
            }
        });
    realtimeListeners.push(withdrawalListener);
    
    // Listen for KYC requests (REAL-TIME)
    const kycListener = db.collection('users')
        .where('kycStatus', '==', 'pending')
        .where('kycSubmitted', '==', true)
        .onSnapshot((snapshot) => {
            updatePendingCounts();
            if ($('adminKYCVerificationPage').classList.contains('active')) {
                loadKYCRequestsAdmin();
            }
        });
    realtimeListeners.push(kycListener);
    
    // Listen for notifications (REAL-TIME)
    const notificationListener = db.collection('notifications')
        .where('userId', '==', 'ADMIN')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot((snapshot) => {
            loadAdminNotifications();
        });
    realtimeListeners.push(notificationListener);
    
    // Listen for recent activity (REAL-TIME)
    const activityListener = db.collection('transactions')
        .orderBy('timestamp', 'desc')
        .limit(10)
        .onSnapshot((snapshot) => {
            if ($('adminDashboardPage').classList.contains('active')) {
                loadRecentActivityAdmin();
            }
        });
    realtimeListeners.push(activityListener);
    
    // Initial load
    updatePendingCounts();
}

async function updatePendingCounts() {
    // Get pending deposits count
    const depositsSnapshot = await db.collection('deposits')
        .where('status', '==', 'pending')
        .get();
    $('depositBadge').textContent = depositsSnapshot.size;
    $('depositCounter').textContent = depositsSnapshot.size;
    
    // Get pending withdrawals count
    const withdrawalsSnapshot = await db.collection('withdrawals')
        .where('status', '==', 'pending')
        .get();
    $('withdrawalBadge').textContent = withdrawalsSnapshot.size;
    $('withdrawalCounter').textContent = withdrawalsSnapshot.size;
    
    // Get pending KYC count
    const kycSnapshot = await db.collection('users')
        .where('kycStatus', '==', 'pending')
        .where('kycSubmitted', '==', true)
        .get();
    $('kycBadge').textContent = kycSnapshot.size;
    $('kycCounter').textContent = kycSnapshot.size;
    
    // Total pending requests
    const totalPending = depositsSnapshot.size + withdrawalsSnapshot.size + kycSnapshot.size;
    $('dashboardBadge').textContent = totalPending;
    $('packageBadge').textContent = 0; // Packages are auto-activated
}

async function loadAdminNotifications() {
    const snapshot = await db.collection('notifications')
        .where('userId', '==', 'ADMIN')
        .where('read', '==', false)
        .orderBy('createdAt', 'desc')
        .limit(20)
        .get();
    
    let unreadCount = 0;
    snapshot.forEach(() => unreadCount++);
    
    $('notificationCount').textContent = unreadCount;
}

// ================= ADMIN DASHBOARD =================
function showAdminDashboard() {
    hideAllPages();
    $('adminDashboard').classList.remove('hidden');
}

function showAdminPage(pageId) {
    // Hide all admin pages
    document.querySelectorAll('#adminDashboard .page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Show selected page
    $(pageId).classList.add('active');
    
    // Update sidebar active state
    document.querySelectorAll('#adminDashboard .sidebar li').forEach(item => {
        item.classList.remove('active');
    });
    
    // Find and activate corresponding sidebar item
    const sidebarItems = document.querySelectorAll('#adminDashboard .sidebar li');
    for (let item of sidebarItems) {
        if (item.textContent.includes(getAdminPageName(pageId))) {
            item.classList.add('active');
            break;
        }
    }
    
    // Load page data
    switch(pageId) {
        case 'adminDashboardPage':
            loadAdminDashboard();
            break;
        case 'adminUsersPage':
            loadAllUsersAdmin();
            break;
        case 'adminDepositsPage':
            loadDepositRequestsAdmin();
            break;
        case 'adminWithdrawalsPage':
            loadWithdrawalRequestsAdmin();
            break;
        case 'adminKYCVerificationPage':
            loadKYCRequestsAdmin();
            break;
        case 'adminTransactionsPage':
            loadAllTransactionsAdmin();
            break;
        case 'adminSettingsPage':
            loadAdminSettings();
            break;
    }
    
    // Mobile: close sidebar
    if (window.innerWidth <= 1024) {
        toggleSidebar();
    }
}

function getAdminPageName(pageId) {
    const pageNames = {
        'adminDashboardPage': 'Dashboard',
        'adminUsersPage': 'All Users',
        'adminDepositsPage': 'Deposit Requests',
        'adminWithdrawalsPage': 'Withdrawal Requests',
        'adminPackageRequestsPage': 'Package Requests',
        'adminKYCVerificationPage': 'KYC Verification',
        'adminTransactionsPage': 'All Transactions',
        'adminSettingsPage': 'Settings'
    };
    return pageNames[pageId] || '';
}

async function loadAdminDashboard() {
    // Load total users
    const usersSnapshot = await db.collection('users').where('role', '==', 'user').get();
    $('adminTotalUsers').textContent = usersSnapshot.size;
    
    // Load today's users
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayUsersSnapshot = await db.collection('users')
        .where('role', '==', 'user')
        .where('createdAt', '>=', today)
        .get();
    $('adminTodayUsers').textContent = todayUsersSnapshot.size;
    
    // Load active users (with active packages)
    const activeUsersSnapshot = await db.collection('packages')
        .where('status', '==', 'active')
        .get();
    
    const activeUserIds = new Set();
    activeUsersSnapshot.forEach(doc => {
        activeUserIds.add(doc.data().userId);
    });
    $('adminActiveUsers').textContent = activeUserIds.size;
    
    // Load total deposits
    const depositsSnapshot = await db.collection('deposits').get();
    let totalDeposits = 0;
    let todayDeposits = 0;
    let pendingDepositsAmount = 0;
    depositsSnapshot.forEach(doc => {
        const deposit = doc.data();
        if (deposit.status === 'approved') {
            totalDeposits += deposit.amount;
        }
        if (deposit.createdAt && deposit.createdAt.toDate() >= today) {
            todayDeposits += deposit.amount;
        }
        if (deposit.status === 'pending') {
            pendingDepositsAmount += deposit.amount;
        }
    });
    $('adminTotalDeposits').textContent = formatCurrency(totalDeposits);
    $('adminTodayDeposits').textContent = formatCurrency(todayDeposits);
    
    // Load total withdrawals
    const withdrawalsSnapshot = await db.collection('withdrawals').get();
    let totalWithdrawals = 0;
    let pendingWithdrawals = 0;
    withdrawalsSnapshot.forEach(doc => {
        const withdrawal = doc.data();
        if (withdrawal.status === 'approved') {
            totalWithdrawals += withdrawal.amount;
        } else if (withdrawal.status === 'pending') {
            pendingWithdrawals += withdrawal.amount;
        }
    });
    $('adminTotalWithdrawals').textContent = formatCurrency(totalWithdrawals);
    $('adminPendingWithdrawals').textContent = formatCurrency(pendingWithdrawals);
    
    // Load total investments
    const packagesSnapshot = await db.collection('packages').where('status', '==', 'active').get();
    let totalInvestments = 0;
    packagesSnapshot.forEach(doc => {
        const pkg = doc.data();
        totalInvestments += pkg.amount;
    });
    $('adminTotalInvestments').textContent = formatCurrency(totalInvestments);
    
    // Load pending requests
    const pendingDeposits = await db.collection('deposits').where('status', '==', 'pending').get();
    const pendingWithdrawalsCount = await db.collection('withdrawals').where('status', '==', 'pending').get();
    const pendingKYC = await db.collection('users').where('kycStatus', '==', 'pending').where('kycSubmitted', '==', true).get();
    $('adminPendingRequests').textContent = pendingDeposits.size + pendingWithdrawalsCount.size + pendingKYC.size;
    
    // Load total commission
    const users = await db.collection('users').where('role', '==', 'user').get();
    let totalCommission = 0;
    users.forEach(doc => {
        const user = doc.data();
        totalCommission += user.referralEarnings || 0;
    });
    $('adminTotalCommission').textContent = formatCurrency(totalCommission);
    
    // Load platform balance
    const platformBalance = totalDeposits - totalWithdrawals - totalCommission;
    $('adminPlatformBalance').textContent = formatCurrency(platformBalance);
    
    // Load recent activity
    loadRecentActivityAdmin();
}

async function loadRecentActivityAdmin() {
    const transactionsSnapshot = await db.collection('transactions')
        .orderBy('timestamp', 'desc')
        .limit(10)
        .get();
    
    const table = $('adminRecentActivity');
    if (!table) return;
    
    table.innerHTML = '';
    
    if (transactionsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">No recent activity</td></tr>';
    } else {
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            const statusClass = transaction.status === 'completed' ? 'status-active' :
                              transaction.status === 'pending' ? 'status-pending' : 'status-rejected';
            
            const row = `
                <tr>
                    <td>${formatDateTime(transaction.timestamp)}</td>
                    <td>${getUserCode(transaction.userId)}</td>
                    <td>${transaction.description || transaction.type}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td><span class="${statusClass}">${transaction.status}</span></td>
                    <td>
                        ${transaction.status === 'pending' ? `
                            <button class="btn btn-success btn-small" onclick="approveTransaction('${doc.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="rejectTransaction('${doc.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : 'Completed'}
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
}

function getUserCode(uid) {
    if (uid === 'ADMIN') return 'ADMIN';
    const userDoc = db.collection('users').doc(uid).get();
    return userDoc.exists ? userDoc.data().userId : 'CR' + uid.slice(-6).toUpperCase();
}

// ================= ADMIN USER MANAGEMENT =================
async function loadAllUsersAdmin() {
    const usersSnapshot = await db.collection('users').where('role', '==', 'user').get();
    const table = $('adminUsersTable');
    
    if (!table) return;
    
    table.innerHTML = '';
    
    if (usersSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="9" class="text-center">No users found</td></tr>';
    } else {
        for (const doc of usersSnapshot.docs) {
            const user = doc.data();
            
            // Get active packages count
            const packagesSnapshot = await db.collection('packages')
                .where('userId', '==', doc.id)
                .where('status', '==', 'active')
                .get();
            
            const activePackages = packagesSnapshot.size;
            
            const row = `
                <tr>
                    <td>${user.userId}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${formatCurrency(user.balance)}</td>
                    <td>${activePackages}</td>
                    <td><span class="status-${user.status}">${user.status}</span></td>
                    <td><span class="status-${user.kycStatus || 'pending'}">${user.kycStatus || 'pending'}</span></td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <button class="btn btn-small" onclick="viewUserDetailsAdmin('${doc.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success btn-small" onclick="activateUser('${doc.id}')" title="Activate" ${user.status === 'active' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-warning btn-small" onclick="deactivateUser('${doc.id}')" title="Deactivate" ${user.status !== 'active' ? 'disabled' : ''}>
                            <i class="fas fa-ban"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="blockUser('${doc.id}')" title="Block" ${user.status === 'blocked' ? 'disabled' : ''}>
                            <i class="fas fa-lock"></i>
                        </button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        }
    }
}

function showAddUserModal() {
    showModal('addUserModal');
}

async function createNewUser() {
    const name = $('newUserName').value.trim();
    const email = $('newUserEmail').value.trim();
    const mobile = $('newUserMobile').value.trim();
    const password = $('newUserPassword').value;
    const balance = parseFloat($('newUserBalance').value) || 0;

    if (!name || !email || !mobile || !password) {
        alert('Please fill all required fields');
        return;
    }

    if (password.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
    }

    try {
        // Create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Generate user ID
        const userId = generateUserId(user.uid);
        
        // Create user document
        await db.collection('users').doc(user.uid).set({
            uid: user.uid,
            userId: userId,
            name: name,
            email: email,
            mobile: mobile,
            sponsorId: 'ADMIN',
            balance: balance,
            totalEarnings: 0,
            referralEarnings: 0,
            totalDeposits: 0,
            totalWithdrawals: 0,
            status: 'active',
            kycStatus: 'pending',
            kycSubmitted: false,
            referralCount: 0,
            role: 'user',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert(' User created successfully!');
        closeModal('addUserModal');
        loadAllUsersAdmin();
        
        // Clear form
        $('newUserName').value = '';
        $('newUserEmail').value = '';
        $('newUserMobile').value = '';
        $('newUserPassword').value = '';
        $('newUserBalance').value = '50';
        
    } catch (error) {
        alert('Error creating user: ' + error.message);
    }
}

async function viewUserDetailsAdmin(userId) {
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) return;
    
    const user = userDoc.data();
    
    // Get user packages
    const packagesSnapshot = await db.collection('packages')
        .where('userId', '==', userId)
        .orderBy('activatedAt', 'desc')
        .get();
    
    // Get user transactions
    const transactionsSnapshot = await db.collection('transactions')
        .where('userId', '==', userId)
        .orderBy('timestamp', 'desc')
        .limit(10)
        .get();
    
    let packagesHTML = '';
    packagesSnapshot.forEach(doc => {
        const pkg = doc.data();
        packagesHTML += `
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 5px;">
                <strong>${pkg.name}</strong> - ${formatCurrency(pkg.amount)}<br>
                <small>Status: ${pkg.status} | Activated: ${formatDate(pkg.activatedAt)}</small>
            </div>
        `;
    });
    
    let transactionsHTML = '';
    transactionsSnapshot.forEach(doc => {
        const transaction = doc.data();
        transactionsHTML += `
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 5px;">
                <strong>${transaction.type}</strong> - ${formatCurrency(transaction.amount)}<br>
                <small>Status: ${transaction.status} | Date: ${formatDateTime(transaction.timestamp)}</small>
            </div>
        `;
    });
    
    const content = `
        <div class="form-group">
            <label>User ID</label>
            <input type="text" class="form-control" value="${user.userId}" readonly>
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" class="form-control" value="${user.name}" readonly>
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" class="form-control" value="${user.email}" readonly>
        </div>
        <div class="form-group">
            <label>Mobile</label>
            <input type="text" class="form-control" value="${user.mobile}" readonly>
        </div>
        <div class="form-group">
            <label>Balance</label>
            <input type="text" class="form-control" value="${formatCurrency(user.balance)}" readonly>
        </div>
        <div class="form-group">
            <label>Status</label>
            <input type="text" class="form-control" value="${user.status}" readonly>
        </div>
        <div class="form-group">
            <label>KYC Status</label>
            <input type="text" class="form-control" value="${user.kycStatus || 'pending'}" readonly>
        </div>
        <div class="form-group">
            <label>Active Packages (${packagesSnapshot.size})</label>
            <div style="max-height: 200px; overflow-y: auto;">
                ${packagesHTML || 'No packages found'}
            </div>
        </div>
        <div class="form-group">
            <label>Recent Transactions</label>
            <div style="max-height: 200px; overflow-y: auto;">
                ${transactionsHTML || 'No transactions found'}
            </div>
        </div>
    `;
    
    $('userDetailsContent').innerHTML = content;
    showModal('userDetailsModal');
}

async function activateUser(userId) {
    try {
        await db.collection('users').doc(userId).update({
            status: 'active'
        });
        
        alert(' User activated successfully!');
        loadAllUsersAdmin();
    } catch (error) {
        alert('Error activating user: ' + error.message);
    }
}

async function deactivateUser(userId) {
    try {
        await db.collection('users').doc(userId).update({
            status: 'inactive'
        });
        
        alert(' User deactivated successfully!');
        loadAllUsersAdmin();
    } catch (error) {
        alert('Error deactivating user: ' + error.message);
    }
}

async function blockUser(userId) {
    try {
        await db.collection('users').doc(userId).update({
            status: 'blocked'
        });
        
        alert(' User blocked successfully!');
        loadAllUsersAdmin();
    } catch (error) {
        alert('Error blocking user: ' + error.message);
    }
}

function searchUsers() {
    const searchTerm = $('searchUser').value.toLowerCase();
    const table = $('adminUsersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                found = true;
                break;
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
}

// ================= ADMIN DEPOSIT MANAGEMENT =================
async function loadDepositRequestsAdmin() {
    const depositsSnapshot = await db.collection('deposits')
        .where('status', '==', 'pending')
        .orderBy('createdAt', 'desc')
        .get();
    
    const table = $('adminDepositsTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let pendingCount = 0;
    let pendingAmount = 0;
    let todayCount = 0;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (depositsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="8" class="text-center">No deposit requests found</td></tr>';
    } else {
        depositsSnapshot.forEach(doc => {
            const deposit = doc.data();
            pendingCount++;
            pendingAmount += deposit.amount;
            
            if (deposit.createdAt && deposit.createdAt.toDate() >= today) {
                todayCount++;
            }
            
            const row = `
                <tr>
                    <td>${doc.id.slice(-8).toUpperCase()}</td>
                    <td>${getUserCode(deposit.userId)}</td>
                    <td>${deposit.userName}</td>
                    <td>${formatCurrency(deposit.amount)}</td>
                    <td>${deposit.transactionId}</td>
                    <td>${formatDate(deposit.createdAt)}</td>
                    <td><span class="status-pending">Pending</span></td>
                    <td>
                        <button class="btn btn-success btn-small" onclick="approveDeposit('${doc.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectDeposit('${doc.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('pendingDepositsCount').textContent = pendingCount;
    $('pendingDepositsAmount').textContent = formatCurrency(pendingAmount);
    $('todayDepositsCount').textContent = todayCount;
}

async function approveDeposit(depositId) {
    try {
        const depositDoc = await db.collection('deposits').doc(depositId).get();
        const deposit = depositDoc.data();
        
        // Update user balance
        await db.collection('users').doc(deposit.userId).update({
            balance: firebase.firestore.FieldValue.increment(deposit.amount),
            totalDeposits: firebase.firestore.FieldValue.increment(deposit.amount)
        });
        
        // Update deposit status
        await db.collection('deposits').doc(depositId).update({
            status: 'approved',
            approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
            approvedBy: adminData.userId
        });
        
        // Create transaction record
        await db.collection('transactions').add({
            userId: deposit.userId,
            type: 'deposit',
            amount: deposit.amount,
            description: 'Deposit Approved',
            status: 'completed',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for user
        await db.collection('notifications').add({
            type: 'deposit_approved',
            title: 'Deposit Approved',
            message: `Your deposit of ${formatCurrency(deposit.amount)} has been approved.`,
            userId: deposit.userId,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' Deposit approved successfully!');
        loadDepositRequestsAdmin();
        loadAdminDashboard();
        
    } catch (error) {
        alert('Error approving deposit: ' + error.message);
    }
}

async function rejectDeposit(depositId) {
    const reason = prompt('Enter rejection reason:');
    if (!reason) return;
    
    try {
        const depositDoc = await db.collection('deposits').doc(depositId).get();
        const deposit = depositDoc.data();
        
        await db.collection('deposits').doc(depositId).update({
            status: 'rejected',
            rejectReason: reason,
            rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            rejectedBy: adminData.userId
        });
        
        // Create notification for user
        await db.collection('notifications').add({
            type: 'deposit_rejected',
            title: 'Deposit Rejected',
            message: `Your deposit of ${formatCurrency(deposit.amount)} was rejected. Reason: ${reason}`,
            userId: deposit.userId,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' Deposit rejected!');
        loadDepositRequestsAdmin();
        
    } catch (error) {
        alert('Error rejecting deposit: ' + error.message);
    }
}

// ================= ADMIN WITHDRAWAL MANAGEMENT =================
async function loadWithdrawalRequestsAdmin() {
    const withdrawalsSnapshot = await db.collection('withdrawals')
        .where('status', '==', 'pending')
        .orderBy('createdAt', 'desc')
        .get();
    
    const table = $('adminWithdrawalsTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let pendingCount = 0;
    let pendingAmount = 0;
    let todayCount = 0;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (withdrawalsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="8" class="text-center">No withdrawal requests found</td></tr>';
    } else {
        withdrawalsSnapshot.forEach(doc => {
            const withdrawal = doc.data();
            pendingCount++;
            pendingAmount += withdrawal.amount;
            
            if (withdrawal.createdAt && withdrawal.createdAt.toDate() >= today) {
                todayCount++;
            }
            
            const row = `
                <tr>
                    <td>${doc.id.slice(-8).toUpperCase()}</td>
                    <td>${getUserCode(withdrawal.userId)}</td>
                    <td>${withdrawal.userName}</td>
                    <td>${formatCurrency(withdrawal.amount)}</td>
                    <td>${withdrawal.method}</td>
                    <td>${formatDate(withdrawal.createdAt)}</td>
                    <td><span class="status-pending">Pending</span></td>
                    <td>
                        <button class="btn btn-success btn-small" onclick="approveWithdrawal('${doc.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectWithdrawal('${doc.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('pendingWithdrawalsCount').textContent = pendingCount;
    $('pendingWithdrawalsAmount').textContent = formatCurrency(pendingAmount);
    $('todayWithdrawalsCount').textContent = todayCount;
}

async function approveWithdrawal(withdrawalId) {
    try {
        const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
        const withdrawal = withdrawalDoc.data();
        
        // Update withdrawal status
        await db.collection('withdrawals').doc(withdrawalId).update({
            status: 'approved',
            processedAt: firebase.firestore.FieldValue.serverTimestamp(),
            processedBy: adminData.userId
        });
        
        // Create transaction record
        await db.collection('transactions').add({
            userId: withdrawal.userId,
            type: 'withdrawal',
            amount: withdrawal.amount,
            description: 'Withdrawal Approved',
            status: 'completed',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for user
        await db.collection('notifications').add({
            type: 'withdrawal_approved',
            title: 'Withdrawal Approved',
            message: `Your withdrawal of ${formatCurrency(withdrawal.amount)} has been approved.`,
            userId: withdrawal.userId,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' Withdrawal approved successfully!');
        loadWithdrawalRequestsAdmin();
        loadAdminDashboard();
        
    } catch (error) {
        alert('Error approving withdrawal: ' + error.message);
    }
}

async function rejectWithdrawal(withdrawalId) {
    const reason = prompt('Enter rejection reason:');
    if (!reason) return;
    
    try {
        const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
        const withdrawal = withdrawalDoc.data();
        
        // Refund amount to user
        await db.collection('users').doc(withdrawal.userId).update({
            balance: firebase.firestore.FieldValue.increment(withdrawal.amount)
        });
        
        // Update withdrawal status
        await db.collection('withdrawals').doc(withdrawalId).update({
            status: 'rejected',
            rejectReason: reason,
            rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            rejectedBy: adminData.userId
        });
        
        // Create transaction record
        await db.collection('transactions').add({
            userId: withdrawal.userId,
            type: 'withdrawal_refund',
            amount: withdrawal.amount,
            description: 'Withdrawal Rejected - Amount Refunded',
            status: 'completed',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for user
        await db.collection('notifications').add({
            type: 'withdrawal_rejected',
            title: 'Withdrawal Rejected',
            message: `Your withdrawal of ${formatCurrency(withdrawal.amount)} was rejected. Reason: ${reason}`,
            userId: withdrawal.userId,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' Withdrawal rejected and amount refunded!');
        loadWithdrawalRequestsAdmin();
        
    } catch (error) {
        alert('Error rejecting withdrawal: ' + error.message);
    }
}

// ================= ADMIN KYC VERIFICATION =================
async function loadKYCRequestsAdmin() {
    const usersSnapshot = await db.collection('users')
        .where('role', '==', 'user')
        .where('kycSubmitted', '==', true)
        .where('kycStatus', '==', 'pending')
        .get();
    
    const table = $('adminKYCTable');
    if (!table) return;
    
    table.innerHTML = '';
    
    let pendingCount = 0;
    let verifiedCount = 0;
    let rejectedCount = 0;
    
    // Count all KYC statuses
    const allUsers = await db.collection('users').where('role', '==', 'user').get();
    allUsers.forEach(doc => {
        const user = doc.data();
        if (user.kycStatus === 'verified') verifiedCount++;
        else if (user.kycStatus === 'rejected') rejectedCount++;
    });
    
    pendingCount = usersSnapshot.size;
    
    if (usersSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="9" class="text-center">No pending KYC requests found</td></tr>';
    } else {
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const row = `
                <tr>
                    <td>${user.userId}</td>
                    <td>${user.name}</td>
                    <td>${user.kycAadhar ? '****' + user.kycAadhar.slice(-4) : 'Not provided'}</td>
                    <td>${user.kycPan || 'Not provided'}</td>
                    <td>${user.kycAccountNumber ? '****' + user.kycAccountNumber.slice(-4) : 'Not provided'}</td>
                    <td>${user.kycIfscCode || 'Not provided'}</td>
                    <td>${formatDate(user.kycSubmittedAt)}</td>
                    <td><span class="status-pending">Pending</span></td>
                    <td>
                        <button class="btn btn-success btn-small" onclick="approveKYC('${doc.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectKYC('${doc.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="btn btn-small" onclick="viewKYCAdmin('${doc.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
    
    // Update stats
    $('pendingKYC').textContent = pendingCount;
    $('verifiedKYC').textContent = verifiedCount;
    $('rejectedKYC').textContent = rejectedCount;
}

async function viewKYCAdmin(userId) {
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) return;
    
    const user = userDoc.data();
    
    const content = `
        <div class="form-group">
            <label>User ID</label>
            <input type="text" class="form-control" value="${user.userId}" readonly>
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" class="form-control" value="${user.kycName || user.name}" readonly>
        </div>
        <div class="form-group">
            <label>Date of Birth</label>
            <input type="text" class="form-control" value="${user.kycDob || 'Not provided'}" readonly>
        </div>
        <div class="form-group">
            <label>Aadhar Number</label>
            <input type="text" class="form-control" value="${user.kycAadhar || 'Not provided'}" readonly>
        </div>
        <div class="form-group">
            <label>PAN Number</label>
            <input type="text" class="form-control" value="${user.kycPan || 'Not provided'}" readonly>
        </div>
        <div class="form-group">
            <label>Bank Name</label>
            <input type="text" class="form-control" value="${user.kycBankName || 'Not provided'}" readonly>
        </div>
        <div class="form-group">
            <label>Account Number</label>
            <input type="text" class="form-control" value="${user.kycAccountNumber || 'Not provided'}" readonly>
        </div>
        <div class="form-group">
            <label>IFSC Code</label>
            <input type="text" class="form-control" value="${user.kycIfscCode || 'Not provided'}" readonly>
        </div>
        <div class="form-group">
            <label>Submitted Date</label>
            <input type="text" class="form-control" value="${formatDate(user.kycSubmittedAt)}" readonly>
        </div>
    `;
    
    $('kycDetailsContent').innerHTML = content;
    showModal('kycDetailsModal');
}

async function approveKYC(userId) {
    try {
        await db.collection('users').doc(userId).update({
            kycStatus: 'verified',
            kycVerifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
            kycVerifiedBy: adminData.userId
        });
        
        // Create notification for user
        const userDoc = await db.collection('users').doc(userId).get();
        const user = userDoc.data();
        
        await db.collection('notifications').add({
            type: 'kyc_approved',
            title: 'KYC Approved',
            message: 'Your KYC verification has been approved. You can now withdraw funds.',
            userId: userId,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' KYC approved successfully!');
        loadKYCRequestsAdmin();
        
    } catch (error) {
        alert('Error approving KYC: ' + error.message);
    }
}

async function rejectKYC(userId) {
    const reason = prompt('Enter rejection reason:');
    if (!reason) return;
    
    try {
        await db.collection('users').doc(userId).update({
            kycStatus: 'rejected',
            kycRejectReason: reason,
            kycRejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            kycRejectedBy: adminData.userId
        });
        
        // Create notification for user
        await db.collection('notifications').add({
            type: 'kyc_rejected',
            title: 'KYC Rejected',
            message: `Your KYC verification was rejected. Reason: ${reason}`,
            userId: userId,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(' KYC rejected!');
        loadKYCRequestsAdmin();
        
    } catch (error) {
        alert('Error rejecting KYC: ' + error.message);
    }
}

// ================= ADMIN TRANSACTIONS =================
async function loadAllTransactionsAdmin() {
    let query = db.collection('transactions').orderBy('timestamp', 'desc').limit(100);
    
    const fromDate = $('transactionFromDate').value;
    const toDate = $('transactionToDate').value;
    const type = $('transactionType').value;
    
    if (fromDate) {
        const startDate = new Date(fromDate);
        startDate.setHours(0, 0, 0, 0);
        query = query.where('timestamp', '>=', startDate);
    }
    
    if (toDate) {
        const endDate = new Date(toDate);
        endDate.setHours(23, 59, 59, 999);
        query = query.where('timestamp', '<=', endDate);
    }
    
    if (type) {
        query = query.where('type', '==', type);
    }
    
    const transactionsSnapshot = await query.get();
    const table = $('adminTransactionsTable');
    
    if (!table) return;
    
    table.innerHTML = '';
    
    if (transactionsSnapshot.empty) {
        table.innerHTML = '<tr><td colspan="7" class="text-center">No transactions found</td></tr>';
    } else {
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            const statusClass = transaction.status === 'completed' ? 'status-active' :
                              transaction.status === 'pending' ? 'status-pending' : 'status-rejected';
            
            const row = `
                <tr>
                    <td>${doc.id.slice(-8).toUpperCase()}</td>
                    <td>${getUserCode(transaction.userId)}</td>
                    <td>${transaction.type.replace('_', ' ').toUpperCase()}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td>${transaction.description}</td>
                    <td>${formatDateTime(transaction.timestamp)}</td>
                    <td><span class="${statusClass}">${transaction.status}</span></td>
                </tr>
            `;
            table.innerHTML += row;
        });
    }
}

function filterTransactions() {
    loadAllTransactionsAdmin();
}

async function approveTransaction(transactionId) {
    // This is a generic function for approving any pending transaction
    try {
        await db.collection('transactions').doc(transactionId).update({
            status: 'completed'
        });
        
        alert(' Transaction approved!');
        loadRecentActivityAdmin();
    } catch (error) {
        alert('Error approving transaction: ' + error.message);
    }
}

async function rejectTransaction(transactionId) {
    const reason = prompt('Enter rejection reason:');
    if (!reason) return;
    
    try {
        await db.collection('transactions').doc(transactionId).update({
            status: 'rejected',
            rejectReason: reason
        });
        
        alert(' Transaction rejected!');
        loadRecentActivityAdmin();
    } catch (error) {
        alert('Error rejecting transaction: ' + error.message);
    }
}

// ================= ADMIN SETTINGS =================
async function loadAdminSettings() {
    try {
        const settingsDoc = await db.collection('settings').doc('platform').get();
        
        if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            
            $('minDeposit').value = settings.minDeposit || 100;
            $('minWithdrawal').value = settings.minWithdrawal || 200;
            $('withdrawalFee').value = settings.withdrawalFee || 5;
            $('referralCommission').value = settings.referralCommission || 10;
            $('dailyTaskIncome').value = settings.dailyTaskIncome || 5;
            $('packageValidity').value = settings.packageValidity || 30;
            $('adminUpiId').value = settings.adminUpiId || 'capitalrise@ybl';
            $('qrCodeUrl').value = settings.qrCodeUrl || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl';
            $('bankDetailsText').value = settings.bankDetails || 'State Bank of India\nAccount: 123456789012\nIFSC: SBIN0001234\nName: CapitalRise Trading';
            
            // Update QR code display
            updateQRCodeDisplay();
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

async function saveAdminSettings() {
    try {
        const settings = {
            minDeposit: parseFloat($('minDeposit').value) || 100,
            minWithdrawal: parseFloat($('minWithdrawal').value) || 200,
            withdrawalFee: parseFloat($('withdrawalFee').value) || 5,
            referralCommission: parseFloat($('referralCommission').value) || 10,
            dailyTaskIncome: parseFloat($('dailyTaskIncome').value) || 5,
            packageValidity: parseInt($('packageValidity').value) || 30,
            adminUpiId: $('adminUpiId').value.trim() || 'capitalrise@ybl',
            qrCodeUrl: $('qrCodeUrl').value.trim() || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=capitalrise@ybl',
            bankDetails: $('bankDetailsText').value.trim(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: adminData.userId
        };
        
        await db.collection('settings').doc('platform').set(settings, { merge: true });
        
        // Update packages validity
        await updatePackagesValidity(settings.packageValidity);
        
        alert(' Settings saved successfully!');
        
    } catch (error) {
        alert('Error saving settings: ' + error.message);
    }
}

async function updatePackagesValidity(validity) {
    // Update all packages configuration
    packages.forEach(pkg => {
        pkg.validity = validity;
    });
    
    await db.collection('packages_config').doc('default').update({
        packages: packages
    });
}

function updateQRCodeDisplay() {
    const qrCodeUrl = $('qrCodeUrl').value;
    if (qrCodeUrl) {
        $('qrCodeImage').src = qrCodeUrl;
    }
}

function updateQRCode() {
    const upiId = $('adminUpiId').value.trim();
    if (!upiId) {
        alert('Please enter UPI ID first');
        return;
    }
    
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiId)}&format=png`;
    $('qrCodeUrl').value = qrCodeUrl;
    updateQRCodeDisplay();
    alert('QR Code updated!');
}

// ================= MODAL MANAGEMENT =================
function showModal(modalId) {
    $(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    $(modalId).style.display = 'none';
}

// ================= WITHDRAWAL METHOD TOGGLE =================
$('withdrawMethod').addEventListener('change', function() {
    const method = this.value;
    $('bankDetailsSection').style.display = method === 'bank' ? 'block' : 'none';
    $('upiDetailsSection').style.display = method === 'upi' ? 'block' : 'none';
});

// ================= PACKAGE EXPIRY CHECK =================
async function checkPackageExpiry() {
    if (!currentUser) return;
    
    const now = new Date();
    const packagesSnapshot = await db.collection('packages')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get();
    
    packagesSnapshot.forEach(async (doc) => {
        const pkg = doc.data();
        if (pkg.expiryDate && pkg.expiryDate.toDate() < now) {
            // Mark package as expired
            await db.collection('packages').doc(doc.id).update({
                status: 'expired'
            });
            
            // Create notification for user
            await db.collection('notifications').add({
                type: 'package_expired',
                title: 'Package Expired',
                message: `Your ${pkg.name} package has expired after 30 days.`,
                userId: currentUser.uid,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    });
}

// ================= INITIALIZATION =================
window.addEventListener('DOMContentLoaded', function() {
    // Set today's date as max for date inputs
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.max = today;
        if (input.id === 'transactionFromDate' || input.id === 'transactionToDate') {
            input.value = today;
        }
    });
    
    // Check for referral in URL
    const urlParams = new URLSearchParams(window.location.search);
    const referralId = urlParams.get('ref');
    if (referralId) {
        localStorage.setItem('referralId', referralId);
        $('regSponsorID').value = referralId;
    }
    
    // Initialize withdrawal method toggle
    if ($('withdrawMethod')) {
        $('withdrawMethod').dispatchEvent(new Event('change'));
    }
    
    // Update QR code display
    updateQRCodeDisplay();
    
    // Check package expiry periodically (every hour)
    setInterval(checkPackageExpiry, 3600000);
    
    // Auto-expire packages check on load
    checkPackageExpiry();
    
    console.log('CapitalRise Trading Platform v3.0 PRO - Initialized');
});
</script>
</body>
</html>
